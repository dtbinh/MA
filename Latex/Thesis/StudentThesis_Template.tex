\documentclass[a4paper,twoside, openright,12pt]{report}
\usepackage{psfrag,pstricks,amsbsy,graphics,float,amsmath,amssymb,epstopdf}
\usepackage{graphicx, color, mathtools,amsfonts,tikz,pgfplots,lscape,verbatim} %deleted [dvips] in front of {graphicx, color} for usage with PDFLaTeX
\usepackage[latin1]{inputenc}
\usepackage{verbatim}
\pgfplotsset{compat=1.9}
\usepgfplotslibrary{groupplots}
\usetikzlibrary{matrix} 
%\usepackage{epsfig}
% \usepackage{pst-grad} % For gradients
% \usepackage{pst-plot} % For axes

%%% Stand 14.09.2007
%%% erstellt von Marion Sobotka
%%% marion.sobotka@tum.de
%%% last changes: 14.01.09


%_______Kopf- und Fußzeile_______________________________________________________
\usepackage{fancyhdr}
\pagestyle{fancy}
%um Kopf- und Fußzeile bei chapter-Seiten zu reaktivieren
\newcommand{\helv}{%
   \fontfamily{phv}\fontseries{a}\fontsize{9}{11}\selectfont}
\newcommand{\f}[1]{\boldsymbol{#1}}
\fancypagestyle{plain}{	
	\fancyfoot{}% keine Fußzeile
	\fancyhead[RE]{\helv\leftmark}% Rechts auf geraden Seiten=innen; in \leftmark stehen \chapters
	\fancyhead[LO]{\helv\rightmark}% Links auf ungeraden Seiten=außen;in \rightmark stehen \sections
	\fancyhead[RO,LE]{\thepage}}%Rechts auf ungeraden und links auf geraden Seiten
%Kopf- und Fußzeile für alle anderen Seiten
\fancyfoot{}
\fancyhead[RE]{\helv\leftmark}
\fancyhead[LO]{\helv\rightmark}%alt:\fancyhead[LO]{\itshape\rightmark}
\fancyhead[RO,LE]{\thepage}
%________________________________________________________________________________


%_Definieren der Ränder und Längen__________
\setlength{\textwidth}{15cm}
\setlength{\textheight}{22cm}
\setlength{\evensidemargin}{-2mm}
\setlength{\oddsidemargin}{11mm}
\setlength{\headwidth}{15cm}
\setlength{\topmargin}{10mm}
\setlength{\parindent}{0pt} % Kein Einrücken beim Absatz!!
%___________________________________________

%_Hyperref for CC Url__________
\usepackage{hyperref}
%___________________________________________

%_______Titelseite__________________________________________
\begin{document}
\pagestyle{empty}
\enlargethispage{4.5cm} %Damit das Titelbild weit genug unten ist!
\begin{center}
\phantom{u}
\vspace{0.5cm}
\Huge{\sc Control of a multi-robot cooperative team guided by a human-operator}\\
\vspace{1.5cm}
                                 \large{eingereichte\\
			  %DIPLOMARBEIT\\%/STUDIENARBEIT/MASTERRBEIT/BACHELORARBEIT\\ 
                                           %von\\
                                 \large{	MASTERARBEIT\\ 
										   von\\}          

						\vspace{0.4cm}
					cand. ing. Martin Angerer\\
						\vspace{0.5cm}
					geb. am 10.06.1991\\
					wohnhaft in:\\
					Steinheilstrasse 5\\
					80333 M\"unchen\\
					Tel.: 0151\,57978548\\
					\vspace{1.5cm}
					Lehrstuhl f\"ur\\
					INFORMATIONSTECHNISCHE REGELUNG \\
					Technische Universit\"at M\"unchen\\
					\vspace{0.6cm}
                    Univ.-Prof. Dr.-Ing. Sandra Hirche}
\end{center}
\vspace{5.0cm}
\begin{tabular}{ll}
Betreuer: Selma Musi\'c, M.Sc.  \\
Beginn: & 01.10.2015  \\
Zwischenbericht: &  21.01.2016  \\
Abgabe: &  01.04.2016 \\
\end{tabular}
%____________________________________________________________

\newpage
\cleardoublepage



\phantom{u}
\phantom{1}\vspace{6cm}
\begin{center}
In your final hardback copy, replace this page with the signed exercise sheet.
\end{center}

\newpage


%_______Abstract_____________________________________________
\topmargin5mm
\textheight220mm
\pagenumbering{arabic}
\phantom{u}
\begin{abstract}
Cooperative manipulation with human guidance can be used to solve versatile tasks. A new approach to system modelling and control in cooperative manipulation is the use of port-Hamiltonian systems. Starting from modelling of a cooperative manipulation set-up a model-based controller in the framework of Intrinsically Passive Control is derived. In contrast to the quasi-static implementations for robot hands, the controller has fully dynamic impedance relations. The good dynamic performance of the proposed control scheme is shown by simulation and compared to simulations of state-of-the-art controllers in cooperative manipulation.  
\begin{center}	
\normalsize \textbf{Zusammenfassung}\\
\end{center}
Hier die deutschsprachige Zusammenfassung
\end{abstract}
%____________________________________________________________

\newpage

%_______Widmung_______________________________________________
\phantom{u}
\phantom{1}\vspace{6cm}
\begin{center}
%Hier die Widmung oder leer lassen
\end{center}
%_____________________________________________________________



\pagestyle{fancy}

%_________Inhaltsverzeichnis__________________________
\tableofcontents 
%_____________________________________________________


%\chapter{Working with this Template}
%
%Make sure your thesis is well structured, that each major section does what it is supposed to do, and that the whole thing hangs together. The basic structure is often as given in this template (but other structures are possible). In particular, don't think you need to have exactly as many major sections or chapters as the list implies; sometimes it makes sense to merge things, sometimes it makes sense to move things (e.g., the literature review is in many papers deferred until after the results), sometimes it makes sense to split a logical part into several individual sections. Just use some common sense.
%
%Hand in your thesis at minimum \textbf{one week} before the deadline for correction. You will receive feedback for the final version and very likely have to do minor or major revisions of your writing. Plan your writing schedule to allow for these adjustments, which can have quite some impact on your grade! 
%
%\section{Style and Expressions}
%
%Before handing in your thesis, even for an intermediate review, please perform a spellcheck and correct grammar mistakes. The report is not meant to be a narrative text. Please stick to neutral and technical style and avoid subjective or biased expressions or adjectives/adverbs such as \emph{obviously, always, very, especially well, actually, so-called etc}. Scientific writing is about precision and you should underpin your statements factually, not soften them with unnecessary qualifiers.
%
%\subsection{Subsection}
%
%Use chapters, sections and subsections to structure your document
%
%\subsubsection{Subsubsection}
%
%Subsubsections can be used to further structure information within a subsection. They don't show up in your list of contents.
%
%\paragraph{Paragraphs} are sometimes more useful than subsubsections to structure text without breaking the flow.
%
%\section{Compiling}
%Linux: 
%do the following in a Shell:\\
%\begin{verbatim}
%latex myfile
%dvips myfile
%ps2pdf -sPAPERSIZE=a4 myfile.ps
%\end{verbatim}
%Make sure to use the A4 option, when you print the pdf!
%
%\section{Equations}
%Equations are written like that $x^2$. Or like that:
%\begin{equation}
%x^2
%\label{EQ:gleichung1}
%\end{equation}
%You can use (\ref{EQ:gleichung1}) to reference an equation in the
%text. Equations without reference number:
%\[
%x^2
%\]
%
%Please type all numbers in mathematics mode.
%Mathematical equations which are not part of the text should be centred.
%A parameter or variable must not be used at the beginning of a sentence.
%Type physical units as normal text, e.g. s, not $s$!
%Formulas must not jut out over the text margin, so take care to stay within the margins and eventually break the equation into several lines.
%Explain the variables you use. For each newly introduced variable, at least a short description of it should follow the equation in the style of \emph{\ldots with $x$ being the position of the cart and $u$ the control input.}
%In columns, align equations with the arithmetic operator \verb|(=,<, ...)|.
%Mathematical units must be consistently labeled with only one variable. Do not
%use a variable for more than one mathematical unit.
%
%\section{Figures}
%
%For pictures, it is convenient, if they are .eps.
%\begin{figure}[htb]
%\centering
%%\includegraphics[width=0.6\textwidth]{abbildung.eps}
%\caption[Abbreviated Description]{Long Description: The subtitles of tables and illustrations should be self-explanatory.}
%\label{FIG:abb1}
%\end{figure}
%
%Every illustration must be described and referenced in the text, cf. Fig. \ref{FIG:abb0}. 
%There is no such thing as a decorative figure! 
%If the figure is not mentioned in the text and therefore lacks an explanatory function, leave it.
%Lines in plots need to be clearly distinguishable, also in black-and-white print. 
%The subtitles and axis labels must be clearly legible (i.e. big enough) and include a scaling.
%If the illustration is copied from another person's work, you need to mention the
%source with \verb|\cite{}|.
%
%\section{Citations}
%
%For bibliography, edit {\tt mybib.bib} and list all
%references in a special style, e.g. for a book: 
%\begin{verbatim}
%@book{literaturselle1,
% author    = {S. Sastry},
% title     = {Nonlinear Systems - Analysis, Stability, and Control},
% publisher = {Springer},
% year      = 1999
%}
%\end{verbatim}
%
%Cite references in the text by.
%
%In order to have your references shown in your PDF, compile by:
%
%\begin{verbatim} 
%latex myfile
%bibtex myfile
%latex myfile
%latex  myfile
%dvips myfile
%ps2pdf -sPAPERSIZE=a4 myfile.ps
%\end{verbatim}
%
%Whether to use numeric or alphabetic references isn't all that important (unless prescribed by a conference or journal), but alphabetic tends to be more readable. Independent of citation style, the following rules should be followed:
%
%\begin{itemize}
%\item Use the \LaTeX~cite package. It doesn't give you additional commands, but it fixes a few quirks in \LaTeX. Among others it automatically sorts multiple citations, and it correctly spaces the angular brackets (if you use the \verb|\cite| command without leading white space).
%
%\item Citing several papers at one point should be done with a single \verb|\cite| command. For example, use \verb|gives good results\cite{Bloe_99, Jay_87}|, resulting in gives good results \cite{Bloe_99, Jay_87}. 
%
%Do not use \verb|gives good results\cite{Bloe_99}\cite{Jay_87}| which produces the ugly gives good results \cite{Bloe_99}\cite{Jay_87}. Also, note that there is no space between the \verb|\cite| command and the preceding word, \LaTeX~(with the cite package) does the spacing correctly.
%
%
%\item Avoid citations of the kind: \cite{Bloe_99} thinks that $x>y$ is valid, but \cite{ONeill_2000} argues that this is invalid in case of $z\geq5$. This works a bit better if using alphanumeric citation labels. Better, though, use the author's names: Bloe and Joe [1] think that $x>y$ is valid, but O'Neill et al. \cite{ONeill_2000} argues that this is invalid in case of $z\geq5$. 
%
%
%\item BibTeX is a great tool, but you need to know how to use it. A regular trap is to forget that \TeX~knows more about typesetting than you do. So, for example, it changes the case of words in the title. If your title contains acronyms and proper names (most do), they tend to get down-cased. Any such words which should not have their case changed should be put into braces, e.g., \verb|{The {Mungi} {OS} and its Use in Merry-Go-Round Seat Allocation}|.
%
%
%\item In citations don't abuse the category technical report. People tend to cite just about anything that hasn't been published in a journal or conferences as a TR. This is outright wrong. The concept of a TR is actually fairly well defined: A TR is published in some sort. This is generally as part of a formal TR series of some institution, in hardcopy or on the web or both. (They aren't always called "technical report", other common names are "research report", "technical memorandum", $<$institution$>$ "report" etc.) The publication (i.e. availability outside) is essential, otherwise it's at best an internal report.
%A TR has a number (absolutely!), an institution (publisher), a date (month and year at least) and a publisher's address (besides all the other stuff bibentries have).
%If your document doesn't have these features, it's not a TR. It's probably better categorized as a working paper. Even then it has a date and an institution address.
%
%\item Citing web pages is often unavoidable (but also often a sign of laziness). When citing web pages be aware that they may only be short-lived. Consider whether the reference will be of any use to the reader at all if the link is broken. Or whether your whole document only has a use-by date a few months past writing.
%
%\end{itemize}
%
%Any cited document, whatever it may be, has a few \textbf{mandatory} features:
%\begin{itemize}
%	\item Date. Absolutely. 
%	\item Author/organization/creator/person responsible for contents.
%	\item Whatever information the reader needs to find that document. In most BibTeX entry types these are clearly identified as mandatory fields. Mandatory means that they aren't optional. Don't pretend they are. For a working paper these might be the contact details of the author.
%\end{itemize}





%_________Einleitung__________________________________
\chapter{Introduction}

%\textit{Your first chapter in the document.
%Introduce the problem (gently!). Try to give the reader an appreciation of the difficulty, and an idea of how you will go about it. It's like the overture of an opera: it plays on all the relevant themes.}
%
%\textit{Make sure you clearly state the vision/aims of your work, what problem you are trying to solve, and why it is important. While the introduction is the part that is read first (ignoring title and abstract) it is usually best written last (when you actually know what you have really achieved). Remember, it's the first thing that is being read, and will have a major influence on the how the reader approaches your work. If you bore them now, you've most likely lost them already. If you make outrageous claims pretend to solve the world's problems, etc, you're likely fighting an uphill battle later on. Also, make sure you pick up any threads spun in the introduction later on, to ensure that the reader thinks they get what they have been promised. Don't create an expectation that you'll deliver more than you actually do. Remember, the reader may be your marker (of a thesis) or referee (of a paper), and you don't want to annoy them.} \\
%\\
Interaction between humans and robots expands the range and complexity of admissible tasks in a natural way: Humans come with superior foresight and planning capabilities, while being inherently robust and adaptive in unexpected situations. On the other hand robots perform tasks repetitively and with high precision. In addition robots can operate in areas humans cannot (space, hazardous environments). Multiple robots working together in cooperative team are capable of carrying out more complex tasks with less specialized tools. The prime example is grasping and transportation of large and/or heavy objects. Other options are the coordinated use of tools and the assembly of multiple parts without using special fixtures.\\
Dependant on the role of the human in the control loop and the autonomy of the robotic team, we differentiate three classes of architectures: direct, shared and supervisory control \cite{Hirche_12}. In direct control approaches humans operate each robot separately by manipulating a haptic device that provides also reactive forces. Closed loop stability can be concluded with dynamic models of the human \cite{Hogan_89}. On the other hand, applying supervisory control, the robotic teams operates autonomously and the operator issues high-level commands like "relocate to a certain place" or "grasp an object". The operator gives feedback rather than controls the system. Closed loop stability is concluded on the autonomous level, but can be extended with behavioural models of the human \cite{Peters_15}.
The intermediate between autonomous and directly controlled systems are shared control approaches. The prime example in multi-robot shared control is the leader-follower paradigm. The (single) human leader is not physically coupled to the robotic team, but explicitly controls the (multiple) robots. S/he gives a general direction of motion (high-level task) while the robots autonomously preserve a certain formation (low-level task). In contrast to supervisory control the human is directly included in the control loop and her/his dynamic behaviour affects the overall stability. Unlike the direct control approaches we do not assume a reactive interface to the human, i.e. the human commands are not restricted by a counteracting force generated by the input device. Input methods like motion capturing \cite{Sieber_15}, hand gestures \cite{Gioioso_2014} or video game controllers (see figure \ref{FIG:MEISTeR}b) allow the user to issue arbitrary trajectories. Thus it is indispensable to consider commands that may destabilize the system and/or endanger the environment, especially humans on-site.\\
A recent example for cooperative manipulation, in particular coordinated use of tools, is a tele-operated robot (fig. \ref{FIG:MEISTeR}a) to operate inside the Fukushima Daiichi Nuclear Power Station. The operator receives visual (fig. \ref{FIG:MEISTeR}c) but no reactive force-feedback.\\
\begin{figure}
	\centering
	\includegraphics[width=0.8\textwidth]{mhi-meister.jpg}
	\caption[Demonstration of MHI MEISTeR at Fukushima Daiichi NPS]{Demonstration of the tele-operated MHI MEISTeR robot at Fukushima Daiichi Nuclear Power Station \cite{MHI-MEISTeR}}
	\label{FIG:MEISTeR}
	\vspace{-10pt}
\end{figure} 
Seen from a control point of view the human decision making is a "black box", the inputs and outputs are available but the internal behaviour is unknown. Psychological models based on empiric studies and neural network based structures \cite{Peters_15} resemble human behaviour. But there is no way to guarantee that they are always right for every human and they are not suitable to be the base of a stability proof of the closed loop behaviour.  It is the objective of this thesis to design a controller for cooperative object manipulation without assuming any model of human behaviour. On the contrary, the deterministic part of the plant, i.e. the robotic system, is simulated in the controller in order to adapt the human commands if necessary to achieve a safe and stable closed loop behaviour.\\

Passivity is a key concept when dealing with uncertainty, the property that a system either stores or dissipates supplied energy leads to asymptotic stability \cite{Stramigioli_15}. The interconnection of a passive system with an unknown system is stable as long as the unknown system can only provide a finite amount of energy. Towards a conclusion on closed loop we need to ensure that the operator cannot provide infinite energy by issuing commands. Pursuing this thread by limiting the energy stored in the robotic system, the possible impact on the environment is reduced and this effectively contributes to safety.
This energy shaping approach motivates controller design on an energetic level.  








%The major challenge in cooperative manipulation is to simultaneously control the forces between the manipulators and the object, so to say the internal stress exerted on the object, and the forces between the object and the environment, i.e. the absolute motion of the object.
%Strategies that map force and velocity of the object to the manipulators have to be considered.\\
%One important assumption is the nature of the connection between manipulator and object. It can be seen as rigid or more general as friction-based. With a rigid fixture the grasp is always stable, on the contrary friction grasps need to be actively stabilized. To comply with the friction constraints a contact normal force has to be set, dependent on the tangential components present during manipulation.\\
%Towards a versatile usage of cooperative manipulation it is vital to let the human operator control the robotic system intuitively and naturally. 
%A promising approach is gesture control. Gioioso et al. \cite{Gioioso_2014} demonstrated this for a formation of unmanned aerial vehicles. They are able to control opening and closing of the grasp. In a grasped state the objects's pose and the grasping forces can be changed, just by tracking gesture of a single human hand. 
%Directly integrating the human into the control scheme makes use of the visual tracking capacities of the human and eases operation in unknown environments. Regardless of the operator being present on-site with the robots or not, hand tracking and analysis requires a certain time. This delay in the control loop can cause instability. The problem can be modelled as a transmission line with delay and treated with methods known from tele-operation.
%The human takes the role of a supervisor, representing a high-level part of the control scheme. He is responsible for planning, choosing a trajectory and if necessary setting of grasping forces.
%On a local low-level robots need to coordinate their motion compliant with the commanded trajectory and adjust their formation to realize the desired internal forces. For non-rigid fixtures the local robot controller requires the position of the other manipulators. The local communication between the robots causes delay, which has to be treated with tele-operation techniques in order to ensure stability.\\
%Haptic feedback??

 

\section{Problem Statement}

%\textit{You can either state the problem you are trying to solve in the general introduction, providing the transition from the overall picture to your specific approach, or state it in a separate section. Even if you don't use the separate section, writing down in a few sentences why the problem you are trying to solve is actually hard and hasn't been solved before can give you a better idea of how to approach the topic. This can be also merged with the related work part.}\\

Manipulating an unknown object in an unstructured environment is an interesting task for a human-guided cooperative manipulation set-up. Dropping the assumption of a rigid- connection between manipulator and object, the grasp has to be actively stabilized under varying circumstances. During dynamic manipulation a slipping of contact due to the inertia of the object has to be avoided using an automatic mechanism. On the other hand the operator must directly adjust grasp forces for heavy or fragile objects.\\
Position and velocity of the manipulated object are difficult to track in an everyday setting. Usually only end-effector position and velocity of the robots are available. Object position has to be estimated from the known data.\\
For grasping an  object of unknown or even flexible shape, the determination of a fixed grasp map in advance is not useful. Size and shape of the grasp have to be determined by the operator during the grasp process. The controller has to be flexible to varying grasp geometries during the whole task execution.\\
Integrating the human into the control loop, energetic passivity of the closed loop system is a meaningful and intuitive way to ensure stability and a natural way of interaction. Energetic passivity limits the extractable mechanical energy from the closed loop system. This means that the potential damage is also limited. 
Energetic passivity of the robotic system ensures stability of the interconnection stability with any passive systems. Since humans and many relevant environments are passive the closed loop system will always be stable if the overall control scheme is designed energetically passive.


\section{Related Work}
A notable class of control architectures for cooperative manipulation is hybrid position/force control, with a motion control loop for trajectory tracking and a force control loop for internal forces \cite{Wen_92,Hsu_93}. Their drawback is the inability to handle non-contact to contact transitions. Hogan introduced impedance control, which enforces a relation between force and motion \cite{Hogan_84}. Its first application in cooperative manipulation was in \cite{Schneider_92} for realizing compliant object-environment interaction (external impedance control). Bonitz and Hsia \cite{Bonitz_96} applied the concept to the manipulator-object relation (internal impedance control).\\
More recent impedance control schemes can be classified in terms of the information and sensor data available for the problem. Frugal architectures are formation control \cite{Sieber_15} and the static IPC \cite{Wimboeck_06}. Both do not incorporate the object dynamics in control, thus very little knowledge about the object (e.g. dimensions) is necessary. The control loops depend only on relative positions and velocities of the manipulators and do not require object tracking. Neglecting considerable object dynamics is an obvious drawback of the schemes.\\
The concept of the \emph{Intrinsically Passive Controller} (IPC), introduced by Stramigioli \cite{Stramigioli_01} and called dynamic IPC by Wimb\"ock et al. \cite{Wimboeck_08}, tries to overcome some of the limitations. In the controller the object is represented by a virtual pendent and simulated to reproduce its dynamics for control purpose. This has the advantage that still no tracking of the object is required, object velocity and even acceleration can be obtained from the simulation. \\
Techniques which rely on exact knowledge of the object motion were introduced by Caccavale et al. \cite{Caccavale_01,Caccavale_08} and more recent \cite{Heck_13} and \cite{DePascali_15}. It is common to them that they assume rigid fixtures to a rigid object, these conditions overcome the problem of object tracking. The approaches by Caccavale and co-workers use force/torque sensors at the manipulators to establish compliant object environment interaction, for this purpose Heck et al. \cite{Heck_13} assume to have an exact model of the environment. Stramigioli's IPC implements a compliant relation between virtual object and environment. \\
The human operator must be able control the manipulators at a reasonable degree of complexity, therefore in an direct master-slave approach each robot is controlled independently by a human operator. Exactly coordinating their motions is a difficult task for humans, as a consequence a certain amount of autonomy is left to the robot system, enabling a single operator to control the cooperative system. Lee and Spong \cite{Lee_05} apply the master-slave scheme but treat the constrained system as a single slave, while the formation is preserved by the robots autonomously. Many master-slave systems give the operator force-feedback, while s/he commands the motion. This helps the operator compensate for resistances and gives a natural feeling of the interaction with the environment. The structure then is fully bi-directional, ones refers to bilateral telemanipulation \cite{TeleoperationHandbook}. Leader-follower \cite{Sieber_15,Scheggi_14} schemes differ in terms of feedback provided to the operator. Tactile and visual types are non-reactive, i.e. they do not induce operator movements reacting to a back-driving force \cite{Massimino_93}. A purely vision-based architecture is introduced by Gioioso et al. \cite{Gioioso_2014}, hand gestures are used to both control the motion of the constrained system and the opening and closing of a grasp. Control architectures that leave even further autonomy to the robot system and possess a closed local, autonomous control loop, are categorized as supervisory control. They interacts with the operator by continuously sending information about the state and periodically receiving commands \cite{Sheridian_92}.\\
The assumption of rigid fixtures between manipulators and object is very common in cooperative manipulation, Lee and Spong \cite{Lee_05} are an exception. Friction grasps are mainly researched in robot hand literature (\cite{Wimboeck_06,Wimboeck_08,Stramigioli_01}). For the stabilization of a friction grasp it is vital to choose appropriate forces depending on the dynamic state. Therefore the Coulomb friction constraints along with other criteria (safety margins, force limits) can be formulated as a cost function for optimization. Buss et al. \cite{Buss_96} realized that the Coulomb friction constraints can be formulated as positive definite matrices, Han et al. \cite{Han_2000} gave a linear matrix inequality problem. For this type of optimization problems very efficient, real-time solvers exist.
\\


%Control strategies suitable for Cooperative Manipulation can be classified dependent on the nature of the manipulator-object connection: rigid-fixture and friction-grasps.
%An import group within the former are the hybrid position/force control approaches. 
%Control action is decomposed in a motion control loop, accounting for the tracking if the desired trajectory for the overall system and a force control loop to control the internal forces on the object. A pre-defined selection matrix determines for every workspace coordinate whether it is position or force controlled. Controlling the robot on joint level, the necessary torques can be computed using a PD plus gravity compensation control scheme. The desired joint positions and velocities are computed by inverse kinematics \cite{Wen_92}.
%Object level control architectures often use feedback linearisation of the non-linear manipulator dynamics to achieve a linear and decoupled control of motion and grasping force \cite{Hsu_93}.
%Force control is only meaningful if contact between manipulator and object. Motion control leads to unbounded forces if the motion direction is not consistent with the constraints,  since force in this direction is not controlled. The transition between contact and no contact during grasping cannot be handled with these approaches. For these reasons in the following only the better suited impedance control schemes are considered. Impedance control, introduced by Hogan \cite{Hogan_84}, is a well known strategy to avoid unbounded forces when it comes to interaction of manipulators with objects/environment. It does not control one state variable (position, velocity, force) dynamically enforces a relation between forces and system state. Contact directions do not have to be pre-specified. The controller is stable independently of the contact state.
%A physical analogy the impedance control scheme is a spring-mass-damper system.\\  

%\textit{From Kevin Elphinstone's \emph{A Small Guide to Writing Your Thesis}\cite{Elphinstone2014}:}
%
%\textit{"The related work section (sometimes called literature review) is just that, a review of work related to the problem you are attempting to solve. It should identify and evaluate past approaches to the problem. It should also identify similar solutions to yours that have been applied to other problems not necessarily directly related to the one your solving. Reviewing the successes or limitations of your proposed solution in other contexts provides important understanding that should result in avoiding past mistakes, taking advantage of previous successes, and most importantly, potentially improving your solution or the technique in general when applied in your context and others.}

%\textit{In addition to the obvious purpose indicated, the related work section also can serve to:}

%\begin{itemize}
%	\item \textit{justify that the problem exists by example and} argument
%	\item \textit{motivate interest in your work by demonstrating relevance and importance}
%	\item \textit{identify the important issues}
%	\item \textit{provide background to your solution}
%\end{itemize}

%\textit{Any remaining doubts over the existence, justification, motivation, or relevance of your thesis topic or problem at the end of the introduction should be gone by the end of related work section.}

%\textit{Note that a literature review is just that, a review. It is not a list of papers and a description of their contents! A literature review should critique, categorize, evaluate, and summarize work related to your thesis. Related work is also not a brain dump of everything you know in the field. You are not writing a textbook; only include information directly related to your topic, problem, or solution."}

%\textit{Note: Do the literature review at an early stage of your project to build on the knowledge of others, not reinvent the wheel over and over again! There is nothing more frustrating after weeks or months of hard work to find that your great solution has been published 5 years ago and is considered old news or that there is a method known that produces superior results.}

%\subsection{Control schemes for rigidly connected manipulators}\label{SS:rigidcontrolschemes}
%A rigid fixture between manipulator and object means that both forces and moments are exchanged at the grasp points: all translational and rotational motion components can be transmitted through the contact points. The rigid connections are expressed by a number of kinematic constraints, which reduce the Degrees-of-Freedom (DoF) of the constrained system. The attempt to move in the constrained directions results in internal loading of the object. Therefore trajectories of the manipulators have to be generated to avoid internal stress on the object. Assuming a rigid connection normally no grasping force is needed to stabilize the grasp, i.e. internal forces are undesired because possibly harmful to the object. Nevertheless some papers propose possibilities to specify or control internal forces.\\
%Among the first to use impedance control in cooperative manipulation were Schneider and Cannon \cite{Schneider_92}. They replaced the actual object by a virtual mass and connected it to the environment with a spring and a parallel damper. The resulting impedance equation is:
%\begin{equation}
%M_{o,d} (\ddot{x}_o^d - \ddot{x}_o) + D_o (\dot{x}_o^d - \dot{x}_o) + K_o(x_o^d,x_o) = h_{env} 
%\end{equation}
%Here $ M_{o,d} $ denotes the inertia of the virtual object, $ D_o $ is the damping along the spring, which is represented by $ K_o(x_d,x) $. $ x_o = (p_o^T,Q_o^T)^T $ is the stacked vector of position and orientation of the object. $ x^d $ denotes a desired quantity. The external wrench, exerted by the environment on the object, $ h_{env} = (f_{env}^T,t_{env}^T)^T$ consists of force and torque vectors.
%The dynamics of the virtual object is then given as:
%\begin{equation}
%M_{o,d}\ddot{x} = -h_{env} + h_o^{\Sigma} = -h_{env} + M_{o,d}\ddot{x}_d + D_o (\dot{x}_d - \dot{x}) + K_o(x_d,x)
%\end{equation}
%The resulting impedance control output $ h_o^{\Sigma} $ is than mapped to the manipulators using a generalized inverse of the grasp matrix:
%\begin{equation}
%h^{\Sigma} = G^\dagger h_o^{\Sigma}
%\end{equation}
%Performance of this strategy depends on choosing the virtual inertia close to the actual, i.e. good knowledge of the object is required. Furthermore gravity compensation would be necessary to model the full object dynamics. In general the equation of motion for a rigid object is:
%\begin{equation}\label{EQ:ObjectDynamics}
%M_o \ddot{x}_o + C_o \dot{x}_o + g_o = h_{env} + h^\Sigma
%\end{equation}
%Wherein $ M_o $ is the actual object inertia, $ C_o $ is the Matrix accounting for the Coriolis force and $ g_o $ is the gravity. 
%For notational convenience the pose dependencies of the parameter matrices, e.g. $ M_o(x_o) $, are omitted.\\
%Bonitz and Hsia \cite{Bonitz_96} propose to model each manipulator as an impedance relation. Thereby a relation between manipulator dynamics and internal forces on the object is enforced:
%\begin{equation}
%M_i(\ddot{x}_i^d - \ddot{x}_i) + D_i (\dot{x}_i^d - \dot{x}_i) + K_i(x_i^d,x_i) = h_{int}
%\end{equation}
%$ M_i, D_i, K_i(x_i^d,x_i) $ are the desired inertia, damping and stiffness representations of the i-th manipulator.The internal wrench $ h_{int} = VV^\dagger h $ is calculated from the measured contact wrench $ h $. $ V $ is a basis of the nullspace of the grasp matrix, $ V^\dagger $ denotes the pseudoinverse. No assumptions on the object are necessary because it is not considered in the control scheme.\\ 
%The first approach ensures compliant object-environment interaction, while the second limits internal forces even in case of end-effector displacements. The both have been combined by Caccavale and Villani \cite{Caccavale_01}. Their control architecture is cascaded, consisting of a two level reference trajectory generation and a motion control loop below. On top-level an impedance relation between object and environment is used to generate a compliant trajectory subject to environmental forces:
%\begin{equation}
%\alpha M_o(\ddot{x}_o^d - \ddot{x}_o^r)  + D_o(\dot{x}_o^d - \dot{x}_o^r) + K_o(x_o^d,x_o^r)  = h_{env}
%\end{equation}
%The constant $ \alpha $ scales the object inertia proportionally to a desired value.
%The control output is the reference object acceleration $ \ddot{x}_o^r $, $ h_{env} $ is an input. This is sometimes called admittance control, admittance being the inverse of impedance. $ h_{env} $ has to be known, but is not easily measured in a practical set-up. Recalling (\ref{EQ:ObjectDynamics}) the environmental forces can be expressed as:
%\begin{equation}
%h_{env} =  M_o \ddot{x}_o^r + C_o \dot{x}_o^r + g_o - G^\dagger h
%\end{equation}
%Herein $ G^\dagger $ is a generalized inverse of the grasp matrix, selecting the motion inducing components from the measured contact wrench $ h $. $ \dot{x}_o^r, x_o^r $ are calculated from $ \ddot{x}_o^r $ by integration.
%From the compliant object trajectory ($ \ddot{x}_o^r,\dot{x}_o^r,x_o^r $) the desired trajectories of the manipulator ($ \ddot{x}_i^d,\dot{x}_i^d,x_i^d $) using the kinematic constraints. The reference manipulator trajectory, enforcing compliant behaviour between manipulators and object, is calculated from manipulator dynamics and internal forces: 
%\begin{equation}
%M_i(\ddot{x}_i^d - \ddot{x}_i^r) + D_i (\dot{x}_i^d - \dot{x}_i^r) + K_i(x_i^d,x_i^r) = VV^\dagger h
%\end{equation}
%The control output is the reference acceleration of the i-th manipulator $ \ddot{x}_i^r $, $ \dot{x}_i^r,x_i^r $ are obtained from integration. These variables are the inputs the inner motion control loop (PD-type). The strategy of compliant trajectories allows for high gains in the motion controller. Knowledge of object dynamics and measurement of the contact wrenches is required.\\
%In a frequently cited follow-up paper Caccavale et al. \cite{Caccavale_08} combine the concept of \emph{geometrically consistent stiffness} with the same architecture. This allows for selective stiffness behaviour along different directions.\\
%Recently Heck et al. \cite{Heck_13} worked with this architecture, they assume knowledge of the environment instead of the object.
%The environmental wrench is than derived as:
%\begin{equation}
%h_{env} =  \Sigma D_{env} (\dot{x}_o^d - \dot{x}_o^r)  + \Sigma K_{env}(x_o^d,x_o^r)
%\end{equation}
%It is assumed here that the environment has a constant stiffness and damping ($ K_{env}(x_o^d,x_o^r),D_{env}) $. $ \Sigma $ is a diagonal selection matrix modelling the direction of contact.\\
%A combination of impedance control on manipulator/object level and feed-forward object dynamics is presented in\cite{DePascali_15}. The manipulators are modelled as springs and dampers, inertia is used to feed-forward the desired acceleration: 
%\begin{equation}
%M_i \ddot{x}_i^d + D_i (\dot{x}_i^d - \dot{x}_i) + K_i(x_i^d,x_i) = h^x
%\end{equation}
%This avoids the necessity of either measuring manipulator acceleration or contact force.
%Object dynamics is represented with feed-forward term, mapped to the manipulators with a weighted pseudoinverse $ G^+ $ of the grasp matrix:
%\begin{equation}
%h^d = G^+ (M_o \ddot{x_o^d} + C_o \dot{x_o^d} + g_o)
%\end{equation}
%Note that this term is not an impedance relation and does not adjust if the environment hinders motion.
%The combined control law is $ h^\Sigma = h^x + h^d $.\\
% 
%
%
%\subsection{Friction grasps in Cooperative Manipulation}
%The assumption of rigid-fixture between object and manipulators only holds f the manipulators are equipped with  appropriate grasping devices. In analogy to a human this device would be fingers wrapping around an inhomogeneity on the object, to achieve a rigid grasp. For an even object (e.g. a ball) humans use their hand palms to realize a friction grasp. Grasp stability is ensured by pressing the object. Technical applications where cooperative manipulators should be able to do a friction grasp are numerous, e.g. when no appropriate grasping device is available (or shall be avoided) or the object structure is not graspable.\\
%Research of friction grasps is mainly done with robotic hands, the fingertips being the contact points. Depending on the nature of the tip a certain number of contacts is required to achieve a firm grasp: for non-deformable and small but frictional contacts, three are required to hold an object with 6 \emph{DoF} tightly. This contact model is called \emph{Hard Finger} or \emph{Point Contact with Friction (PCwF)}. It allows to transmit forces along the contact normal in pushing direction and for forces in tangential plane. If the contact is deformable or of considerable size, two are sufficient contact points form a firm grasp. This is called \emph{Soft Finger} model. In addition to the \emph{Hard Finger} torques around the contact normal are transferred.\\
%The problem of grasping divides into three sub-problems: selection of suitable grasp points, coordinated motion of the constrained system and control of the grasping force especially when interacting with the environment. The problem of coordinated motion is very similar to the case of rigid-fixture, while the control is exclusive to friction grasps. With robot hands it is most important to maintain a stable grasp. Undesired or unnecessary and possibly harmful internal forces occur during dynamic manipulation and interaction with the environment. Since discrete robots in cooperative manipulation are often powerful, proper control of the internal forces becomes more important.\\
%For the reasons stated in the previous subsection hybrid position/force control approaches are less suitable than impedance control and will not be considered. The control architectures for rigid-fixture can be re-used if a internal force is applied in addition. By definition internal forces do not contribute to the motion of the constrained system and thus do not interfere with the control goals of rigid-fixture. Formally this can be described as $ G h_{int} = 0 $, i.e. the internal forces $ h_{int} $ lie in the null-space of the grasp matrix $ G $. To calculate desired internal forces a suitable vector $ z $ is multiplied with a basis of the null-space of the grasp matrix $ V $: $ h_{int}^d = V z $.\\
%When it comes to position uncertainties of contact points or deformable objects, calculating internal forces from a fixed grasp matrix may lead to undesired results. One alternative are \emph{Artificial Potential Fields (AFP)} to realize a desired formation of manipulators relative to each other in 3D space. 
%Sieber et al.\cite{Sieber_15} use \emph{AFP} to build up a formation of robots around an object. The object is grasped by varying the desired distances between the manipulators. The internal forces can thus be set in a physically meaningful way. The generated force of manipulator $ i $ in Cartesian direction $ k $ due to the springs connecting to the other manipulators $ j \in N_i $ is:
%\begin{equation}
%f_{i,k}^d = - \sum_{\substack{j\in N_i}} k_{ij} \dfrac{p_{i,k} - p_{j,k}}{\vert p_{i,k} - p_{j,k} \vert} (\vert p_{i,k}-p_{j,k}\vert - d_{ij,k})
%\end{equation}
%Notably here $ p\in\mathbb{R}^3 $ only represents the position of the manipulator, orientation information is omitted. Using the \emph{Hard Finger} contact model a pure translational representation is sufficient since it does not transmit torques. $ k_{ij} > 0$ is a control gain. The desired distance is defined by $ d_{ij,k} $.
%The approach controls only the formation of the robots and does not take the object dynamics into account. Positional control for the object is done assuming the object to be in the middle of the manipulators: $ p_o = \frac{1}{N} \sum\nolimits_{i=1}^{N} x_i $. This has important advantages: no need to know the object's dynamics and no need for tracking the object.\\
%Similar to the concept of \emph{AFP} are 1-\emph{DoF} springs with a desired rest-length. They only allow to set the absolute distance between two points in space, while \emph{AFP} control the distance along each direction. 1-\emph{DoF} can be more intuitive to control, because only one distance parameter has to be changed in contrast to a relative formation in 3D space.\\
%One approach using 1-\emph{DoF} springs is the \emph{Static IPC} by Wimb\"ock et al. \cite{Wimboeck_06}. The concept of the \emph{intrisically passive controller (IPC)} was introduced by Stramigioli \cite{Stramigioli_01} and will be covered later on. Here the rest-length springs connect to the middle of the manipulator set-up. The force generated by a single spring connecting from manipulator $ i $ to the center is: $ k_{i} \frac{p_i - p_o}{\vert p_i - p_o \vert} (\vert p_i-p_o\vert - d_{i}) $. Here $ k_i \in \mathbb{R}^3 $ is the stiffness matrix and $ d_i $ is the rest-length of the $ i $-th spring.
%Considering the cross-coupling of the springs the generated forces are:
%\begin{equation}
%f^d  = - \sum_{i=1}^N\left[\dfrac{\partial (p_i-p_o)^T}{\partial p} k_i \dfrac{p_i-p_o}{\vert p_i-p_o\vert}  (\vert p_i-p_o\vert - d_i) \right]
%\end{equation}
%Wherein $ \frac{\partial (p_i-p_o)^T}{\partial p} \in \mathbb{R}^{3N \times 3} $ is the cross-coupling matrix.
%Furthermore this approach uses another spring to connect environment and object. This is a 6-\emph{DoF} spring, thus the object's position and orientation is controlled. Force and torque are computed as:
%\begin{subequations}
%\begin{align}
%f_o^d = K_{o,t} R_o^T (p_o-p_o^d) \\
%t_o^d = 4 J^T_{\omega\epsilon} K_{o,r} \epsilon_d 
%\end{align}
%\end{subequations}
%The translational and rotational stiffness matrices are denoted by $ K_{o,t},K_{o,r} $. $ R_o $ is a rotation matrix indicating the object orientation, it is defined by the manipulator positions. $ \epsilon_d $ is the rotational error represented by the vector part of the quaternion, $ J^T_{\omega\epsilon} $ denotes the reduced quaternion product.\\
%Damping along each spring is proposed. This important especially for the cross-coupling springs to suppress oscillatory internal motions.\\
%While $ f^d $ acts on the manipulators, $ f_o^d $ and $ t_o^d $ act on the object. This is resolved by the hand geometry, different hand \emph{Jacobian} matrices cast the wrenches into joint torques. If no kinematic structure is present (e.g. when using discrete robots) often a weighted pseudoinverse of the grasp matrix (\cite{Schneider_92,DePascali_15}) is used. According to Stramigioli\cite{Stramigioli_01} the physically meaning of the weighting coefficients is small. Erhart and Hirche\cite{Erhart_15} recently presented weighted pseudoinverses based on inertia and geometry of object and manipulators. However (in some cases) this requires konwledge of the object properties. Stramigioli therefore introduces a virtual object, the wrench acts directly onto the virtual object and thus  influences its dynamics. The manipulators are connected to the virtual object with rest-length springs, so the object wrench is mapped to the manipulators via the virtual object dynamics.
%Wimb\"ock et al. implement Stramigioli's \emph{IPC} in a simplified version on a four fingered robotic hand\cite{Wimboeck_08}. The dynamics of the virtual object are:
%\begin{equation}
%M_v \ddot{x}_v + C_v \dot{x}_v + g_v = w_v
%\end{equation}
%The virtual object wrench $ w_v $ is composed of environment interaction $ w_{vo} $ and manipulator forces $ f_c $: $ w_v = w_{vo} + G_v f_c $. Where $ G_v $ is the virtual grasp matrix. Environment interaction is described by a 6 \emph{DoF} spring: $ w_{vo} = K(x_v^d,x_v) $. The springs connecting to the manipulators exert the wrench on the virtual object: $ G_v f_c = G_v K_c (p - G_v^T x_v) $. The control law for the manipulators is already given as:
%\begin{equation}
%f = -f_c = K_c(G_v^T x_v - p)
%\end{equation}
%The stiffness matrix $ K_c = blockdiag(k_1 I_3, ... , k_n I_3)$ is isotropic. The rest-lengths of the springs are chosen by the size of the virtual object, i.e. by specifying the virtual grasp matrix $ G_v $.\\
%One assumption in \cite{Wimboeck_08} is that internal forces are sufficient to ensure a firm grasp. This is done in a physically meaningful way by choosing the rest-lengths.
%Allowing a human to directly control the formation (e.g. with gestures), three parameters are to be specified by the operator: position, orientation and grasping force. Tracking and processing human inputs causes a delay, which can be compared to a telemanipulation setting, although the operator may be on-site. A local controller is required to ensure a secure grasp while human interfacing can be higher level control.

%\subsection{Determination of desired internal forces}
%Non-rigid grasps object and manipulators are connected with friction constraints. Contact force towards the object generates frictional force opposed to external forces tangential to the contact point. If the tangential forces exceed the frictional force the friction constraint is violated and contact slippage occurs. Squeezing or internal forces do not contribute to the motion of the constrained system. They need to be chosen sufficiently high to maintain a stable grasp under external forces acting on the object. On the other hand they must be bounded to not damage the object. These opposed requirements can be formulated as a cost function.\\
%Buss et al. \cite{Buss_96} propose a cost function consisting of two factors: one is a barrier function tending to infinity for violating the friction constraint limit, the other is linear function rising with the exerted force, making high forces costly. The optimal desired internal force is the minimum of the cost function, thus the forces are chosen as small as possible, preserving a stale grasp.\\
%Non-linear friction constraints are given for the \textit{point contact friction} and the \textit{soft contact friction} model:\\
%The \textit{point contact friction} constraint allows transmitting force in tangential  and normal  (only towards the object) direction. In addition the \textit{soft contact} constraint transmits the torsional moment around the normal axes. Buss' main contribution is that friction constraints can be reformulated  equivalent to positive definite matrices. These matrices are used to construct the cost function. This results in a convex optimization problem, thus an optimum is always a global optimum. \\
%Bicchi et al. \cite{Bicchi_98} limit their contribution to the \textit{point contact friction} model but expand the cost function. A maximum contact force is introduced, this is useful for rather loosing contact than destroying the object. Furthermore a minimum force in normal direction is specified to ensure grasp stability even under uncertainties. This two add up to with the friction constraint to a function, which has a negative scalar value if the set of constraints are respected. The sum of this functions for all contact points forms the cost function.\\ 
%Han et al. \cite{Han_2000} reformulated Buss' positive definite matrix approach as a \textit{linear matrix inequality}(LMI) problem. Being a common optimization task, efficient solvers (e.g. interior point algorithm) exist. Calculation time could be significantly reduced.
%____________________________________________________



%_____Kapitel 2_________________________________
\chapter{port-Hamiltonian system modelling}\label{C:pHS modelling}
%The controller is divided into two parts, the local one does the real-time interaction of the manipulators with the object. This part is passive, i.e. the robot along with its local controller has a certain amount of energy, the energy can not increase as long as no power is provided by the environment or the higher-level control part. Therefore the two parts will be called Intrinsically Passive Controller and Supervisor, this scheme was introduced by Stramigioli \cite{Stramigioli_01} as a general framework with application to robotic hands.
In this chapter a modelling approach of the cooperative   system based on the port-Hamiltonian framework is introduced. This aims for a consistent system description over different energetic domains, present in mechanical systems in the form of kinetic and potential energy. The general theory of port-Hamiltonian systems is presented in Section \ref{S:HSdescription}. The generalization for six-dimensional mechanical system leading to systems defined on manifolds is introduced in Section \ref{S:3Dspace-modelling}. In cooperative manipulation set-ups, manipulators and object are rigidly connected, the arising constraints are treated in Section \ref{S:ImposingConstraints}. 
System modelling is performed by interconnecting standardized mechanical elements using network theory. The composition of a mechanical impedance, suitable for model-based control (see Chapter 3) is shown in Section \ref{S:springmassdampers}.
  
\section{Energy-based modelling and control}
Every physical process involves energy and and energy transfers or transformations. Energy is a very general concept in physical systems, it allows for a consistent description across different physical domains. Even within the mechanical domain there are two forms of energy (kinetic, potential), e.g. acceleration can be viewed as a transition from potential to kinetic energy. Energetic relations do not only define static relations between physical systems but also their dynamic behaviour, described by the transient exchange of energy \cite{Ortega_01}. The modelling of a complex physical system can therefore be accomplished by an interconnection of simple subsystems, defined by an energy function. We can combine such physical elements to achieve a desired dynamic behaviour and thereby define a model-based controller on energetic level.  In contrast to this, control is traditionally handled from a signal processing viewpoint, i.e. from a reference input an output signal is generated to reduce some error signal. Control design on the energetic level allows to build a model-based controller in a physically meaningful way. An energetically consistent control scheme visualizes the flow of energy in the system (e.g. energy supplied by an operator distributed to the robots) and is intrinsically passive. Considering the energy balance of the controlled system and explicitly performing control by shaping the energy is the foundation of passivity based control. Passive controlled robots are appropriate when dealing with unknown environments (see also chapter \ref{C:Energy-aware control} and \cite{Stramigioli_15}).\\
Another motivation for control design on energy level is safety in physical human-robot interaction or co-working. The kinetic energy stored in the robotic system is intimately connected with the risk of severe injuries of a human. The \emph{Head Impact Power} relates the rate of change of kinetic energy to the probability of head injury \cite{Newman_00}. Assume a human explicitly controlling a robotic team, with her/his commands s/he supplies energy to the controller and the controller distributes the energy to the robots. Because of its formulation on the energy level, the controller is aware of the energetic state of the system and can adapt its behaviour to keep the energy bounded (see chapter \ref{C:Energy-aware control}).\\
For the energy-consistent modelling of mechanical systems two approaches are known:  the Lagrangian and the Hamiltonian. In recent years a combination of the Hamiltonian description and port-based interconnection was developed, we refer to port-Hamiltonian modelling. It allows to describe complex physical systems based on the interconnection of simpler subsystems, represented in a convenient input-state-output formulation, which has the structure of a (non-linear) state space formulation. The Hamiltonian function of the interconnected system sums up the total energy stored in the subsystem and is a Lyapunov candidate function, facilitating stability proofs.

\section{Formation control for cooperative manipulation}
A more general perspective on cooperative manipulation is opened from a formation control viewpoint. A common assumption for cooperative manipulation is rigid connection between the common object and the manipulators \cite{CoopManipHandbook}, leading to a geometric set-up described by a \emph{grasp matrix}. Based on a particular choice of a weighted pseudoinverse of this matrix \cite{Walker_91},\cite{Erhart_15} forces are distributed from the object to the manipulators, an approach with little physical interpretation according to \cite{Wimboeck_08}. The intuition of formation control is to establish a certain group behaviour for several robotic manipulators to achieve a geometric shape \cite{VosDiss_15}. One of the three types of formation control described in \cite{Lawton_03} is virtual structures between mobile robots. Virtual springs and dampers are used in \cite{Vos_14} to coordinate the formation driving of a group a wheeled robots. Recently, Sieber et al. \cite{Sieber_15} establish formation control of several manipulators around a common object and study the control options for a human to direct the closed formation. The dynamics of the handled object is not considered in the control scheme, however we often deal with large and heavy objects with non-negligible inertia. In the virtual structure of Stramigioli's \emph{Intrinsically Passive Controller} each the robots is connected with a virtual spring to a common, virtual object.

\section{port-Hamiltonian description of mechanical systems}\label{S:HSdescription}
For the derivation of the port-Hamiltonian description of a mechanical system we start from the classical \emph{Euler-Lagrange} equations of motion
\begin{equation}
\frac{d}{dt}\left(\frac{\partial \mathcal{L}}{\partial \dot{q}}\right) - \frac{\partial \mathcal{L}}{\partial q} = g(q)f,
\end{equation}
where $q$ is the vector of generalized configuration coordinates of the system. The \emph{Lagrangian} $\mathcal{L} = V_k - V_p$ equals the difference between the kinetic co-energy $V_k$ and the potential energy $V_p$. The kinetic co-energy is explicitly given as $V_k = \frac{1}{2} \dot{q}^T M(q) \dot{q}$, with a symmetric, positive definite inertia matrix $M(q)$. The generalized forces $f$ act on the system with an input matrix $g(q)$. We define the generalized \emph{momenta} for every Lagrangian $p := \frac{\partial \mathcal{L}}{\partial \dot{q}}$ and obtain $p = M(q)\dot{q}$.
Introducing the \emph{Hamiltonian} (energy) function $H(q,p) = p^T\dot{q} - \mathcal{L}(q,\dot{q})$ we can rewrite the Euler-Lagrange equation in form of the classical Hamiltonian equations of a mechanical system \begin{eqnarray}\label{EQ:mechanicalPHS}
	\begin{aligned}
	& \dot{q} = \frac{\partial H}{\partial p}(q,p)\\
	& \dot{p} = -\frac{\partial H}{\partial q}(q,p) + g(q)f
	\end{aligned}
\end{eqnarray}
The Hamiltonian describes the total energy stored in the system \cite{vanderSchaft_06}, thus the energy balance is
\begin{equation}
	\frac{d}{dt}H = \frac{\partial^T H}{\partial q}(q,p)\dot{q} + \frac{\partial^T H}{\partial p}(q,p)\dot{p} = f^Tg^T(q)\dot{q} = f^Te
\end{equation}
Hamiltonian systems are energy conservative, i.e. the energy supplied through the port is stored in the system. In the upper equation a new output $e=g^T(q)\dot{q}$ is introduced. Clearly the product $e^Tf$ is the exchanged power and we call the pair $(f,e)$ a \emph{power port}.
The general equations of a port-Hamiltonian system are
\begin{eqnarray}
\begin{aligned}
	& \dot{q} = \frac{\partial H}{\partial p}(q,p)\\
	& \dot{p} = -\frac{\partial H}{\partial q}(q,p)+g(q)f \\   &e = g^T(q)\frac{\partial H}{\partial p}(q,p)
\end{aligned}	
\end{eqnarray}
Port-Hamiltonian systems are suitable to describe a variety of physical systems including mechanical, electrical, thermal and hydraulic elements, see \cite{duindam2009geoplexbook} for an overview. This motivates the more general input-output concept of flows $f$ and efforts $e$ forming the port variables $(f,e)$.\\
\textbf{Example 2.1:}\\
Consider a simple one-dimensional spring-mass system described by $ m\ddot{x} = -kx +F $, where $ m,k,F $ denote the mass, stiffness and external force acting on the mass respectively. We can give a state space formulation of the system
\begin{figure}[b!]
	\centering
	\small
	\def\svgwidth{0.5\columnwidth}
	\input{springmass.eps_tex}
	\caption[Spring-mass example]{Spring-mass example}
	%\vspace{-20pt}
	\label{FIG:springmass}
\end{figure}
\begin{equation}
	\begin{pmatrix}\dot{x} \\ \ddot{x}\end{pmatrix} =
	\begin{pmatrix}0 & 1 \\ -\frac{k}{m} & 0\end{pmatrix}
	\begin{pmatrix}x \\ \dot{x}\end{pmatrix} + 
	\begin{pmatrix}0 \\ 1\end{pmatrix}\frac{F}{m}
\end{equation}
In the Hamiltonian approach the system is described based on the Hamiltonian energy functions, being $ H_s(q) = \frac{1}{2}kq^2 $ for the spring and $ H_m(p) = \frac{1}{2m}p^2 $ for the mass. The total energy is thus $H(q,p) = H_s + H_m$ The state variables are thus replaced by the energy states, the \emph{configuration} $q=x$ accounting for the spring and the \emph{momentum} $p=m\dot{x}$ accounting for the mass.  
\begin{eqnarray}\label{EQ:HSexample}
\begin{aligned}
	\begin{pmatrix}\dot{q} \\ \dot{p}\end{pmatrix} &=
	\begin{pmatrix}0 & 1 \\ -1 & 0\end{pmatrix}
	\begin{pmatrix}\frac{\partial H}{\partial q}(q,p) \\ \frac{\partial H}{\partial p}(q,p)\end{pmatrix} + 
	\begin{pmatrix}0 \\ 1\end{pmatrix} F\\
	e &= \begin{pmatrix}	0 & 1\end{pmatrix}\begin{pmatrix}\frac{\partial H}{\partial q}(q,p) \\ \frac{\partial H}{\partial p}(q,p)\end{pmatrix}
	\end{aligned}
\end{eqnarray}
\newline
Key aspect of port-Hamiltonian system is the division into atomic energy storing elements (spring, mass) and their proper interconnection. In the example we have implicitly done this by defining energy functions and states for both elements. The rules of interconnection are explicitly given by: 
\begin{itemize}
\itemsep0em
	\item equal velocity of spring tip and mass $\dot{x}=\frac{\partial V}{\partial p}$(rigid connection)
	\item opposite forces at spring tip and mass $\dot{p}=-\frac{\partial V}{\partial q}+F$ (principle of action-reaction) 
\end{itemize}
Due to the \emph{second law of thermodynamics} real mechanical systems are never energy conservative. Thus we require energy dissipating elements (since thermal energy is "lost" w.r.t. the mechanical domain). A mechanical system is thus described by its basic elements: springs, masses and dampers. Table \ref{TAB:PHSvar_mechanic} gives an overview of the elements and their characterizing quantities. Note that dissipation elements do not have a state because they are static. It is worth pointing out that the \emph{flows} are the time derivatives of the \emph{states}.    



\begin{table}
	\centering
	\caption[port-Hamiltonian system variables of mechanical elements]{port-Hamiltonian system variables of mechanical elements}\vspace{10pt}
	\label{TAB:PHSvar_mechanic}
	
	\begin{tabular}{ l | l | l | l }
		& \textbf{Spring} & \textbf{Mass} & \textbf{Damper} \\ \hline
		\textbf{Effort variable} & Force $F$ & Velocity $\dot{x}$ & Force $ F $ \\ \hline
		\textbf{Flow variable} & Velocity $ \dot{x} $ & Force $ F = \dot{p} $ & Velocity $ \dot{x} $ \\ \hline
		\textbf{State variable} & Position $x$ & Momentum $ p $ & - \\ \hline
		\textbf{Energy function} & $ E(x) = \frac{1}{2}kx^2 $ & $ E(p) = \frac{p^2}{2m} $ & $E(\dot{x}) = D\dot{x}^2  $ (diss. co-energy) \\ 
	\end{tabular}
\end{table}

Next to \emph{energy-storing} and \emph{-dissipating} there is a third class of elements, namely \emph{energy-conservative} structures. Elements within this group are transformers, gyrators and ideal constraints. They are used to redirect the power flow in the system. It is possible to merge all \emph{energy-storing} elements into a single object representation (see Fig. \ref{FIG:pHsstructure}). Analogously this can be done for the dissipation elements. The interconnecting structure (denoted by $\mathcal{D}$ in Fig. \ref{FIG:pHsstructure}), consisting of the \emph{energy-conservative} elements, formalizes the energy routing and geometric dependencies of the system. A detailed explanation is given in the next subsection.


%\begin{figure}[htb]
%	\centering
%	\includegraphics[width=0.55\textwidth]{diracstructure.png}
%	\caption[port-Hamiltonian system structure]{port-Hamiltonian system structure \cite{vanderSchaft_06}}
%	\label{FIG:pHsstructure}
%\end{figure}
\begin{figure}[b!]
	\centering
	\small
	\def\svgwidth{0.6\columnwidth}
	\input{diracstructure.eps_tex}
	\caption{port-Hamiltonian system structure}
	\label{FIG:pHsstructure}
\end{figure}

Complex physical systems can be modelled as a network of energy storing and dissipating elements, similar to representation of electrical networks consisting of resistors, inductors and capacitors. The rules of interconnection are Newton's third law (action-reaction), Kirchhoff's laws and power-conserving elements like transformers or gyrators. The aim of port-Hamiltonian modelling is to describe the power-conserving elements with the interconnection laws as a geometric structure and to define the Hamiltonian function as the total energy of the system. \\
The power flowing between the system's portions is described by the flow-effort product $e^Tf$.

\subsection{Dirac structures and interconnection ports} \label{SS:PHSinterconnection}
The energy-routing structure forms the basis of every port-Hamiltonian system. It can be compared to the printed circuit board in electronics, where capacitors, inductors and resistors are the energy-storing and damping elements. Mathematically it has the form of a \emph{Dirac} structure \cite{vanderSchaft_06}. The main property of a Dirac structure is power conservation, i.e. the power flowing into and out of it always sums to zero. We can define the set of ports $(f,e)$ connecting to the Dirac structure $\mathcal{D}$, thus 
\begin{equation}
e^Tf = 0 \;  \; \forall (f,e)\in\mathcal{D}
\end{equation}
Where $\mathcal{D}$ is a subspace of the space of flow and effort $\mathcal{D} \subset \mathcal{E}\times \mathcal{F}$. The space of flows is $f \in \mathcal{F}$ the space of efforts is its dual linear space $e \in \mathcal{E} = \mathcal{F}^*$. The Dirac structure has the same dimension than the space of flow $dim \mathcal{D} = dim \mathcal{F}$.
Further mathematical requirements can be found in literature \cite{vanderSchaft_06,Schaft_14}. Power conservation means that supplied energy is either stored or dissipated in the system. All storing and resistive elements can be represented each in a single element as shown in figure \ref{FIG:pHsstructure}. Three ports join in the interconnection structure, one for external supply $(f_P,e_P)$, one for the sum of storing elements $(f_S,e_S)$ and one for the resistive elements $(f_R,e_R)$. Mathematically the  interconnection of ports is defined by the Dirac structure matrix $D$
\begin{equation}\
\begin{pmatrix}
e_P \\ f_S \\ e_R
\end{pmatrix} = D \begin{pmatrix}
f_P \\ e_S \\ f_R
\end{pmatrix}
\end{equation}
It can be shown that for a skew-symmetric $D$ the power balance of the ports is
\begin{equation}
e_S^Tf_S + e_P^Tf_P + e_R^Tf_R = 0,
\end{equation}
This fulfils the desired power conservation.\\
We can simplify equation \ref{EQ:mechanicalPHS} by setting $x = (q^T,p^T)^T$ and introduce a general port-Hamiltonian system of the form
\begin{eqnarray}\label{EQ:generalPHS}
\begin{aligned}
\dot{x} &= [J(x)-R(x)]\frac{\partial H}{\partial x}(x) + g(x)f\\
e &= g^T(x)\frac{\partial H}{\partial x}(x),
\end{aligned}
\end{eqnarray}
with $J(x) \in \mathbb{R}^{n\times n}$ being a skew-symmetric structure matrix and $R(x)  \in  \mathbb{R}^{n\times n}$ being a positive semi-definite, symmetric dissipation matrix.

\subsubsection{Energy storage port}
The port accounts for the internal storage of the system, its port variables are $ (f_S,e_S) $. The power supplied through this port is stored in the Hamiltonian energy function $H(x)$ of the system. The resulting energy balance is:
\begin{equation}\label{EQ:storageport}
	\frac{d}{dt}H = \frac{\partial^T H}{\partial x}(x) \dot{x}
\end{equation}
The flow variable is the energy rate $ f_S = -\dot{x} $ and the effort variable is $ e_S = \frac{\partial H}{\partial x}(x) $.

\subsubsection{Energy dissipation port}
The port corresponds to internal dissipation and can be used to model resistive elements. The port variables are described by the general resistive relation
\begin{equation}
	F(f_R,e_R)=0
\end{equation}
with the property  $ e_R^T  f_R \leq 0 $ (energy dissipation). An important special case is the input-output resistive relation $f_R = -F(e_R)$, for linear elements simply
\begin{equation}
f_R = -Re_R \; , \; R=R^T\geq0
\end{equation}
For an uncontrolled system that does not interact with the environment, i.e. no energy exchange through the  external port, the energy balance is:
\begin{equation}
	\frac{dH}{dt} = -e_S^Tf_S = e_R^T f_R \leq 0
\end{equation}

\subsubsection{External port}
The external port $(f_P,e_P)$ can be further split into an environment \emph{interaction} $(f_I,e_I)$ and a \emph{control} port $(f_C,e_C)$, satisfying $e_P^Tf_P = e_I^Tf_I + e_C^Tf_C$.
The power balance of the whole system then is
\begin{equation}
	e_S^Tf_S + e_R^T f_R +e_I^Tf_I + e_C^T f_C = 0
\end{equation} 
or by using (\ref{EQ:storageport})
\begin{equation}\label{EQ:energybalance}
	\frac{dH}{dt} = e_R^T f_R +e_I^Tf_I + e_C^T f_C 
\end{equation}

\subsubsection{Interconnection of port-Hamiltonian systems}
It is important to notice that the interconnection of two port-Hamiltonian systems is again a port-Hamiltonian system \cite{Schaft_14}. Consider two general systems $(i=1,2)$ with open control and environment interaction ports:
\begin{eqnarray}
\begin{aligned}
	\dot{x}_i &= (J_i - R_i)\frac{\partial H_i}{\partial x_i}+ (g_i^C & g_i^I)\begin{pmatrix}f_i^C \\ f_i^I\end{pmatrix}\\
	\begin{pmatrix}e_i^C \\ e_i^I\end{pmatrix} &= \begin{pmatrix}(g_i^C)^T \\ (g_i^I)^T\end{pmatrix}\frac{\partial H_i}{\partial x_i}
\end{aligned}
\end{eqnarray}
where $J_i,R_i$ are a skew-symmetric structure matrix and a positive semi-definite symmetric dissipation matrix. $(g_i^C g_i^I)$ is a general input matrix respectively.
For notational convenience the usual dependencies on the states have been omitted. The control inputs and outputs are now connected by setting $f_1^C = e_2^C $ and $ f_2^C = -e_1^C $. Note that the minus sign is necessary for power conservation. The power exchanged by the $i$-th system is $P_i = (e_i^C)^Tf_i^C$, therefore the total exchanged energy fulfils $ P_1 + P_2 = 0 $. The resulting interconnected system has still the environment interaction ports open:
\begin{eqnarray}
\begin{aligned}
	\dot{x} &= (J - R)\frac{\partial H}{\partial x}+ (g_1^I & g_2^I)\begin{pmatrix}f_1^C \\ f_2^I\end{pmatrix}\\
	\begin{pmatrix}e_1^I \\ e_2^I\end{pmatrix} &= \begin{pmatrix}(g_1^I)^T \\ (g_2^I)^T\end{pmatrix}\frac{\partial H}{\partial x}
\end{aligned}
\end{eqnarray}
where $ x = (x_1, x_2)^T $ and $ H = H_1 + H_2 $ is the sum of the two energies. The structure and dissipation matrix become:
\[J = \begin{pmatrix} J_1 & g_1^C(g_2^C)^T \\ 
-g_2^C(g_1^C)^T & J_2\end{pmatrix} \, , \; 
R = \begin{pmatrix}
R_1 & 0 \\ 0 & R_2\end{pmatrix}\]

\subsubsection{port-Hamiltonian systems and passivity}
A system is \emph{passive} if there exists a differentiable storage function $H(x) \geq 0$ that satisfies 
\begin{equation}\label{EQ:PassivityDefinition}
\frac{d}{dt}H(x(t)) \leq u^T(t)y(t)
\end{equation}
The product of the input-output pair $(u,y)$ is the supplied power. By definition the Hamiltonian function represents the total energy stored in the system. For a port-Hamiltonian system of the form of equation (\ref{EQ:generalPHS}) we have
\begin{eqnarray}
\begin{aligned}
\frac{d}{dt}H(x) &= \frac{\partial^T H}{\partial x} \frac{dx}{dt} = \frac{\partial^T H}{\partial x}\left[(J(x)-R(x))\frac{\partial H}{\partial x} + g(x)f\right] = \\
&= \frac{\partial^T H}{\partial x}J(x)\frac{\partial H}{\partial x} - \frac{\partial^T H}{\partial x}R(x)\frac{\partial H}{\partial x} + (g^{-T}(x)e)^T g(x)f = \\
&= e^Tf - \frac{\partial^T H}{\partial x}R(x)\frac{\partial H}{\partial x}
\end{aligned}
\end{eqnarray}
The property $\frac{\partial^T H}{\partial x}J(x)\frac{\partial H}{\partial x}=0$ holds for a skew symmetric matrix $J(x) = -J(x)^T$. The product of the effort-flow pair $e^Tf$ is the power supplied to the system. Since $R(x)=R(x)^T \geq 0$ is symmetric and positive semi-definite, we have $\frac{\partial^T H}{\partial x}R(x)\frac{\partial H}{\partial x} \geq 0$. Conclusively equation (\ref{EQ:PassivityDefinition}) holds for every port-Hamiltonian system that satisfies the properties of equation (\ref{EQ:generalPHS}), clearly the system is \emph{passive}. If $R=0$, i.e. the system exhibits no dissipation we call it \emph{lossless}.  
\section{3D-space modelling of mechanical systems}\label{S:3Dspace-modelling}


\subsection{Euclidean space and motions}\label{[SS:euclideanspacemotions]}
\subsubsection{Coordinate frames}
A coordinate frame of the three-dimensional Euclidean space is a 4-tuple of the form $ \Psi = (o,\hat{x},\hat{y},\hat{z})$. Where $ o $ is the three-dimensional vector of the origin and $ \hat{x},\hat{y},\hat{z} $ are the linear independent, orthonormal coordinate vectors. Consider two coordinate frames $ \Psi_1,\Psi_2 $ which share the same origin but differ in orientation due to different choices of $ \hat{x}_i,\hat{y}_i,\hat{z}_i, \; i=1,2 $. The change of orientation from $ \Psi_i $ to $ \Psi_j $ is described by the rotation matrix $ R_i^j $. The set of rotation matrices is called \emph{special orthonormal} group ($SO(3)$) \cite{Stramigioli_01b} and is defined as:
\begin{equation}
	SO(3) = \{R \in \mathbb{R}^{3 \times 3} \; | \; R^{-1} = R^T, det R = 1\}
\end{equation}
Usually coordinate frames are defined with respect to an inertial frame, and the coordinate vectors $ \hat{x},\hat{y},\hat{z} $ are chosen equal for all frames, deviations of orientation are represented by a rotation matrix relative to the inertial frame. In general a change of coordinate frames from $ \Psi_i $ to $ \Psi_j $ can be expressed with the homogeneous matrix
\[ H_i^j := \begin{pmatrix}R_i^j & p_i^j \\ 0_{1\times3} & 1\end{pmatrix} \]
where $p_i^j = o_j - o_i$ denotes the distance between the origins. A point $ p^i \in \mathbb{R}^3 $ expressed in $ \Psi_i $ is cast into $\Psi_j$ by
\begin{equation}\label{EQ:coordchange}
	\begin{pmatrix}p^j \\ 1\end{pmatrix} = H_i^j \begin{pmatrix}
		p^i \\ 1\end{pmatrix}
\end{equation}.
The inverse transformation $ H_j^i $ is given by 
\[H_i^j = (H_i^j)^{-1} = \begin{pmatrix}(R_i^j)^T & -(R_i^j)^T p_i^j \\ 0_{1 \times 3} & 1\end{pmatrix} \]
and is still a homogeneous matrix.
The set of homogeneous matrices is called the \emph{special Euclidean} group:
\begin{equation}
	SE(3) := \{\begin{pmatrix}R & p\\0 & 1\end{pmatrix} \; | \; R \in SO(3), p \in \mathbb{R}^3\} 
\end{equation}
The $SE(3)$ is a matrix Lie group, composed of the set of homogeneous matrices $H_i^j$ and the matrix multiplication being the group operation. For more information on Lie groups see e.g. \cite{Stramigioli_01}.
\subsubsection{Twists and wrenches}
Consider any point $ p $ not moving in coordinate frame $\Psi_i $, i.e. $ \dot{p}^i = 0 $. If $ p $ is moving in another coordinate frame $ \Psi_j $, the two frame move with respect to each other. The trajectory can be described as a function of time: $H_i^j(t) \in SE(3)$. By differentiating (\ref{EQ:coordchange}) one obtains
\[\begin{pmatrix}\dot{p}^j(t) \\ 1\end{pmatrix} = \dot{H}_i^j(t) \begin{pmatrix}p^i \\ 1\end{pmatrix} \]
$ \dot{H}_i^j $ describes both motion and a change of the reference frame. A separated representation is
\begin{equation}\label{EQ:twistrighttranslation}
	\begin{pmatrix}\dot{p}^j(t) \\ 1\end{pmatrix} = \tilde{T}_i^{j,j}\left(H_i^{j}\begin{pmatrix}p^i \\ 1\end{pmatrix}\right)
\end{equation}
$ \dot{H}_i^j$ is a tangential vector along the trajectory $H_i^j(t)$ and thus in the tangent space of the $SE(3)$: $ \dot{H}_i^j \in T_{H_i^j}SE(3)$. To obtain a representation of motion which is referenced to a coordinate frame, we can map $\dot{H}_i^j$ to the identity of the $SE(3)$. At the identity $ e $ of the $SE(3)$ the tangent space $ T_e SE(3) $ has the structure of a Lie algebra. The Lie algebra of the $SE(3)$ is denoted by $\mathfrak{se}(3)$. This is done either by left or right translation, for a definition see \cite{Stramigioli_01}. The right translation is used in (\ref{EQ:twistrighttranslation}) and is written compactly
\begin{equation}\label{EQ:righttranslation}
\dot{H}_i^j = \tilde{T}_i^{j,j} H_i^j
\end{equation}\label{EQ:lefttranslation}
The left translation leads to
\begin{equation}
\dot{H}_i^j = H_i^j \tilde{T}_i^{i,j} 
\end{equation}
We call $\tilde{T} \in T_e SE(3)$ a twist and the $\mathfrak{se}(3)$ the space of twists.
Let us look more closely at this representation by calculating the twist from the elements of the homogeneous matrix

\begin{eqnarray}\label{EQ:twistdecomposition}
\begin{aligned}
T_i^j &= \dot{H}_i^j H_j^i =
\begin{pmatrix}
\dot{R}_i^j & \dot{p}_i^j \\ 0 & 0
\end{pmatrix}
\begin{pmatrix}
R_j^i & p_j^i \\ 0 & 1
\end{pmatrix} = 
\begin{pmatrix}
\dot{R}_i^j & \dot{p}_i^j \\ 0 & 0
\end{pmatrix}
\begin{pmatrix}
(R_i^j)^T & -(R_i^j)^Tp_i^j \\ 0 & 1
\end{pmatrix} = \\ &= 
\begin{pmatrix}
\dot{R}_i^j(R_i^j)^T & -\dot{R}_i^j(R_i^j)^Tp_i^j + \dot{p}_i^j \\ 0 & 0
\end{pmatrix} =: 
\begin{pmatrix}
\tilde{\omega}_i^j & v_i^j \\ 0 & 0
\end{pmatrix}
\end{aligned}
\end{eqnarray}
It is clear from this equation that the linear velocity part $v_i^j$ is not the velocity of the frame $\Psi_i$ with respect to $\Psi_j$, identified by $\dot{p}_i^j$. This twist representation is described by the \emph{screw theory} (see e.g. \cite{KinematicsHandbook}). It can be visualized by the angular velocity around an axis and the linear velocity along this axis.



Next to the $4  \times 4$ matrix $\tilde{T} $ there exists also a vector representation $T\in \mathbb{R}^6$
\begin{equation}
 \tilde{T} = \begin{pmatrix}\tilde{\omega} & v \\ 0 & 0\end{pmatrix} \; , \; T = \begin{pmatrix}\omega \\ v\end{pmatrix} \end{equation}
wherein $v$ is the velocity and $\omega$ is the angular velocity. $\tilde{\omega}$ is the skew-symmetric representation of the vector $\omega$
\begin{equation}\label{EQ:skewsymmetricop}
\omega = \begin{pmatrix}
\omega_1 \\ \omega_2 \\ \omega_3\end{pmatrix} \; \Rightarrow \; \tilde{\omega} = \begin{pmatrix}0 & -\omega_3 & \omega_2 \\ \omega_3 & 0 & \omega_1 \\ -\omega_2 & \omega_1 & 0\end{pmatrix} \end{equation} \\

Left and right translations lead to different representations of a twist:
\begin{itemize}
\item $T_i^{k,j}$ is the twist of $\Psi_i$ with respect to $\Psi_j$ expressed in the frame $\Psi_k$
\item $T_i^j = T_i^{j,j}$ is the twist of $\Psi_i$ with respect to $\Psi_j$ expressed naturally in $\Psi_j$ 
\end{itemize}

Changes of coordinates for twists are of the form 
\begin{equation}
\tilde{T}_i^{j,j} = \tilde{T}_i^{j} = H_i^j \tilde{T}_i^{i,j} H_j^i\end{equation}
or for the vector representation
\begin{equation}
 T_i^{j} = Ad_{H_i^j} T_i^{i,j} \; , \;
Ad_{H_i^j} = \begin{pmatrix}R_i^j & 0 \\ \tilde{p}_i^j R_i^j & R_i^j\end{pmatrix} \end{equation}

The  dual vector space of $\mathfrak{se}(3)$ is the space of linear operations from $\mathfrak{se}(3)$ to $\mathbb{R} $. It is denoted by $\mathfrak{se}^*(3)$ and represents the space of wrenches $W$. Wrenches decompose to moments $ m $ and forces $ f $.
\begin{equation}
 W = ( m \;\; f) \; , \; \tilde{W} = \begin{pmatrix}
\tilde{m} & f \\ 0 & 0\end{pmatrix} \end{equation}
Again $\tilde{W} \in \mathbb{R}^{4\times 4}$ is a matrix while $W \in \mathbb{R}^6$ is the  row vector representation.
The change of coordinates for twists is similar to the case of twists:
\begin{equation}
(W_i^{k,i})^T = Ad_{H_k^i}^T (W_i^i)^T \end{equation} 
Here the mapping is in the opposite direction, from $\Psi_j$ to $\Psi_i$, what is a consequence of the fact that wrenches are duals to twists. Again there are different representations of wrenches: \begin{itemize}
\item $W_i^{k,j}$ is the wrench applied to a spring connecting $\Psi_i$ to $\Psi_j$ on the side of $\Psi_i$ expressed in the coordinate frame $\Psi_k$.
\item $W_i^k $ is the wrench applied to a body attached to $\Psi_i$ expressed in the coordinate frame $\Psi_k$.
\end{itemize}
These definitions lead to the following rules of interconnection:
Connecting a body and spring in the point $\Psi_i$ and applying the principle of action and reaction we get $W_i^{k,j} = -W_i^k$. Due to the nodicity of a spring we have $ W_i^{k,j} = -W_j^{k,i} $\\

We define power flowing through a port by the duality product of flow and effort, in the mechanical domain this twist and wrench. On a vector space level the power port $\mathcal{P}$ is defined by the Cartesian product of the Lie algebra $\mathfrak{se}(3)$ and its dual $\mathfrak{se}^*(3)$: $\mathcal{P} = \mathfrak{se}(3) \times \mathfrak{se}^*(3)$.

\subsubsection{General input-state-output port-Hamiltonian systems}
The simple relation $\dot{q}=\frac{\partial H}{\partial p}$ does not hold for a 3D-mechanical system. With reference to the next section we find $\frac{\partial V}{\partial P_i^i} = T_i^{i,0} = H_0^i \dot{H_i^0}$, with the $H_0^i$ being the configuration variable and $P_i^i$ the momentum. For reasons of notational clarity the Hamiltonian is denoted with $V$. The interconnecting Dirac structure in 3D-mechanical system  is dependent on the configuration and we call it a \emph{modulated} Dirac structure. This motivates the more general concept of port-Hamiltonian systems on \emph{manifolds}. By introducing local coordinates $x$ on the state manifold $\mathcal{X}$, we can associate the flows towards the energy storage with $f_s = -\dot{x}$ and the efforts with $e_s = \frac{\partial V}{\partial x}$. The flows are elements of the tangent space of the state manifold $T_x\mathcal{X}$ and the efforts are elements of the co-tangent space $T_x^*\mathcal{X}$. A general port-Hamiltonian system defined on $\mathcal{X}$ is of the form
\begin{eqnarray}
\begin{aligned}
\dot{x} &= [J(x)-R(x)]\frac{\partial V}{\partial x}(x) + g(x) u \\
y &= g^T(x)\frac{\partial V}{\partial x}
\end{aligned}
\end{eqnarray}
with a skew-symmetric matrix $J(x)$ and a resistive structure matrix $R(x)$ which is symmetric and positive semi-definite. Clearly $u$ and $y$ denote the input and output respectively and we call this representation \emph{input-state-output} form \cite{Schaft_14}. In the following section we introduce the corresponding representations of atomic mechanical elements.




\subsection{Dynamics of physical components}\label{SS:DynamicsPhysicalComponents}
\subsubsection{Springs}
A \emph{spring} is the ideal, lossless element storing potential energy. It is connected to two bodies and is defined by a potential energy function. The energy is a function of the relative displacement of the attached bodies. Consider a spring between the two bodies $ B_i $ and $ B_j $,  with coordinate frames $ \Psi_i $ and $ \Psi_j $ fixed to the respective body. The stored potential energy is positive definite function $V_{i,j}$ of the form 
\begin{equation}\label{EQ:SpringEnergyFunction}
	V_{i,j} : SE(3) \rightarrow \mathbb{R}; \; H_i^j \mapsto V_{i,j}(H_i^j)
\end{equation}
For explicit energy functions for different types of springs see \cite{Stramigioli_01}.
The input-state-output form is defined by the relative displacement $H_i^j$ (state variable), the wrench $W_i^{j,j}$ (effort) and the twist $T_i^j$ (flow).
\begin{eqnarray}
\begin{aligned}
	&\dot{H}_i^j = T_i^{j}H_i^j\\
	&W_i^{j,j} = \frac{\partial V_{i,j}}{\partial H_i^j}(H_i^j)^T
\end{aligned}
\end{eqnarray}
Note that $ V_{i,j} $ is an energetic minimum when $ H_i^j $ is the identity matrix $I_4$. An energetic minimum is physically necessary, otherwise infinite energy would be extractable from the spring. With $ H_i^j = I_4 $ the frames $ \Psi_i $ and $\Psi_j$ coincide.
It is possible to define springs with non-zero rest-length by introducing coordinate frames $ \Psi_{ic} $ and $\Psi_{jc}$ rigidly attached to $ \Psi_i $ and $\Psi_j$ respectively. The spring is now between the new frames, thus the energetic minimum is $H_{ic}^{jc} = I_4$. The displacements $ H_i^{ic}, H_j^{jc} $ are the resulting rest-lengths. Frames $ \Psi_{ic} $ and $\Psi_{jc}$ can be chosen to represent the \emph{center of stiffness}, where translation and rotation are maximally decoupled \cite{Stramigioli_99}.


\begin{comment}
\subsubsection{Variable rest-length springs}
Varying the rest-lengths of springs in manipulator-object interaction allows to perform a grasp and specify grasping forces. The rest-length influences the energy configuration, to allow for controlled changes of rest-length an additional power port is introduced. The chosen hinge points $ \Psi_b,\Psi_j $ of the spring define an axis, known as the principal axes of stiffness. Changes of the rest-length leave this axis unaffected, i.e. the displacement is in-line. With reference to Fig. \ref{FIG:variablespring}, the change of rest-length is a change of relative displacement of $ \Psi_b $ and $\Psi_i$: $H_i^b$.
\begin{figure}[htb]
	\centering
	\includegraphics[width=0.55\textwidth]{variablespring.jpg}
	\caption[Variable rest-length spring]{Variable rest-length spring \cite{Stramigioli_99}}
	\label{FIG:variablespring}
\end{figure}
Towards a port-Hamiltonian representation we need to identify the components contributing to the deformation twist of the spring $ T_i^{j} $: the displacement twist of the bodies attached to the spring $T_b^{j} $ and the twist resulting from a commanded change of the rest-length $T_i^{b}$ \cite{Stramigioli_01c}.
\begin{equation}
	T_i^{j} = T_b^{j} + Ad_{H_b^j} T_i^{b}
\end{equation}
Since no additional energy storages were introduced, the Hamiltonian function is equal to the case of the simple spring. We can write the two-port Hamiltonian system of a variable length spring as
\begin{eqnarray}\label{EQ:variablerestlengthspring}
\begin{aligned}
	&\dot{H}_i^j =\left( \begin{pmatrix}1 & Ad_{H_b^j}\end{pmatrix} \begin{pmatrix}T_b^{j} \\ T_i^{b}\end{pmatrix} \right) H_i^j\\
	&\begin{pmatrix}W_b^{j,j} \\ W_i^{b,b}\end{pmatrix}  = \left( \begin{pmatrix}1 \\ Ad_{H_b^j}^T\end{pmatrix} \frac{\partial V_{i,j}}{\partial H_i^j} \right) (H_i^j)^T
\end{aligned}
\end{eqnarray}
\end{comment}

\subsubsection{Inertias}
Inertias are special since they in general store two types of energy: kinetic and potential energy due to gravitation. At first we exclude the gravitational terms and focus on motion. Kinetic energy is a function of the relative motion w.r.t. an inertial reference. When expressing motion in non-inertial or accelerated reference frames, fictitious forces such as the \emph{Coriolis} or the \emph{centrifugal} force need to be considered.\\
Let us start from \emph{Newton's} second law of dynamics, the time derivative of a body's momentum is equal to the applied wrench.
\begin{equation}
\dot{P}_b^0 = W_b^0
\end{equation}
The momentum of the inertia $b$ and the wrench acting on it are both expressed in the inertial reference frame $\Psi_0$. Let us consider the non-inertial frame $\Psi_b$, fixed to the inertia. We start by changing coordinates, clearly we have $W_b^0 = Ad_{H_0^b}^T W_b^b$. It is detailed in \cite{Stramigioli_01} that $P_0^b \in \mathfrak{se}^*(3)$ and thus the same transformation as for wrenches applies $P_b^0 = Ad_{H_0^b}^T P_b^b$. Expressing the \emph{Newton's} second law in the non-inertial frame $\Psi_b$ we have
\begin{equation}
\frac{d}{dt}(Ad_{H_0^b}^T P_b^b) = Ad_{H_0^b}^T W_b^b
\end{equation}
The evolution of the accelerated body frame $\Psi_b$ w.r.t to the inertial frame is time dependent. The time derivative of the transformation is $\frac{d}{dt}Ad_{H_0^b}^T = -Ad_{H_0^b}^T ad_{T_b^{b,0}}^T $, with the \emph{adjoint} representation (see for example \cite{Stramigioli_01b}):
\begin{equation}\label{EQ:adjointmapping}
ad_{T_b^{b,0}}^T = \begin{pmatrix}
-\tilde{\omega}_b^{b,0} & -\tilde{v}_b^{b,0} \\ 0 & -\tilde{\omega}_b^{b,0}\end{pmatrix}
\end{equation}
The second law of dynamics expressed in the body's frame is then
\begin{eqnarray}
\begin{aligned}
Ad_{H_0^b}^T \dot{P}_b^b -Ad_{H_0^b}^T ad_{T_b^{b,0}}^T P_b^b &= Ad_{H_0^b}^T W_b^b \\
\dot{P_b^b} &= ad_{T_b^{b,0}}^T P_b^b + W_b^b
\end{aligned} 
\end{eqnarray}
This formulation is split into its rotational and translational components, then we can exchange twist and momentum by the following operation
\begin{equation}\label{EQ:centripetaldetail}
\begin{pmatrix}
\dot{P}_{b,\omega}^b \\ \dot{P}_{b,v}^b \end{pmatrix} = \begin{pmatrix}
-\tilde{\omega}_b^{b,0} & -\tilde{v}_b^{b,0} \\ 0 & -\tilde{\omega}_b^{b,0}\end{pmatrix} \begin{pmatrix}
P_{b,\omega}^b \\ P_{b,v}^b 
\end{pmatrix} + W_b^b = \begin{pmatrix}
\tilde{P}_{b,\omega}^b & \tilde{P}_{b,v}^b \\ \tilde{P}_{b,v}^b & 0
\end{pmatrix} \begin{pmatrix}
\omega_b^{b,0} \\ v_b^{b,0}
\end{pmatrix} +W_b^b
\end{equation}
This clearly corresponds to the classical description of a rigid body's dynamics of the form
\begin{equation}
	\dot{P}_b^b = M_b \dot{T}_b^{b,0}  = C_b T_b^{b,0} + W_{b}^b
\end{equation}
Here $M_b$ describes the body's inertia and $C_b$ accounts for Coriolis and centrifugal terms.\\
Towards port-Hamiltonian representation we start from the kinetic (co-)energy given by $V_k^*(T_b^{b,0}) =\frac{1}{2}(T_b^{b,0})^T M_b T_b^{b,0}$. Formally speaking the kinetic energy is a function of the momentum. By using the relation of twist and momentum $P_b^b = M_b T_b^{b,0}$ we get the kinetic energy
\begin{equation}
V_k(P_b^b) = \frac{1}{2}(P_b^b)^T M_b^{-1} P_b^b
\end{equation}
By differentiating the kinetic energy w.r.t to the state variable $P_b^b$ we obtain 
\begin{equation}
\frac{\partial V_k(P_b^b)}{\partial P_b^b} = M_b^{-1} P_b^b = T_b^{b,0}
\end{equation}
Recall from Table \ref{TAB:PHSvar_mechanic} that the twist is the effort variable in the port-Hamiltonian representation of an inertia. The flow is the externally supplied wrench $W_b^b$, thus we obtain the port-Hamiltonian representation of a rigid body, neglecting gravity
\begin{eqnarray}\label{EQ:PHSsimpleinertia}
\begin{aligned}
	&\dot{P_b^b} = C_b \frac{\partial V_k(P_b^b)}{\partial P_b^b} + I_6 W_{b}^b \\
	&T_b^{b,0} = I_6 \frac{\partial V_k(P_b^b)}{\partial P_b^b}
\end{aligned}
\end{eqnarray}
In cooperative manipulation we often deal with heavy objects, it is thus inevitable to include the potential energy resulting from the gravitational field. One can think of a spring connecting the body and an inertial frame associated with the ground. This spring can be formulated in port-Hamiltonian structure using the left translation (\ref{EQ:lefttranslation})
\begin{eqnarray}\label{EQ:gravityspring}
\begin{aligned}
	&\dot{H}_b^0 = H_b^0 T_b^{b,0}\\
	&W_b^{b,0} = (H_b^0)^T\frac{\partial V_{g}}{\partial H_b^0}
\end{aligned}
\end{eqnarray}
Where $V_g$ is a suitable energy function. For a combined description the potential and kinetic energy add up: $V_{kg} = V_k + V_g$. Since there are two types of energy stored by \emph{one} body, the twists in both energy systems are equal. The wrenches on the body add up   
\[W_{kg}^b = W_{b}^b + C_b \frac{\partial V_{kg}}{\partial P_b^b} - (H_b^0)^T \frac{\partial V_{kg}}{\partial H_b^0} \]
Note that the negative sign in the upper equation comes from $W_b^b = - W_b^{b,0} $.\\
With this knowledge we can write the combined port-Hamiltonian representation
\begin{eqnarray} \label{EQ:PHSinertia}
\begin{aligned}
&\begin{pmatrix}\dot{H}_b^0 \\ \dot{P_b^b}\end{pmatrix} =
\begin{pmatrix} 0 & H_b^0  \\
- (H_b^0)^T & C_b\end{pmatrix}
\begin{pmatrix}\frac{\partial V_{kg}}{\partial H_b^0} \\ \frac{\partial V_{kg}}{\partial P_b^b}\end{pmatrix}+
\begin{pmatrix}0 \\ I_6\end{pmatrix} W_{b}^b \\
&T_b^{b,0} = \begin{pmatrix}0 & I_6\end{pmatrix}
\begin{pmatrix}\frac{\partial V_{kg}}{\partial H_b^0} \\ \frac{\partial V_{kg}}{\partial P_b^b}\end{pmatrix}
\end{aligned}
\end{eqnarray}


\subsubsection{Dampers}\label{SSS:Dampers}
Dampers do not have a state since they do not store energy, they only dissipate it. Note that energy is not "destroyed" in the dampers but transformed into thermal energy. This can be modelled with a thermal port connected to the environment, for reasons of simplicity we discard the generated thermal energy. The easiest way to achieve damping is a linear resistive element $R$, such that the wrench is directly proportional to twist. Consider for example a body's motion with respect to the inertial frame
\begin{equation}
	W_b^b = R T_b^{b,0}
\end{equation}
Or a damper in parallel with spring
\begin{equation}
	W_i^{j,j} = R T_i^{j}
\end{equation}
The dissipated co-energy is $E_d = \frac{1}{2}T^T R T$.


\section{Spring-mass-damper systems}\label{S:springmassdampers}
Recall the motivating example from Section \ref{S:HSdescription} of a simple spring-mass system. We can add a damper $d$ to the port-Hamiltonian representation and rewrite eq. (\ref{EQ:HSexample})
\begin{equation}
	\begin{pmatrix}\dot{q} \\ \dot{p}\end{pmatrix} =
	\begin{pmatrix}0 & 1 \\ -1 & -d\end{pmatrix}
	\begin{pmatrix}\frac{\partial V}{\partial q}(q,p) \\ \frac{\partial V}{\partial p}(q,p)\end{pmatrix} + 
	\begin{pmatrix}0 \\ 1\end{pmatrix} F_e\\  
\end{equation}
Clearly $\dot{p} = -\frac{\partial V}{\partial q}(q,p)-d\frac{\partial V}{\partial p}(q,p)+F_e$ equals the mechanical impedance relation $m\ddot{x} + d\dot{x} +kx = F_e$. Thus we have a port-Hamiltonian representation of the impedance control scheme. This is the basis for the control architecture presented below. Therefore the mass-spring-damper system, given as a one-dimensional example, is formulated in the $SE(3)$. We start from eqs. (\ref{EQ:PHSsimpleinertia},\ref{EQ:gravityspring}) and add another spring to the body associated with $\Psi_b$. This spring connects to a desired object position assigned to $\Psi_v$. Its port-Hamiltonian representation is given by
\begin{eqnarray}
\begin{aligned}
	&\dot{H}_b^v = H_b^v T_b^{b,v}\\
	&W_b^{b,v} = (H_b^v)^T\frac{\partial V_{s}}{\partial H_b^v}
\end{aligned}
\end{eqnarray}
The spring's deformation twist is decomposed by $T_b^{b,v} = T_b^{b,0} - T_v^{b,0}$.
The damping along this spring is $W_b^b = D_b T_b^{b,v} $. Body, spring and damper move uniformly with the twist $T_b^{b,0}$ and the wrenches add up. Combing all components we arrive at
\begin{eqnarray} \label{EQ:externalimpedance}
\begin{aligned}
&\begin{pmatrix}\dot{H}_b^0 \\ \dot{H}_b^v \\  \dot{P_b^b}\end{pmatrix} =
\begin{pmatrix} 0 & 0 & H_b^0  \\ 0 & 0 & H_b^v \\
- (H_b^0)^T & -(H_b^v)^T & C_b-D_b\end{pmatrix}
\begin{pmatrix}\frac{\partial V_{kgs}}{\partial H_b^0}\\ \frac{\partial V_{kgs}}{\partial H_b^v} \\ \frac{\partial V_{kgs}}{\partial P_b^b}\end{pmatrix}+
\begin{pmatrix} 0 & 0\\ -H_b^v Ad_{H_0^b} & 0 \\ D_b Ad_{H_0^b} & I_6 \end{pmatrix}\begin{pmatrix} T_v^0 \\ W_{b}^b\end{pmatrix} \\
&\begin{pmatrix}W_v^{0,0} \\ T_b^{b,0}\end{pmatrix} = \begin{pmatrix}0 & -Ad_{H_0^b}^T (H_b^v)^T & Ad_{H_0^b}^T D_b\\ 0 & 0 & I_6 \end{pmatrix}
\begin{pmatrix}\frac{\partial V_{kgs}}{\partial H_b^0}\\ \frac{\partial V_{kgs}}{\partial H_b^v} \\ \frac{\partial V_{kgs}}{\partial P_b^b}\end{pmatrix}
\end{aligned}
\end{eqnarray}
In a cooperative manipulation set-up this clearly accounts for an \emph{external} impedance relation, used to establish compliant behaviour between (virtual) object and environment. Analogously we can define impedance relations between manipulators and virtual object. To this purpose we define a manipulator inertia and connect to the object with a spring and a damper. Here we consider the manipulator masses to be gravity pre-compensated and omit the spring connecting to the ground. The $i$-th manipulator inertia is given by
\begin{eqnarray}
\begin{aligned}
	&\dot{P_i^i} = C_i \frac{\partial V_{k(i)}(P_i^i)}{\partial P_i^i} + I_6 W_{i}^i \\
	&T_i^{i,0} = I_6 \frac{\partial V_{k(i)}(P_i^i)}{\partial P_i^i}
\end{aligned}
\end{eqnarray}
It is important that the spring connecting $b$ and $i$ does not connect to the center of the object $b$ but to a point $b(i)$ on the surface of $b$. Clearly the distance $p_{b(i)}^b$ corresponds to the extent of the object. The spring's twist decomposes as follows
\begin{equation}
T_{b(i)}^i = T_b^i + T_{b(i)}^{i,b} = Ad_{H_b^i} T_b^{b,0} - T_i^{i,0} + Ad_{H_b^i}\underbrace{T_{b(i)}^b}_{=0}
\end{equation}
The spring is given by    
\begin{eqnarray}
\begin{aligned}
&\dot{H}_{b(i)}^i = H_{b(i)}^i \begin{pmatrix}
Ad_{H_b^{b(i)}} & - Ad_{H_i^{b(i)}} \end{pmatrix} \begin{pmatrix} 
T_b^{b,0} \\ T_i^{i,0}\end{pmatrix}\\
&\begin{pmatrix} 
W_b^{b,0} \\ W_i^{i,0} \end{pmatrix} = \begin{pmatrix}
Ad_{H_b^{b(i)}}^T \\ - Ad_{H_i^{b(i)}}^T\end{pmatrix}
(H_{b(i)}^i)^T
\frac{\partial V_{s(i)}}{\partial H_{b(i)}^i}
\end{aligned}
\end{eqnarray}
and the damper along the spring exerts a wrench on the body $i$
\begin{equation}
W_i^i = D_i T_i^{i,b} = D_i T_i^{i,0} - D_i Ad_{H_b^i} T_b^{b,0}.
\end{equation}
We can combine spring, inertia and damper, the twist $T_i^{i,0}$ is the common quantity.
\begin{eqnarray}\label{EQ:internalimpedance}
\begin{aligned}
\begin{pmatrix}\dot{H}_{b(i)}^i \\ 
\dot{P_i^i} \end{pmatrix} &= \begin{pmatrix}
0 & -H_{b(i)}^i Ad_{H_i^{b(i)}} \\
Ad_{H_i^{b(i)}}^T (H_{b(i)}^i)^T & C_i - D_i
\end{pmatrix}
\begin{pmatrix}
\frac{\partial V_{ks(i)}}{\partial H_{b(i)}^i} \\ 
\frac{\partial V_{ks(i)}}{\partial P_{i}^i}
\end{pmatrix} + \\ &+
\begin{pmatrix}
H_{b(i)}^i Ad_{H_b^{b(i)}} & 0 \\
D_i Ad_{H_b^i} & I_6
\end{pmatrix}
\begin{pmatrix}
T_b^{b,0} \\ W_i^i
\end{pmatrix}
 \\
\begin{pmatrix}
W_b^{b,0} \\ T_i^{i,0}
\end{pmatrix} &= 
\begin{pmatrix}
Ad_{H_b^{b(i)}}^T (H_{b(i)}^i)^T &  Ad_{H_b^i}^T D_i^T \\
 0 & I_6
\end{pmatrix}
\begin{pmatrix}
\frac{\partial V_{ks(i)}}{\partial H_{b(i)}^i} \\ 
\frac{\partial V_{ks(i)}}{\partial P_{i}^i}
\end{pmatrix}
\end{aligned}
\end{eqnarray}


\section{Imposing constraints}\label{S:ImposingConstraints}
The interconnection of a spring and an inertia is the the ideal pair in terms of input-output causality. The spring expects a twist-input and outputs a wrench. The inertia has a wrench-input and outputs a twist. It can be seen from eq. (\ref{EQ:PHSinertia}) that the interconnection of inertia and spring gives a set of ordinary differential equations (ODE). Many mechanical systems cannot be modelled by an interconnection of springs and masses. The prime example is the contact of two rigid objects, rigid means there is no elastic deformation which could be modelled by a spring (for an extensive treatment of hard and soft contact see \cite{Duindam_09}). Rigidly connected objects cannot move with respect to each other, i.e. they move with the same velocity. In cooperative manipulation we often assume the manipulators rigidly connected to the common object. The attempt to  move the bodies individually results in \emph{internal} forces. We call a force internal if it produces no \emph{virtual work} with the system's velocity (see \cite{Erhart_16} for a formal definition). The motion-limiting conditions are called kinematic \emph{constraints} and are expressed in the form
\begin{equation}
A^T(q)\dot{q}=0
\end{equation}
We call $A(q)$ the \emph{constraint} matrix and start from the Euler-Lagrange equations of constrained motion \cite{duindam2009geoplexbook}
\begin{eqnarray}
\begin{aligned}
\frac{d}{dt}\left(\dfrac{\partial \mathcal{L}}{\dot{q}}\right) - \frac{\partial \mathcal{L}}{\partial q} &= g(q)f + A(q)\lambda
\\
A^T(q)\dot{q} &= 0
\end{aligned}
\end{eqnarray}
The associated constraint forces are given by $A(q)\lambda$, where we call $\lambda$ the \emph{Lagrange} multipliers. They are uniquely determined if the constraints are satisfied, i.e. are given by the requirement $A^T(q)\dot{q}=0$. In this case the constraint forces do not influence the energy of the system since $\lambda^T (A^T(q)\dot{q}) = 0$, this corresponds to the requirement of a zero virtual work for internal forces. Similarly to Section \ref{S:HSdescription}, the Euler-Lagrange equations can be transformed to a port-Hamiltonian equivalent, which is a mixed set of differential and algebraic equations (DAE).
\begin{eqnarray}\label{EQ:PHSpconstrained}
\begin{aligned}
\begin{pmatrix}
\dot{q} \\ \dot{p} \end{pmatrix} &= 
\begin{pmatrix} 0 & I \\ -I & 0\end{pmatrix}
\begin{pmatrix}
\frac{\partial V}{\partial q} \\ \frac{\partial V}{\partial p}\end{pmatrix}
+ \begin{pmatrix}0 & 0 \\ A(q) & g(q)\end{pmatrix}
\begin{pmatrix}\lambda \\ f\end{pmatrix}
\\
\begin{pmatrix}0 \\ e\end{pmatrix} &=
\begin{pmatrix}0 & A^T(q) \\ 0 & g^T(q)\end{pmatrix}
\begin{pmatrix}
\frac{\partial V}{\partial p} \\ \frac{\partial V}{\partial p}\end{pmatrix}
\end{aligned}
\end{eqnarray}
The system is no longer described in the input-state-output form, but in an implicit form. Several approaches to solve the algebraic equations and restore the desired input-state-output form exist. Most of them are designed for generalized configuration $q$ and momentum $p$ coordinates, see e.g. \cite{Schaft_13},\cite{Duindam_09}. Due to non-linearity of $\dot{q}=\frac{\partial V}{\partial p}$ in mechanical systems not all are feasible for six dimensional systems. \\
The following method (described e.g. in \cite{Duindam_09}) uses the time-derivative of the constraints
\begin{equation}\label{EQ:constraintderivative}
0 = \frac{d}{dt}\left(A^T(q)\frac{\partial V}{\partial p}\right)
\end{equation}
We use the property $\frac{\partial V}{\partial p}=M^{-1}p$ for an energy function of the form $V = \frac{1}{2}p^TM^{-1}p + V_q$. Since $q(t)$ is time-dependent \emph{indirect dependencies} arise in $A(q),p(q)$ when calculating the total time-derivative
\begin{eqnarray}
\begin{aligned}
0 &= \frac{d}{dt}(A^TM^{-1}p) = \frac{\partial (A^TM^{-1}p)}{\partial q}\dot{q} + A^TM^{-1}\dot{p} = \\ &= \frac{\partial (A^TM^{-1}p)}{\partial q}M^{-1}p + A^TM^{-1}\left(-\frac{\partial V}{\partial q}+A(q)\lambda +g(q)f\right)
\end{aligned}
\end{eqnarray}
Solving this equation for $\lambda$ gives an analytic expression for the constrained forces
\begin{equation}
\lambda = (A^T M^{-1} A)^{-1} \left(-\frac{\partial (A^TM^{-1}p)}{\partial q}M^{-1}p + \frac{\partial V}{\partial q} - gf\right)
\end{equation}
Then $\lambda$ is re-inserted into eq. (\ref{EQ:PHSpconstrained}) and we obtain a set of ODEs in input-output form. Clearly the term $A(q)\lambda$ generates compensation forces that oppose relative motions of the bodies and keep the constraints $A^T(q)\dot{q}$ fulfilled. Since we computed the constraint forces starting from the time-derivative of the constraint, $A^T(q)\dot{q}$ stays constant. To guarantee $A^T(q)\dot{q}=0$, this must be already fulfilled in the beginning.
%Another approach is to find new coordinates for the momentum that limit the \emph{phase space} $(q,p)$ to motions fulfilling the constraints. Therefore we introduce the transformation
%\begin{equation}
%p = S(q)\bar{p}
%\end{equation}
%The definition of $S(q)$ is directly given by the constraint 
%\begin{equation}
%0 = A^T(q) M^{-1} p = A^T(q) M^{-1} S(q) \bar{p}
%\end{equation}
%S(q) is thus the \emph{kernel} of $A^T(q) M^{-1}$. The transformation is energy-conservative i.e.
%\begin{equation}
%\bar{V}(q,\bar{p}) := \frac{1}{2}\bar{p}^T\bar{M}^{-1}\bar{p} + V_q = \frac{1}{2}p^TM^{-1}p + V_q = V(q,p)
%\end{equation}
%Thus the constrained inertia matrix is $\bar{M} = (S^TM^{-1}S)^{-1}$.   
%We start re-writing eq. (\ref{EQ:PHSpconstrained}) using $p = S(q)\bar{p}$ and obtain
%\begin{eqnarray}
%\begin{aligned}
%\dot{q} &= \frac{\partial V}{\partial p} = M^{-1}p = M^{-1}S\bar{p} = M^{-1}S\bar{M}\bar{M}^{-1}\bar{p} = M^{-1}S\bar{M}\frac{\partial \bar{V}}{\partial \bar{p}}\\
%\dot{p} &= \frac{d}{dt}(S(q)\bar{p}) = \frac{\partial(S\bar{p})}{\partial q} \dot{q} +S\dot{\bar{p}} = -\frac{\partial V}{\partial q} + A\lambda + gf
%\end{aligned}
%\end{eqnarray}
%Towards a standard port-Hamiltonian representation we are seeking to express the last equation in the form $\dot{\bar{p}} = ...$. Therefore the equation is pre-multiplied with $\bar{M}S^TM^{-1}$
%\begin{eqnarray}\label{EQ:PHSconstrainedpremult}
%\begin{aligned}
%\bar{M}S^TM^{-1}\frac{\partial(S\bar{p})}{\partial q} \dot{q} + \bar{M}\underbrace{S^TM^{-1}S}_{\bar{M}^{-1}}\dot{\bar{p}} = \bar{M}S^TM^{-1}\left(-\frac{\partial V}{\partial q} + A\lambda + gf\right)
%\end{aligned}
%\end{eqnarray}
%For a symmetric $M$ we have $(S^TM^{-1}A)^T = A^T(q) M^{-1} S(q) = 0$. Since $S(q)$ is dependent on $q$ we need to consider indirect dependencies when differentiating 
%\begin{equation}
%\frac{\partial \bar{V}}{\partial q} = \frac{\partial V}{\partial q} + \frac{\partial^T (S(q) \bar{p})}{\partial q}\dot{q} = \frac{\partial V}{\partial q} + \frac{\partial^T (S(q) \bar{p})}{\partial q}M^{-1}S\bar{M}\frac{\partial \bar{V}}{\partial \bar{p}}
%\end{equation}
%Inserting this into eq. (\ref{EQ:PHSconstrainedpremult}) and re-arranging we desired port-Hamiltonian representation
%\begin{eqnarray}
%\begin{aligned}
%\begin{pmatrix}
%\dot{q} \\ \dot{\bar{p}}
%\end{pmatrix} &= 
%\begin{pmatrix}
%0 & M^{-1}S\bar{M} \\
%\bar{M}S^TM^{-1} & \bar{M}S^TM^{-1}\left(\frac{\partial^T (S(q) \bar{p})}{\partial q} - \frac{\partial (S(q) \bar{p})}{\partial q}\right)M^{-1}S\bar{M}
%\end{pmatrix}
%\begin{pmatrix}
%\frac{\partial \bar{V}}{\partial q} \\
%\frac{\partial \bar{V}}{\partial \bar{p}}
%\end{pmatrix} + \\
%&+ 
%\begin{pmatrix}
%0 \\ \bar{M}S^TM^{-1}
%\end{pmatrix}f
%\end{aligned}
%\end{eqnarray}
%Conclusively we have obtained two different representations of constrained systems in input-output form. The first one allows explicitly to calculate the constraint forces necessary to comply with the constraints. The second one restricts the possible motion and results in a system of reduced \emph{degrees of freedom}. We see in the remainder that the first can be exploited for control issues. 


\subsubsection{Constraints for 6D-motion}  


Consider two rigidly connected bodies, associated with the frames $\Psi_b$ and $\Psi_i$ and a distance between them $p_i^b = p_i^0 - p_b^0$. Clearly, in the setting of cooperative manipulation, one can think of an object $b$ and the $i$-th manipulator attached to it. Now let the body $b$ rotate with the angular velocity $\omega_b^0$. Being rigidly attached the body $i$ rotates in the same manner, $\omega_i^0 = \omega_b^0$. The translational velocity of body $i$ is expressed dependent on body $b$ by 
\begin{eqnarray}
\begin{aligned}
&\dot{p}_i^0 = \dot{p}_b^0 + \omega_b^0 \times p_i^b = \dot{p}_b^0 + \omega_b^0 \times (p_i^0-p_b^0) \\
&\dot{p}_i^0 - \omega_b^0 \times p_i^0 = \dot{p}_b^0 - \omega_b^0 \times p_b^0 \\
\end{aligned}
\end{eqnarray}
Recall the definition of the linear velocity component of a twist from eq. (\ref{EQ:twistdecomposition}) being $v_i^j= \dot{p}_i^j - \omega_i^j \times p_i^j$. Thus we have $v_i^0 = v_b^0$ and consequently $T_i^0 = T_b^0$. For a system of $i=1...N$ manipulators we write the constraints
\begin{equation}
0 = A^T T = \begin{pmatrix}
-I_3 & 0_3 & I_3 & 0_3 & & & \\
0_3 & -I_3 & 0_3 & I_3 & & & \\
\vdots & \vdots & & & \ddots & & & \\
- I_3 & 0_3 & & & & I_3 & 0_3 \\
0_3 & -I_3 & & & & 0_3 & I_3 
\end{pmatrix}
\begin{pmatrix}
T_b^0 \\ T_1^0 \\ \vdots \\ T_N^0
\end{pmatrix}
\end{equation}
We start by differentiating the constraints, here $A$ is not time or configuration dependent, thus $0=A^T\dot{T}$. Consider the simple example of two rigidly connected bodies $b$ and $i$, the constraint equation is
\begin{eqnarray}
\begin{aligned}
0 &= \dot{T}_i^0 - \dot{T}_b^0 = \begin{pmatrix}
\dot{\omega}_i^0 - \dot{\omega}_b^0 \\ \dot{v}_i^0 - \dot{v}_b^0
\end{pmatrix} =
\begin{pmatrix}
\dot{\omega}_i^0 - \dot{\omega}_b^0 \\ \frac{d}{dt}(\dot{p}_i^0 - \omega_b^0 \times p_i^0) - \frac{d}{dt}(\dot{p}_b^0 - \omega_b^0 \times p_b^0)
\end{pmatrix}= 
%\\ &=
%\begin{pmatrix}
%\dot{\omega}_i^0 - \dot{\omega}_b^0 \\
%\ddot{p_i^0} - \dot{\omega}_b^0 \times p_i^0 - \omega_b^0 \times (\omega_b^0 \times p_i^0) - \ddot{p_b^0} + \dot{\omega}_b^0 \times p_b^0 - \omega_b^0 \times (\omega_b^0 \times p_b^0) 
%\end{pmatrix} =
\\ &=
\begin{pmatrix}
\dot{\omega}_i^0 - \dot{\omega}_b^0 \\
\ddot{p}_i^0 - \ddot{p}_b^0 - \dot{\omega}_b^0 \times p_i^b - \omega_b^0 \times (\omega_b^0 \times p_i^b)
\end{pmatrix}
\end{aligned}
\end{eqnarray}
Kinematic constraints are expressed very compactly in the twist notation. Second-order dynamics including \emph{centripetal} terms are inherent and equivalent to classic representations (see e.g.\cite{Erhart_16}).\\

Towards solving the set of port-Hamiltonian DAEs, recall from eq. (\ref{EQ:PHSpconstrained}) that $0=A^T\frac{\partial V}{\partial p}$. At this point it is necessary to distinguish different twist representations, e.g. $\frac{\partial V}{\partial P_b^b} = T_b^{b,0} = Ad_{H_0^b}T_b^0 $. Continuing the two mass example we re-write the constraints
\begin{equation}
0 = A^T \begin{pmatrix}T_b^0 \\ T_i^0 \end{pmatrix}
 = \underbrace{A^T \begin{pmatrix}
Ad_{H_b^0} & 0 \\ 0 & Ad_{H_i^0}\end{pmatrix}}_{\bar{A}^T}
\begin{pmatrix}
T_b^{b,0} \\ T_i^{i,0}\end{pmatrix} = A^T \begin{pmatrix}
Ad_{H_b^0} & 0 \\ 0 & Ad_{H_i^0}\end{pmatrix}
\begin{pmatrix}
\frac{\partial V}{\partial P_b^b} \\
\frac{\partial V}{\partial P_i^i}
\end{pmatrix}
\end{equation}
Replacing the twists with momenta $T = M^{-1}P$ and differentiating w.r.t to time leads to
\begin{equation}
0 = \bar{A}^T\begin{pmatrix}M_b^{-1} & 0 \\ 0 & M_i^{-1}\end{pmatrix} \begin{pmatrix}\dot{P_b^b} \\ \dot{P_i^i}\end{pmatrix}
 +
\bar{A}^T \begin{pmatrix}ad_{T_b^{b,0}} & 0 \\
0 & ad_{T_i^{i,0}}\end{pmatrix}\begin{pmatrix}M_b^{-1} & 0 \\ 0 & M_i^{-1}\end{pmatrix} \begin{pmatrix}P_b^b \\ P_i^i\end{pmatrix}
\end{equation}
Consider now the last part of this equation and recall the adjoint representation $ad_T$ from eq. (\ref{EQ:adjointmapping}). We obtain for body $b$
\begin{equation}
ad_{T_b^{b,0}}M_b^{-1}P_b^b = \begin{pmatrix}
\tilde{\omega}_b^{b,0} & 0 \\ \tilde{v}_b^{b,0} & \tilde{\omega}_b^{b,0}\end{pmatrix} \begin{pmatrix}\omega_b^{b,0} \\ v_b^{b,0}\end{pmatrix} = 0
\end{equation}
Here we assume that the inertias are not configuration dependent, i.e. not time-dependent. Now we insert the port-Hamiltonian system equation for $\dot{P}$ and obtain
\begin{eqnarray}
\begin{aligned}
0 = \bar{A}^T M^{-1} \dot{P} = \bar{A}^T M^{-1}(W+CT+\bar{A}\lambda)
\end{aligned}
\end{eqnarray}
and solve for $\lambda$
\begin{equation}
\lambda = -(\bar{A}^TM^{-1}\bar{A})^{-1}\bar{A}^TM^{-1}(W+CT)
\end{equation}
Consider again the example of two rigidly connected bodies $b$ and $i$. Let us first examine the part $\bar{A}^TM^{-1}CT$. Using eq. (\ref{EQ:centripetaldetail}) and assuming that the bodies share the orientation $R_0^b = R_0^i$, we obtain
\begin{eqnarray}
\begin{aligned}
\bar{A}^TM^{-1}\begin{pmatrix}
C_b T_b^{b,0} \\ C_i T_i^{i,0}
\end{pmatrix} 
&=
\bar{A}^T M^{-1} \begin{pmatrix} 0 \\ m_b \tilde{v}_b^{b,0}\omega_b^{b,0} \\ 0 \\ m_i \tilde{v}_i^{i,0}\omega_b^{b,0}
\end{pmatrix}
=
\begin{pmatrix}-I_6 & I_6\end{pmatrix} \begin{pmatrix}
0 \\ R_b^0 \tilde{v}_b^{b,0} \omega_b^{b,0} \\ 0 \\
R_b^0 \tilde{v}_i^{i,0} \omega_b^{b,0}
\end{pmatrix} = \\ 
=&
\begin{pmatrix}
0 \\ R_b^0\tilde{\omega}_b^{b,0}
(\tilde{p}_0^b R_b^0 \omega_b^0 + R_0^b v_b^0 - \tilde{p}_0^i R_0^b \omega_b^0 - R_0^b v_i^0)
\end{pmatrix} 
=
\begin{pmatrix}0 \\
R_b^0\tilde{\omega}_b^{b,0}
\tilde{p}_i^b \omega_b^{b,0}
\end{pmatrix} 
\end{aligned}
\end{eqnarray}
This example shows how kinematic constraints can be solved by calculating the constraint forces. The results are equivalent to approaches based on the \emph{Gauss' principle of least constraint} (\cite{Erhart_16}) or \emph{Euler-Lagrange} representations (\cite{Liu_02}).\\
%The other fore-mentioned approach of restricting the possible motion starts with finding a matrix $S$ fulfilling $0 = A^TM^{-1}S \bar{P}$ for every $\bar{P}$. Thus we require $0 = A^TM^{-1}S$. Consider the example of two rigidly connected bodies $b$ and $i$, we can write the constraint equation
%\begin{equation}
%0 = A^T\begin{pmatrix}
%T_b^0 \\ T_i^0\end{pmatrix} = A^T \begin{pmatrix}
%Ad_{H_b^0} & 0 \\ 0 & Ad_{H_i^0}\end{pmatrix}
%\begin{pmatrix}
%M_b^{-1} & 0 \\ 0 & M_i^{-1} 
%\end{pmatrix}
%\begin{pmatrix}
%P_b^{b} \\ P_i^{i}
%\end{pmatrix}
%\end{equation}
%Now we introduce the transformation $P = S\bar{P}$.
%In an object-centred cooperative manipualtion case $\bar{P}$ clearly corresponds to the twist of the common object. Starting from $T_i^0 = T_b^0$ towards $T_i^{i,0} = Ad_{H_b^i} T_b^{b,0}$ we find 
%\begin{equation}
%S = \begin{pmatrix}
%I_3 & 0 \\
%0 & I_3 \\
%j_ij_b^{-1} & 0\\
%m_i\tilde{p}_b^i j_b^{-1}& m_im_b^{-1} 
%\end{pmatrix}
%\end{equation}


 


%\begin{equation}
%W = \begin{pmatrix}
%m \\ f \end{pmatrix} =  \begin{pmatrix}r \times f + \tau \\ f\end{pmatrix}
%\end{equation}
%Consider the example of two constrained bodies $b$ and $i$, we examine the first part of the constraint $A^TM^{-1}W$. Furthermore assume that the applied forces satisfy the constraints $M_b^{-1}W_b^0 = M_i^{-1}W_i^0$. Taking the screw representation into account one obtains
%\begin{equation}
%0 = \begin{pmatrix}
%j_i^{-1} & 0 \\ 0 & m_i^{-1}
%\end{pmatrix}\begin{pmatrix}r_i^0 \times f_i^0 + \tau_i^0 \\ f_i^0\end{pmatrix}  - \begin{pmatrix}
%j_b^{-1} & 0 \\ 0 & m_b^{-1}
%\end{pmatrix} \begin{pmatrix}r_b^0 \times f_b^0 + \tau_b^0 \\ f_b^0\end{pmatrix} 
%\end{equation}
 

%Consider the simple example of two masses $m_1,m_2$ rigidly connected with distance $c$.
%The configuration coordinates are thus $q_1 = q_2 + c$, time-derivation gives the constraint equation
%
%\begin{equation}
% 0 = \dot{q}_1 - \dot{q}_2 = \frac{\partial V}{\partial p_1} - \frac{\partial V}{\partial p_2} = \underbrace{(1 \; -1)}_{A(q)^T} \begin{pmatrix}
%\frac{\partial V}{\partial p_1} \\ \frac{\partial V}{\partial p_2}
%\end{pmatrix} \end{equation}
%
%The unconstrained pHs is given according to equation (\ref{EQ:generalPHS})
%\[\begin{pmatrix}\dot{q_1} \\ \dot{q_2}\end{pmatrix} = \begin{pmatrix}
%\frac{\partial V}{\partial p_1} \\ \frac{\partial V}{\partial p_2}
%\end{pmatrix} \]
%\[\begin{pmatrix}\dot{p_1} \\ \dot{p_2}\end{pmatrix} = -\begin{pmatrix}
%\frac{\partial V}{\partial q_1} \\ \frac{\partial V}{\partial q_2}
%\end{pmatrix}  + \begin{pmatrix}g_1(q) & 0 \\ 0 & g_2(q)\end{pmatrix} \begin{pmatrix}f_1 \\ f_2\end{pmatrix}
%\]
%%\[e = g(q)^T \frac{\partial H}{\partial p}\]
%The configuration coordinates are thus $q_1 = q_2 + c$, time derivation gives $\dot{q_1}=\dot{q_2}$.
%This \emph{kinematic} constraint can be written with respect to the pHs-formulation
%
%The interaction forces that arise due to the constraints can be described using the \emph{Lagrange} multiplier $\lambda$ (see \cite{Schaft_13} for details). The general representation of constrained pHs is thus given by
%
%This description is a mixed set of differential and algebraic equations (DAE). The algebraic constraints can be solved and the Lagrange multiplier be eliminated by multiplying equation (\ref{EQ:PHSpconstrained}) with a suitable matrix $S(q)$ subject to $A^T(q)S(q) = 0$. Therefore $S(q)$ can be chosen to be the \emph{kernel} of $A^T(q)$: $S(q) = ker \, A^T$.
%The resulting equation is
%\[S^T(q)\dot{p} = -S^T(q)\frac{\partial V}{\partial q} +S^T(q)g(q)f \]
%Following \cite{Schaft_13} we can introduce a a coordinate transformation 
%\begin{equation}\label{EQ:cooordtransmom}p \mapsto \bar{p}: \bar{p} = S^T(q)p \end{equation}
%The transformed equation is obtained as
%\[\dot{\bar{p}} = -S^T(q)\frac{\partial \bar{V}}{\partial q} -p^T [S_i,S_j]_{i,j} \frac{\partial \bar{V}}{\partial \bar{p}} + \bar{g}(q)f \]
%Where the Hamiltonian $\bar{V} = \frac{1}{2}\bar{p}^T\bar{M}^{-1}(q)\bar{p}$ is also expressed in transformed coordinates, the same is done with the input matrix $\bar{g}(q)$. $ [S_i,S_j] $ is the \emph{Lie bracket} of the $i$ and $j$-th column of $S$:
%\[[S_i,S_j] = \frac{\partial S_j}{\partial q}S_i - \frac{\partial S_i}{\partial q}S_j\] The output equation finally becomes 
%\[ \bar{e} = \bar{g}^T(q) \frac{\partial \bar{V}}{\partial \bar{p}} \]


%\subsubsection{Constraints on rigid bodies}
%Consider a group of rigidly connected bodies, in the center of the group the \emph{virtual object} associated with the coordinate frame $\Psi_v$. The bodies surrounding it share the same orientation and the position of the $i$-th body is 
%\[p_i^0 = p_v^0 + R_v^0 p_i^v\]
%By differentiating the \emph{geometric} constraints we obtain the \emph{kinematic} constraints
%\[\dot{p}_i^0 = \dot{p}_v^0 + \omega_v \times p_i^v\]
%\[\omega_i = \omega_v\]
%We can reformulate these equations in matrix vector notation and $i=1...N$
%\begin{equation}
%\underbrace{\begin{pmatrix}
%-I_3 & 0_3 & I_3 & 0_3 &  &  &  \\
%\tilde{p_1^v} & -I_3 & 0_3 & I_3 & \cdots & 0_3 & 0_3 \\ \vdots & \vdots \ & & & \ddots &  &  \\
%-I_3 & 0_3 & & & & I_3 & I_3 \\
%\tilde{p_N^v} & -I_3 & & & & 0_3 & I_3
%\end{pmatrix}}_{A^T(q)}
%\underbrace{\begin{pmatrix}
%\omega_v \\ \dot{p}_v^0 \\ \omega_1 \\ \dot{p}_1^0 \\ \vdots \\ \omega_N \\ \dot{p}_N^0
%\end{pmatrix}}_{\dot{q}} = 0
%\end{equation}
%In order to eliminate the constraint forces from equation (\ref{EQ:PHSpconstrained}) we require the \emph{kernel} of $A^T(q)$, given by
%\[S(q) = ker \, A^T = \begin{pmatrix}
%I_3 & 0_3 \\
%0_3 & I_3 \\
%I_3 & 0_3 \\
%-\tilde{p}_1^v & I_3 \\
%\vdots & \vdots \\
%I_3 & 0_3 \\
%-\tilde{p}_N^v& I_3 \\
%\end{pmatrix}\]
%This allows to employ the coordinate transformation (\ref{EQ:cooordtransmom}) and obtain the constrained momentum. Choosing a representation of the form $\bar{p} = \bar{M}\dot{q} $ is advantageous when deriving the transformed \emph{Hamiltonian}
%\[\bar{p} = \begin{pmatrix}
%j_v+\sum_{i=1}^N [j_i - m_i(\tilde{p}_i^v)^2] & -\sum_{i=1}^N m_i\tilde{p}_i^v \\ \sum_{i=1}^N m_i\tilde{p}_i^v & m_v + \sum_{i=1}^N m_i
%\end{pmatrix}  \begin{pmatrix}
%\omega_v \\ \dot{p}_v^0
%\end{pmatrix} \]
%Note that $\bar{M}$ is symmetric, this is due to the skew-symmetry of $ \tilde{p}_i^v $.
%Thus the \emph{Hamiltonian} is obtained as usual by $\bar{V} =  \frac{1}{2}\bar{p}^T\bar{M}^{-1}\bar{p}$.
%One can compute that $\frac{\partial S_i}{\partial q} = 0 \; \forall i=1...N$, thus the \emph{Lie bracket} $[S_i,S_j]$ equals zero.\\
%The external wrenches acting on the free bodies sum up for the constrained system, respecting the geometric requirements we obtain
%\[ \bar{g} = \begin{pmatrix}
%I_3 & 0_3 & I_3 & \tilde{p}_1^v & \cdots & I_3 & \tilde{p}_N^v \\0_3 & I_3 & 0_3 & I_3 & \cdots & 0_3 & I_3
%\end{pmatrix} \]
%Towards the port-Hamiltonian representation of the constrained system we seek to replace the term $ \frac{\partial \bar{V}}{\partial q} $ by $ \frac{\partial \bar{V}}{\partial \bar{p}} $. The kinetic co-energy of the system is $\bar{V}^* =\frac{1}{2} \dot{q}^T \bar{M} \dot{q}$.

\section{Model-based controllers for cooperative manipulation}\label{S:modelbasedcontrol}
In this section we present two model-based control schemes based on the \emph{Intrinsically Passive Controller} (IPC) paradigm introduced by Stramigioli \cite{Stramigioli_01}. Intrinsically passive control exhibits the advantages of a physical fundament, \emph{passivity} and stability during contact and non-contact transitions. 
The controller design mimics an impedance controlled cooperative manipulation set-up, i.e. the controller has the structure of robots manipulating a common object, see figure \ref{FIG:modelbasedcontrol} for an overview. The apparent control commands are obtained from a simulation of the real system dynamics. In this \emph{virtual} set-up the common object and the manipulators are simple inertias. The manipulators are connected to the object by springs and dampers, i.e. the connection is compliant, leading to stability during contact and non-contact transitions. It is important to notice that the IPC is no more than a geometric interconnection of mechanic elements in a virtual domain.\\
 The scheme is object-centred, i.e. the user controls the object explicitly and the controller generates appropriate commands for the robotic system. \emph{Explicit} refers to a direct connection between the user (i.e. the reference trajectory given by the user) and the virtual object, established by a spring and a damper. On the other side the controller is connected to the real robotic set-up by issuing either trajectory (subsection \ref{SS:referencetrajectoryDIPC}) or force commands (subsection \ref{SS:constrainedDIPC}) to the manipulators. The respective dual quantity serves as an input for the controller. Conclusively the controller is a virtual system model that generates control outputs by simulating the virtual dynamics and receives feedback with the dual of the commanded quantity.\\
Every connection either between the sub-elements inside the controller or the external ones (user-IPC, IPC-robots) are described by effort-flow pairs, i.e. power ports. From an energetic point of view the interconnection is lossless (see subsection \ref{SS:PHSinterconnection}) and the elements are passive, this motivates the term \emph{intrinsic passivity}. By definition a passive controller cannot generate energy, thus energy must be provided from outside, either by the user or by the robotic system, through the power ports. 
\begin{figure}[b]
	\centering
	\small
	\def\svgwidth{0.99\columnwidth}
	\input{modellbasedcontrol.eps_tex}
	\caption{Overall set-up}
	\label{FIG:modelbasedcontrol}
\end{figure}
Stramigioli's original IPC scheme \cite{Stramigioli_01} does not incorporate the inertias of the manipulators, nor damping along the manipulator springs, in the controller. A cooperative manipulation problem demands good dynamic response and low squeezing forces on the common object, these requirements are met by completing the model with inertias and dampers. The manipulator inertias can be added to the controller in (at least) two ways, leading to the two schemes presented below.   

\subsection{Compliant trajectory generating IPC}\label{SS:referencetrajectoryDIPC}
Starting from the mechanical impedance equations derived in subsection \ref{S:springmassdampers}, a controller based on the structure of the cooperative manipulation set-up is designed. The starting point is the impedance equation (\ref{EQ:externalimpedance}) accounting for the relation between object and reference trajectory. The inertia $M_b$ represents the common object, spring and damper establish a relation between desired and \emph{actual} object twist. In this context the actual twist is the twist of the modelled object (no object tracking information from the real set-up is used). Analogously to a real cooperative manipulation set-up, the $i$-manipulators connect to the virtual object. In the controller these connections are compliant (not rigid), i.e. springs are between object and manipulators. The manipulator-object impedance equation (\ref{EQ:internalimpedance}) defines the springs, mass and dampers of the modelled manipulators. One spring hinge-point is connected to the surface of the object, the other hinge point is connected to the impedance relation's inertia  $M_i$, which clearly represents the $i$-th manipulator's body. In summary a simple geometric interconnection of the impedance equations (\ref{EQ:externalimpedance},\ref{EQ:internalimpedance}) forms the controller, the structure can be seen from figure \ref{FIG:referencetrajectory}. In place of a full cooperative manipulation set-up with $n$ manipulators we derive the controller for a single manipulator $i$, the equations for $i=1...N$ manipulators can be found in the Appendix.
\begin{figure}[b]
	\centering
	\small
	\def\svgwidth{0.8\columnwidth}
	\input{referencetrajectory.eps_tex}
	\caption{Compliant reference trajectory generating controller}
	\label{FIG:referencetrajectory}
\end{figure}
\begin{eqnarray}
\resizebox{1\hsize}{!}{$
\begin{aligned}
\begin{pmatrix}\dot{H}_b^0 \\ \dot{H}_b^v \\  \dot{P_b^b} \\ \dot{H}_{b(i)}^i \\ \dot{P}_i^i\end{pmatrix}
 &=
\begin{pmatrix} 0 & 0 & H_b^0 & 0 & 0\\ 0 & 0 & H_b^v & 0 & 0 \\
- {H_b^0}^T & -{H_b^v}^T & C_b-D_b & -Ad_{H_b^{b(i)}}^T {H_{b(i)}^i}^T & -Ad_{H_b^i}^T D_i \\
0 & 0 & H_{b(i)}^i Ad_{H_b^{b(i)}} & 0 & -H_{b(i)}^i Ad_{H_i^{b(i)}} \\ 0 & 0 & D_i Ad_{H_b^i} & Ad_{H_i^{b(i)}}^T {H_{b(i)}^i}^T & C_i - D_i\end{pmatrix}
\begin{pmatrix}\frac{\partial V}{\partial H_b^0}\\ \frac{\partial V}{\partial H_b^v} \\ \frac{\partial V}{\partial P_b^b} \\ \frac{\partial V}{\partial H_{b(i)}^i} \\ 
\frac{\partial V}{\partial P_{i}^i}\end{pmatrix} + \\
&+
\begin{pmatrix}
0 & 0 \\
-H_b^v Ad_{H_0^b} & 0 \\
D_b Ad_{H_0^b} & 0 \\
0 & 0 \\
0 & I_6
\end{pmatrix}
\begin{pmatrix}
T_v^0 \\ W_i^i
\end{pmatrix}
\\
\begin{pmatrix}
W_v^{0,0} \\ T_i^{i,0}
\end{pmatrix}
&=
\begin{pmatrix}
0 & -Ad_{H_0^b}^T  {H_b^v}^T & Ad_{H_0^b}^T D_b^T & 0 & 0 \\
0 & 0 & 0 & 0 & I_6
\end{pmatrix}
\begin{pmatrix}\frac{\partial V}{\partial H_b^0}\\ \frac{\partial V}{\partial H_b^v} \\ \frac{\partial V}{\partial P_b^b} \\ \frac{\partial V}{\partial H_{b(i)}^i} \\ 
\frac{\partial V}{\partial P_{i}^i}\end{pmatrix}
\end{aligned}
$}
\end{eqnarray}
Note that the output to the robot side is a twist, the control scheme thus generates a compliant reference trajectory for the robots to follow. Similar to \cite{Caccavale_08} we require a local underlying force control layer to operate the robots.
\subsubsection{Passivity}
Passivity follows directly from the port-Hamiltonian formulation, the above representation is of the standard from (\ref{EQ:generalPHS}). The terms to be omitted due to the skew-symmetry of the structure matrix $J(x)$ are not given in the following energy balance
\begin{eqnarray}
\begin{aligned}
\dot{V} &= -\frac{\partial^T V}{\partial P_b^b}D_b\frac{\partial V}{\partial P_b^b} - \frac{\partial^T V}{\partial P_i^i}D_i\frac{\partial V}{\partial P_i^i} -\\ &- \frac{\partial^T V}{\partial H_b^v}H_b^v Ad_{H_0^b}T_v^0 +\frac{\partial^T V}{\partial P_b^b}D_b Ad_{H_0^b}T_v^0 + \frac{\partial^T V}{\partial P_i^i}W_i^i = \\
&= \underbrace{-\frac{\partial^T V}{\partial P_b^b}D_b\frac{\partial V}{\partial P_b^b} - \frac{\partial^T V}{\partial P_i^i}D_i\frac{\partial V}{\partial P_i^i}}_{\text{dissipation}} + \underbrace{{W_v^{0,0}}^T T_v^0 + {T_i^{i,0}}^T W_i^i}_{\text{inputs}}
\end{aligned}
\end{eqnarray}

\subsection{Constrained dynamics IPC}\label{SS:constrainedDIPC}
In a robotic set-up velocities are easier to measure than forces. From this point of view it is convenient to design a controller that issues force commands to the robots and receives velocity feedback. The difficulty to overcome here is the \emph{preferred causality} of port-Hamiltonian elements. Notice from subsection \ref{SS:DynamicsPhysicalComponents} that springs expect a twist for input and output a wrench. Vice versa inertias accept a wrench input, resulting in a twist output. In this formulations the state variable is computed by integration over time, opposite causality representations are possible but require the time derivative. Numerical differentiation amplifies numerical noise, thus the integration form is the preferred one. Furthermore integration allows to use information in form of initial conditions, while differentiation does not. For more information on causality see \cite{duindam2009geoplexbook}.\\
 In the controller both the virtual object and the robotic system expect wrenches, in terms of causality calling for a spring. A virtual manipulator inertia is added by rigidly connecting it to the virtual object, figure \ref{FIG:admittancecontrol} illustrates the composition. In a real cooperative manipulation set-up it is also  common to  have this rigid connection between end-effector and object, making this an obvious choice for control. \\
Rigid coupling of a manipulator and the object is treated with the approach presented in section \ref{S:ImposingConstraints}. Once again we start from a single manipulator $i$ in place of a full cooperative manipulation set-up. Bodies $b$ and $b(i)$ are rigidly connected and their port-Hamiltonian equations are
\begin{eqnarray}
\begin{aligned}
\begin{pmatrix}
\dot{P}_b^b \\ \dot{P}_{b(i)}^{b(i)}
\end{pmatrix}
&=
\begin{pmatrix}
C_b & 0 \\ 0 & C_{b(i)} 
\end{pmatrix}
\begin{pmatrix} \frac{\partial V}{\partial P_b^b} \\ 
\frac{\partial V}{\partial P_{b(i)}^{b(i)}}
\end{pmatrix}
+
\begin{pmatrix}
W_b^b \\ W_{b(i)}^{b(i)}
\end{pmatrix}
+
\bar{A}\lambda 
\\
0 
&=
\bar{A}^T 
\begin{pmatrix} \frac{\partial V}{\partial P_b^b} \\ 
\frac{\partial V}{\partial P_{b(i)}^{b(i)}}
\end{pmatrix}
\end{aligned}
\end{eqnarray}
\begin{figure}[b]
	\centering
	\small
	\def\svgwidth{0.8\columnwidth}
	\input{admittancecontrol.eps_tex}
	\caption{Structure of the constrained dynamic IPC}
	\label{FIG:admittancecontrol}
\end{figure}
The Lagrange multipliers are eliminated as shown in section \ref{S:ImposingConstraints}. In order to write the full control scheme in a compact notation we introduce four abbreviations accounting for the constrained forces
\begin{eqnarray}
\begin{aligned}
\mathcal{A}_b^b &= 
Ad_{H_b^0}^T(\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_b^0}M_b^{-1} \\
\mathcal{A}_b^i &= Ad_{H_b^0}^T(\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_{b(i)}^0}M_{b(i)}^{-1} \\
\mathcal{A}_i^b &= Ad_{H_{b(i)}^0}^T(\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_b^0}M_b^{-1} \\
\mathcal{A}_i^i &= 
Ad_{H_{b(i)}^0}^T(\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_{b(i)}^0}M_{b(i)}^{-1}
\end{aligned}
\end{eqnarray}





\begin{eqnarray}
\resizebox{1\hsize}{!}{$
\begin{aligned}
\begin{pmatrix}\dot{H}_b^0 \\ \dot{H}_b^v \\  \dot{P_b^b} \\ \dot{H}_{b(i)}^i \\ \dot{P}_{b(i)}^{b(i)}\end{pmatrix}
 &=
\begin{pmatrix} 0 & 0 & H_b^0 & 0 & 0\\ 0 & 0 & H_b^v & 0 & 0 \\
(\mathcal{A}_b^b-I) {H_b^0}^T & (\mathcal{A}_b^b-I) {H_b^v}^T & (I-\mathcal{A}_b^b)(C_b-D_b) & -\mathcal{A}_b^i {H_{b(i)}^i}^T & \mathcal{A}_b^i (C_{b(i)} - D_{b(i)}) \\
0 & 0 & 0 & 0 & H_{b(i)}^i \\
 -\mathcal{A}_i^b {H_b^0}^T & -\mathcal{A}_i^b {H_b^v}^T & \mathcal{A}_i^b(C_b-D_b)  & (\mathcal{A}_i^i-I) {H_{b(i)}^i}^T & (I - \mathcal{A}_i^i) (C_{b(i)} - D_{b(i)})\end{pmatrix}
\begin{pmatrix}\frac{\partial V}{\partial H_b^0}\\ \frac{\partial V}{\partial H_b^v} \\ \frac{\partial V}{\partial P_b^b} \\ \frac{\partial V}{\partial H_{b(i)}^i} \\ 
\frac{\partial V}{\partial P_{b(i)}^{b(i)}}\end{pmatrix} \\
&+
\begin{pmatrix}
0 & 0 \\
-H_b^v Ad_{H_0^b} & 0 \\
(I-\mathcal{A}_b^b) D_b Ad_{H_0^b} & \mathcal{A}_b^i D_{b(i)} Ad_{H_0^{b(i)}} \\
0 & -H_{b(i)}^i Ad_{H_0^{b(i)}} \\
\mathcal{A}_i^b D_b Ad_{H_0^b} & (I-\mathcal{A}_i^i) D_{b(i)} Ad_{H_0^{b(i)}}
\end{pmatrix}
\begin{pmatrix}
T_v^0 \\ T_i^0
\end{pmatrix}
\\
\begin{pmatrix}
W_v^{0,0} \\ W_i^{0,0}
\end{pmatrix}
&=
\begin{pmatrix}
0 & -Ad_{H_0^b}^T  {H_b^v}^T & Ad_{H_0^b}^T D_b^T  (I-{\mathcal{A}_b^b}^T) & 0 & Ad_{H_0^b}^T  D_b^T {\mathcal{A}_i^b}^T \\
0 & 0 & Ad_{H_0^{b(i)}}^T  D_{b(i)}^T {\mathcal{A}_b^i}^T & -Ad_{H_0^{b(i)}}^T {H_{b(i)}^i}^T  & Ad_{H_0^{b(i)}}^T  D_{b(i)}^T (I-{\mathcal{A}_i^i}^T)
\end{pmatrix}
\begin{pmatrix}\frac{\partial V}{\partial H_b^0}\\ \frac{\partial V}{\partial H_b^v} \\ \frac{\partial V}{\partial P_b^b} \\ \frac{\partial V}{\partial H_{b(i)}^i} \\ 
\frac{\partial V}{\partial P_{b(i)}^{b(i)}}\end{pmatrix}
\end{aligned}
$}
\end{eqnarray}

\subsubsection{Passivity}
Unlike to the previous, a number of elements with no skew-symmetric counterpart is apparent in the structure matrix. However the property of lossless interconnection still holds, omitting the skew-symmetric elements we have
\begin{eqnarray}
\resizebox{0.9\hsize}{!}{$
\begin{aligned}
\dot{V} &= 
\begin{pmatrix}\frac{\partial V}{\partial P_b^b} \\ 
\frac{\partial V}{\partial P_{b(i)}^{b(i)}}
\end{pmatrix}^T
\begin{pmatrix}
\mathcal{A}_b^b {H_b^0}^T & \mathcal{A}_b^b {H_b^v}^T & -\mathcal{A}_b^b(C_b-D_b) & -\mathcal{A}_b^i {H_{b(i)}^i}^T & \mathcal{A}_b^i (C_{b(i)} - D_{b(i)}) \\
-\mathcal{A}_i^b {H_b^0}^T & -\mathcal{A}_i^b {H_b^v}^T & \mathcal{A}_i^b(C_b-D_b)  & \mathcal{A}_i^i {H_{b(i)}^i}^T & -\mathcal{A}_i^i (C_{b(i)} - D_{b(i)})
\end{pmatrix}
\begin{pmatrix}\frac{\partial V}{\partial H_b^0}\\ \frac{\partial V}{\partial H_b^v} \\ \frac{\partial V}{\partial P_b^b} \\ \frac{\partial V}{\partial H_{b(i)}^i} \\ 
\frac{\partial V}{\partial P_{b(i)}^{b(i)}}\end{pmatrix}\\
&+ \frac{\partial^T V}{\partial P_b^b} D_b \frac{\partial V}{\partial P_b^b} + \frac{\partial^T V}{\partial P_{b(i)}^{b(i)}} D_{b(i)} \frac{\partial V}{\partial P_{b(i)}^{b(i)}} + {W_v^{0,0}}^T T_v^0 + {W_i^{0,0}}^T T_i^0
\end{aligned}
$}
\end{eqnarray}   
The bodies $b$ and $b(i)$ are rigidly connected, i.e. their twists are related by $T_b^0 = Ad_{H_b^0} T_b^{b,0} = Ad_{H_{b(i)}^0} T_{b(i)}^{b(i),0} = T_{b(i)}^0$. In the upper equation the twists are given by $T_{b}^{b,0} = \frac{\partial V}{\partial P_{b}^{b}}$ and $T_{b(i)}^{b(i),0} = \frac{\partial V}{\partial P_{b(i)}^{b(i)}}$. Multiplying with the constraint force terms leads to
\begin{eqnarray}
\begin{aligned}
\frac{\partial^T V}{\partial P_{b(i)}^{b(i)}} \mathcal{A}_i^b &= \frac{\partial^T V}{\partial P_b^b}Ad_{H_b^{b(i)}}^T\mathcal{A}_i^b = \frac{\partial^T V}{\partial P_b^b} (Ad_{H_{b(i)}^0}Ad_{H_b^{b(i)}})^T (\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_b^0}M_b^{-1} = \\ 
&= \frac{\partial^T V}{\partial P_b^b} Ad_{H_b^0}^T (\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_b^0}M_b^{-1} = \frac{\partial^T V}{\partial P_b^b} \mathcal{A}_b^b
\end{aligned}
\end{eqnarray}
and
\begin{eqnarray}
\begin{aligned}
\frac{\partial^T V}{\partial P_{b(i)}^{b(i)}} \mathcal{A}_i^i &= \frac{\partial^T V}{\partial P_b^b}Ad_{H_b^{b(i)}}^T\mathcal{A}_i^i = \frac{\partial^T V}{\partial P_b^b} (Ad_{H_{b(i)}^0}Ad_{H_b^{b(i)}})^T (\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_{b(i)}^0}M_b^{-1} = \\ 
&= \frac{\partial^T V}{\partial P_b^b} Ad_{H_b^0}^T (\bar{A}^TM^{-1}\bar{A})^{-1} Ad_{H_{b(i)}^0}M_b^{-1} = \frac{\partial^T V}{\partial P_b^b} \mathcal{A}_b^i.
\end{aligned}
\end{eqnarray}
The energy balance reduces to the dissipative terms and input-output pairs, the controller is thus passive.
\begin{equation}
\dot{V} = \frac{\partial^T V}{\partial P_b^b} D_b \frac{\partial V}{\partial P_b^b} + \frac{\partial^T V}{\partial P_{b(i)}^{b(i)}} D_{b(i)} \frac{\partial V}{\partial P_{b(i)}^{b(i)}} + {W_v^{0,0}}^T T_v^0 + {W_i^{0,0}}^T T_i^0
\end{equation}
 


\chapter{Energy-aware control}\label{C:Energy-aware control}
Towards a conclusion on stability of the overall system, it is necessary to take the environmental conditions into consideration. Letting a human explicitly control a cooperative robot-team rises the question of her/his dynamic behaviour and the impact on the system. Furthermore the environment, the robotic system is interacting with, can change unexpectedly. Thus stability considerations based on certain environment models may thus lose their basis. Preserving stability is especially crucial when the human operator is on-site to ensure her/his safety. The objective of this chapter is to introduce an energy tank, that sources the controller, to maintain a safe level of energy in the system, regardless of the dynamics of a human and the environment. The energy-based controllers from section \ref{S:modelbasedcontrol} integrate seamlessly with the tank concept.
\section{Passivity and unknown environments} 
Passivity is a key concept when dealing with unknown environments. It is well known that passive robotic systems are stable with any environment, regardless its structure or complexity, that can provide only a bounded amount of energy. On the other hand it is shown in \cite{Stramigioli_15}, that for a non-passive robotic system, there always exists a (passive) environment that destabilizes the overall behaviour.\\
When a human operator controls a robotic set-up by hand motion, it is often argued that the human arm is not distinguishable from a mechanical impedance. This stems from experiments with a human manipulating a controlled impedance \cite{Hogan_89}. The robotic device applies a force to the human and s/he responds with motion, therefore the human-machine interface is on an energetic level (the product of force and velocity is mechanical power).
\begin{figure}[b!]
	\centering
	\small
	\def\svgwidth{0.95\columnwidth}
	\input{passivityenvironment.eps_tex}
	\vspace{10pt}
	\caption{The robotic system interacting with operator and environment}
	\label{FIG:passivityenvironment}
\end{figure}
In recent years new input methods appeared (hand tracking, gesture control). Here the interaction between human and robotic system is an exchange of information. There is no explicit relation between force and velocity (impedance) and therefore it is not meaningful to model the human operator with an impedance. Feedback given through tactile or visual information does not effectively restrict the operator's motion, allowing him to issue nearly arbitrary commands. Figure \ref{FIG:passivityenvironment} illustrates the exchange of energy of a passive robotic team with the environment and an operator that can directly power the controller.\\
In order to obtain passive human-guided robotic system we propose to assign the operator with an energy budget at disposal to issue commands. The structure is shown in figure \ref{FIG:energytank} and the theory treated in the next section. This allows to achieve stability with any environment the robotic system is interacting with, as long as its energy supply is bounded. Using the concept of passivity, asymptotic stability is given without requiring certain models or assumptions for the human and the environment. Furthermore the energy stored in the robotic set-up is bounded, this effectively limits the possible impact on the environment and therefore contributes to the safety if a human is on-site.       
   
%Recall the power balance already given by eq. (\ref{EQ:energybalance}), in integrated form we obtain the energy balance of a pHs
%\begin{equation}
%\underbrace{H(x(t))-H(x(0))}_{stored\, energy} = \underbrace{\int_0^t e_P^Tf_P dt}_{ext.\, supplied} + \underbrace{\int_0^te_R^Tf_R dt}_{dissipated} 
%\end{equation}
%The dissipated co-energy is negative since $e_R^tf_R \leq 0$. Clearly the given energy balance corresponds to a \emph{passive} system. The Hamiltonian energy functions of the systems presented in Chapter 2 are \emph{candidate Lyapunov} functions. The interconnection of pH/passive systems is still a pH/passive system. By interconnection of pH-controller and passive plant we obtain a passive controlled-robotic system. This type of systems has an important advantage when it comes to interaction with humans and/or unknown environments. Usually whose dynamics are either uncertain or too complicated to be modelled. Passive systems are stable with any system, regardless its structure or complexity, that can provide only a bounded amount of energy (see \cite{Stramigioli_15} for details). \\
%In this chapter we propose a passive model-based controller for a robot-team manipulating a common object. We employ \emph{collocated control}, i.e. for the controller we use only the information contained in the effort-flow pair connecting the controller to the robotic system. There are no additional observers (e.g. tracking of the manipulated object).


%\begin{landscape}
%\begin{eqnarray}
%\resizebox{0.98\hsize}{!}{$ 
%\begin{aligned}
%\begin{pmatrix}\dot{H}_b^0 \\ \dot{H}_b^v \\  \dot{P}_b^b \\ \dot{H}_{b(1)}^1 \\ 
%\dot{P}_1^1 \\ \vdots \\ \dot{H}_{b(N)}^N \\ 
%\dot{P}_N^N\end{pmatrix}
% &= 
%\begin{pmatrix} 0 & 0 & H_b^0 & 0 & 0 & \cdots & 0 & 0  \\ 0 & 0 & H_b^v & 0 & 0 & \cdots & 0 & 0 \\
%- (H_b^0)^T & -(H_b^v)^T & C_b-D_b & Ad_{H_b^{b(1)}}^T (H_{b(1)}^1)^T & Ad_{H_b^1}^T D_1 & \cdots & Ad_{H_b^{b(N)}}^T (H_{b(N)}^N)^T & Ad_{H_b^N}^T D_N \\
%0 & 0 & H_{b(1)}^1 Ad_{H_b^{b(1)}} & 0 & H_{b(1)}^1 Ad_{H_1^{b(1)}} &  & 0 & 0 \\
%0 & 0 & D_1 Ad_{H_b^1} & -Ad_{H_1^{b(1)}}^T H_{b(1)}^1 & C_1-D_1 &  & 0 & 0 \\
%\vdots & \vdots & \vdots &  &  & \ddots &  & \\ 
%0 & 0 & H_{b(N)}^N Ad_{H_b^{b(N)}} & 0 & 0 &  & 0 & H_{b(N)}^N Ad_{H_N^{b(N)}}\\
%0 & 0 & D_N Ad_{H_b^N} & 0 & 0 &  &  -Ad_{H_N^{b(N)}}^T H_{b(N)}^N & C_N-D_N
%\end{pmatrix}
%\begin{pmatrix}
%\frac{\partial V}{\partial H_b^0}\\
%\frac{\partial V}{\partial H_b^v}\\
%\frac{\partial V}{\partial P_b^b}\\
%\frac{\partial V}{\partial H_{b(1)}^1} \\ 
%\frac{\partial V}{\partial P_{1}^1}\\
%\vdots \\
%\frac{\partial V}{\partial H_{b(N)}^N} \\ 
%\frac{\partial V}{\partial P_{N}^N}
%\end{pmatrix}
%+ \\
%&+ 
%\begin{pmatrix}
%0 & 0 & 0 & \cdots & 0 & 0 \\
%-H_b^v Ad_{H_b^0} & 0 & 0 & \cdots & 0 & 0 \\
%D_b Ad_{H_0^b} & 0 & 0 & \cdots & 0 & 0 \\
%0 & H_{b(1)}^1 Ad_{H_b^{b(1)}} & 0 &  & 0 & 0 \\
%0 & 0 & I_6 &  & 0 & 0 \\
%\vdots &  &  & \ddots &  & \\
%0 & 0 & 0 &  & H_{b(N)}^N Ad_{H_b^{b(N)}} & 0 \\
%0 & 0 & 0 &  & 0 & I_6
%\end{pmatrix}
%\begin{pmatrix}
%T_v^0 \\ T_{b(1)}^b \\ W_1^1 \\ \vdots \\ T_{b(N)}^b \\ W_N^N
%\end{pmatrix}
%\\
%\begin{pmatrix}
%W_v^{v,0} \\ W_{b(1)}^{b,b} \\ T_1^{1,0} \\ \vdots \\ W_{b(N)}^{b,b} \\ T_N^{N,0}
%\end{pmatrix}
%&= 
%\begin{pmatrix}
%0 & -Ad_{H_b^0}^T (H_b^v)^T  &  Ad_{H_0^b}^T D_b & 0 & 0 & \cdots & 0 & 0 \\
%0 & 0 & 0 &  Ad_{H_b^{b(1)}}^T (H_{b(1)}^1)^T & 0 &  & 0 & 0 \\
%0 & 0 & 0 & 0 & I_6 &  & 0 & 0 \\
%\vdots & \vdots & \vdots &  &  & \ddots &  & \\ 
%0 & 0 & 0 & 0 & 0 &  & Ad_{H_b^{b(N)}}^T (H_{b(N)}^N)^T & 0 \\
%0 & 0 & 0 & 0 & 0 & & 0 & I_6\\
%\end{pmatrix}
%\begin{pmatrix}
%\frac{\partial V}{\partial H_b^0}\\
%\frac{\partial V}{\partial H_b^v}\\
%\frac{\partial V}{\partial P_b^b}\\
%\frac{\partial V}{\partial H_{b(1)}^1} \\ 
%\frac{\partial V}{\partial P_{1}^1}\\
%\vdots \\
%\frac{\partial V}{\partial H_{b(N)}^N} \\ 
%\frac{\partial V}{\partial P_{N}^N}
%\end{pmatrix}
%\end{aligned}
%$}
%\end{eqnarray}
%\end{landscape}
%Notably the input signal coming from the manipulator is the wrench $W_i^i$, thus we require force/torque sensing at the robots. Consequently the output of the controller is the twist $T_i^{i,0}$, leading to a twist-controlled robotic system. Every effort-flow pair contains not only the information encoded by its definition but also the power needed to execute the commanded action. A common concept in tele-operation is the wave transformation (see \cite{Niemeyer_04} for a survey) based on effort-flow pairs. The resulting wave variables possess \emph{hybrid encoding}, i.e. the distinction between effort and flow is discarded. The receiving robot interprets the wave based on its needs. Wave variables only encode strength and direction of an action but do not discriminate between force and twist.
%This is the motivation to introduce a power-preserving transformation based on a constant factor $b$, that relates twists and wrenches.
%\begin{eqnarray}
%\begin{aligned}
%&\mathcal{W}_i^i = b T_i^{i,0} \; , \; i=1...N\\
%&W_i^i = b \mathcal{T}_i^{i,0} \\
%\end{aligned}
%\end{eqnarray}
%Where $\mathcal{W},\mathcal{T}$ denote the wrenches and twists of the robot side.
%The constant $b$ is another tunable parameter, it allows for choosing the weighting of twists and wrenches.

%\section{Human guidance}
%An intuitive way of guiding the robotic system is to let it follow the hand of the operator. Tracking systems for either of the hand or a device held by the hand are available. These motion capture systems usually run at lower frequencies than the robotic control loop (which is assumed time-continuous). Therefore the tracking output is not a smooth twist trajectory but a time-discrete sequence of position and orientation data. The objective of this section mainly is the derivation of the reference twist $T_v^0$ from the discrete tracking results.   
%From the previous sections we know $T_v^0 = \dot{H}_v^0 H_0^v$, in a discrete representation this is
%\begin{equation}
%\begin{aligned}
%T_v^0 (k+1) &= \dot{H}_v^0(k+1) H_0^v(k+1)(H_0^v(k))^{-1} = \\ &=\dot{H}_v^0(k+1)(H_v^0(k+1))^{-1} H_v^0(k)
%\end{aligned}
%\end{equation}  We can calculate the change of position/orientation over the sampling time interval $\Delta T$
%\begin{equation}
%\dot{H}_v^0 (k+1) = \frac{H_v^0 (k+1) (H_v^0(k))^{-1}  }{T_s}
%\end{equation}
%Thus we have obtained a discrete twist representation based on discrete pose inputs. It is a discontinuous sequence updated every $T_s$ and thus exhibits steps in its value. The energy exchanged through the port during $T_s$ is
%\begin{equation}
%\Delta V_k^{k+1} =  \int_{kT_s}^{(k+1)T_s}W_v^{v,0}dt \; T_v^0(k+1)
%\end{equation}  
%Steps of the input result in discontinuities in the energy function, since the input(flow) is the time derivative of the energy state. Consider the time-discrete twist $T_v^0(k+1)$ assigned to the continuous system input, i.e. $T_v^0(t) := T_v^0(k+1)$. Thus the input changes its value every $T_s$. The input $T_v^0(t)$ is an external flow $f_p$, contributing to the energy balance given in eq. (\ref{EQ:energybalance}). Since the pHs is continuous the property of energy conservation holds for all $f_P$. The steps in the system energy are exclusively supplied by external power and are thus not passivity violating.
%In contrast to there are time-discrete pHs, described in \cite{Stramigioli_05}. The main difference are time-discrete energy states, i.e. the state of the next time step is computed from the actual flow and state value. In this class of systems passivity is violated if, throughout a time-step, more energy than stored is extracted. Therefore consider the example of an elongated spring. The relaxing twist is so high that its integration (i.e. the displacement) over the time-step is higher than the initial elongation. I.e. in one time-step the spring not only fully relaxes to its equilibrium but also elongates in the other direction, this would generate energy and violates passivity. In our case assuming a continuous pHs, this cannot happen because the time-steps are infinitely small.\\
%Using time-discrete input functions with a continuous pHs does not affect passivity. Thus they can be used as a minimum solution for connecting a human directly to the controller presented in the previous section.


% The power responsible for this step is supplied through the external port. The property of a continuous pHs that externally supplied energy is either stored or dissipated, is not violated by discontinuous inputs, nor is passivity. Consider the time-discrete external flow $f_P (k+1) =: f_P(t)$ which is assigned to the time-continuous flow and updated every $T_s$. The energy balance described for continuous pHs in eq. (\ref{EQ:energybalance}) holds for any input $f_P(t)$ (cf. \cite{Stramigioli_05}). The problem of extracting more energy energy than stored in the system throughout a sampling interval is prevalent in discrete pHs. These systems compute the energy-state of the next time-step based on the current time-step, due to the discrete nature this energy-state can be below the energetic minimum of the system. To make this more clear consider the example of a moving system, which is slowed down very quickly: $(T_v^0(k+1) \ll T_v^0(k)$. But still $(T_v^0(k+1) > 0$, otherwise energy would be supplied. Consider a elongated spring which is commanded to shorten/compress very quickly, the twist is so high that in the next time-step the twist is elongated already in the over direction. Thus the spring has passed through its energetic minimum and more energy than stored would have been extracted. This clearly violates passivity. It is also obvious that this case cannot occur in a continuous system. Thus the presented simple version of connecting a human with a spring to the controller, does not violate passivity.

\section{Energy tanks}\label{S:EnergyTanks}
The motivation for the use of an \emph{energy tank} is to energetically decouple the human operator from the robotic system, i.e. the operator is no longer able to supply energy to the system. This is a consequence of the chosen input method, which is based on information rather than on energy exchange, as discussed above. The energy necessary for driving the robotic system comes from the tank, the operator only controls the energetic flow.\\
On command of the operator energy flows from the energy tank into the controller and on into the robotic system. Under ideal conditions energy is circulating between these parts and the total amount stays constant (lossless system). In subsection \ref{SS:EnergyExchangeEnvironment} we discuss cases of a permanent change of the energy balance. At first we examine the combination of energy tank and a controller as defined in section \ref{S:modelbasedcontrol}. Therefore we assume that no energy is exchanged with the robotic system. In this case we can guarantee a lossless combined system by re-harvesting the energy dissipated in the controller's dampers. \\ 
The energy tank is a virtual storage element defined with a Hamiltonian energy function. Let $x_t \in \mathbb{R}$ denote the (scalar) energy state and we have a simple, positive definite function $T(x_t) = \frac{1}{2}x_t^2$. The dynamic equations of the tank are
\begin{eqnarray}
\begin{aligned}
\dot{x_t} &= f_t \\
e_t &= \frac{\partial T(x_t)}{\partial x_t} (=x_t)
\end{aligned}
\end{eqnarray}
Here $(f_t,e_t)$ is the flow-effort pair, corresponding to input and output respectively. Towards the application of the energy tank we consider an example port-Hamiltonian system of the form
\begin{eqnarray}
\begin{aligned}
\dot{\f{x}} &= [J(\f{x}) - R(\f{x})] \frac{\partial V}{\partial \f{x}} + g(\f{x})\f{f} \\
\f{e} &= g^T(\f{x}) \frac{\partial V}{\partial \f{x}}
\end{aligned}
\end{eqnarray}
This standard system is chosen to keep the derivation process simple and can be replaced with the controllers from section \ref{S:modelbasedcontrol}.
First we seek to re-route the dissipated energy into the energy tank, this is accomplished by choosing the tank input as $f_t = \frac{1}{x_t}\frac{\partial V^T}{\partial \f{x}}R(\f{x})\frac{\partial V}{\partial \f{x}} + \tilde{f}_t$. With a new input $\tilde{f}_t$ we have the tank's energy balance
\begin{equation}\label{EQ:tankpower}
\dot{T}(x_t)=e_tf_t = \frac{\partial V^T}{\partial \f{x}}R(\f{x})\frac{\partial V}{\partial \f{x}} + x_t\tilde{f}_t
\end{equation}
This corresponds to the systems dissipated energy plus some external supply. Next we use this external supply to interconnect tank and port-Hamiltonian system. A power-preserving interconnection is established, here we use a combination of gyrator and transformer with ratio $n$
\begin{eqnarray}
\begin{aligned}
\f{f} &= \f{n}e_t \\
\tilde{f}_t &= -\f{n}^T\f{e}
\end{aligned}
\end{eqnarray}
By construction and independent of a particular choice of $\f{n}$ this relation is power-continuous
\begin{equation}
\f{f}^T\f{e} = e_t^T\f{n}^T\f{e} = -e_t^T\tilde{f}_t
\end{equation}
The combined energy function of the interconnected system is $\mathcal{V}(\f{x},x_t)=V(\f{x})+T(x_t)$. The choice of $\f{n}$ is not fixed but can be adjusted dynamically to shape the energy flow. In particular it is appealing to use $\f{n}$ to replicate the original control signal by choosing $\f{n} = \frac{\f{w}}{x_t}$. The new control input $\f{w}$ can effectively take the role of $\f{f}$, i.e. the port-Hamiltonian system becomes
\begin{equation}
\dot{\f{x}} = [J(\f{x}) - R(\f{x})] \frac{\partial V}{\partial \f{x}} + g(\f{x})\frac{\f{w}}{x_t}e_t = [J(\f{x}) - R(\f{x})] \frac{\partial V}{\partial \f{x}} + g(\f{x})\f{w}
\end{equation}
For a $x_t\rightarrow0$, i.e. an empty energy tank, there is a singularity. Thus an complete depletion of the tank must be avoided. A minimum strategy is to introduce a switching parameter $\alpha$, we set $\f{n}=\frac{\alpha \f{w}}{x_t}$ with 
\begin{equation}
\alpha = \begin{cases}
1 & \text{if } \, T(x_t)\geq\epsilon>0 \\
0 & \text{if } \, T(x_t) < \epsilon
\end{cases}
\end{equation}
This means that a control input is executed unchanged as long as certain amount $\epsilon$ of energy is in the tank. Once the energy budget is exceeded and command execution possibly violates passivity the input is set to $0$, effectively suspending energy exchange. This happens in both ways, neither is it possibly to re-transfer into the tank through the interconnection. At this point the tank can only be refilled by dissipation. Dissipation is associated with kinetic energy, as long as the system is moving it can recover from the input-suspended state. If the system is driven to a state of exclusively potential energy, there is no dissipation and a deadlock is reached.\\
Reaching a state of exclusively potential energy takes infinite time, this is because a state of higher potential energy can only be reached by motion. I.e. kinetic energy is a predecessor of potential energy. A fragment of the kinetic energy is dissipated and is available in the energy budget again. The available energy approaches $\epsilon$ asymptotically.\\
Another apparent issue with the binary parameter $\alpha$ is the abrupt switching behaviour if the tank level is in the neighbourhood of $\epsilon$. Numeric simulations indicate high forces and chattering behaviour.\\
A solution to this desired behaviour is to make $\alpha$ a function of the tank level and continuously scale the desired trajectory.
\begin{equation}
\alpha = \begin{cases}
1 & \text{if } \, T(x_t)\geq T_{th} \\
\frac{T(x_t)-\epsilon}{T_{th}} & \text{if } \, \epsilon \leq T(x_t) < T_{th} \\
0 & T(x_t) < \epsilon
\end{cases}
\end{equation}
Here $T_{th} > \epsilon$ is a threshold level that defines the width of the transition region. Adapting the reference trajectory leads to a permanent position deviation, if the user does not actively readjust after the tank level has recovered. We approach this problem in the next subsection.\\ 
Regardless of a particular choice of $\alpha$ we can give a combined port-Hamiltonian representation of the  system and the tank
\begin{eqnarray}
\begin{aligned}
\begin{pmatrix}
\dot{\f{x}} \\ \dot{x}_t
\end{pmatrix} =
\left[
\begin{pmatrix}
J(\f{x}) & \frac{\alpha \f{w}}{x_t} \\ -\frac{\alpha \f{w}^T}{x_t} & 0
\end{pmatrix} - 
\begin{pmatrix}
R(\f{x}) & 0 \\ -\frac{1}{x_t}\frac{\partial^T \mathcal{V}}{\partial \f{x}}R(\f{x}) & 0
\end{pmatrix}
\right]
\begin{pmatrix}
\frac{\partial \mathcal{V}}{\partial \f{x}} \\
\frac{\partial \mathcal{V}}{\partial x_t}
\end{pmatrix}
\end{aligned}
\end{eqnarray}

\begin{figure}[b!]
	\centering
	\small
	\def\svgwidth{0.95\columnwidth}
	\input{energytank.eps_tex}
	\vspace{10pt}
	\caption{The human operator controls the energy flow between tank and robotic system}
	\label{FIG:energytank}
\end{figure} 

Note that there is no more an input-output port, this is because ports are defined by energy exchange of the system with its environment. It is shown in subsection \ref{SS:PHSinterconnection} that the systems consistent with (\ref{EQ:generalPHS}) are passive, analogously we show that the described combination of such a system and the energy tank is \emph{lossless}.
\begin{eqnarray}
\begin{aligned}
&\frac{d}{dt}\mathcal{V}(\f{x},x_t) = 
\begin{pmatrix}
\frac{\partial^T \mathcal{V}}{\partial \f{x}} & \frac{\partial^T \mathcal{V}}{\partial x_t}
\end{pmatrix}
\begin{pmatrix}
\dot{\f{x}} \\ \dot{x_t}
\end{pmatrix}
= \frac{\partial^T \mathcal{V}}{\partial \f{x}}J(\f{x})\frac{\partial \mathcal{V}}{\partial \f{x}} + \frac{\partial^T \mathcal{V}}{\partial \f{x}}\frac{\alpha \f{w}}{x_t}\frac{\partial \mathcal{V}}{\partial x_t} - \\
&
 -\frac{\partial^T \mathcal{V}}{\partial \f{x}}R(\f{x})\frac{\partial \mathcal{V}}{\partial \f{x}} -\frac{\partial^T \mathcal{V}}{\partial x_t}\frac{\alpha \f{w}^T}{x_t} \frac{\partial \mathcal{V}}{\partial \f{x}} + \frac{\partial^T \mathcal{V}}{\partial x_t}\frac{1}{x_t}\frac{\partial^T \mathcal{V}}{\partial \f{x}}R(\f{x})\frac{\partial \mathcal{V}}{\partial \f{x}} = 0
\end{aligned}
\end{eqnarray}

 
\subsection{Energy-adapted stiffness and damping}\label{SS:EnergyAdaptedStiffness}
With the above conjunction of tank and controller control inputs are discarded, as soon as the energy tank is depleted. It is clear that desired trajectories driving the tank to a negative state are not feasible with the given energy budget and need to be altered. Simply discarding the desired trajectory information leads to a permanent deviation of the position. Thus we demand a controller that returns onto the desired trajectory as soon as the energy level has recovered. Therefore we propose the use of an energy-adapted spring and damper. The idea is to relax the stiffness of the user-object spring as function of the available energy. Actually the impedance of the human hand behaves similar, usually it is stiff for slow motion and compliant during fast movements (high kinetic energy, likely depleted energy tank) \cite{Hogan_84b}. A lower stiffness allows the system to "float" loosely and regain energy through damping. Moreover a change of stiffness affects the energy stored in the spring, relaxing stiffness sets energy free, which is re-fed into the tank. With a rise of the tank level, stiffness is increased and the spring re-directs the system onto the desired trajectory. To illustrate the principle we start with an example one-dimensional spring given by
\begin{equation}
F = k_{vb}(x_v-x_b) \;,\; T(x_t)\geq T_{th}
\end{equation}
This equation is valid if the tank level $T(x_t)$ is above a certain threshold level $T_{th}$. The spring's stiffness $k_{vb} \in \mathbb{R}^+$ is unaltered, $x_v, x_b \in \mathbb{R}$ denote the reference and the actual position respectively. Below the threshold we propose the following spring function
\begin{equation}
F = k_{vb}\frac{T(x_t)}{T_{th}}(x_v-x_b) \;,\; T(x_t)<T_{th}
\end{equation}
For ease of notation we define a new stiffness parameter
\begin{equation}
\kappa = \begin{cases}
k_{vb} & \text{if } \, T(x_t)\geq T_{th} \\
k_{vb} \frac{T(x_t)}{T_{th}} & \text{if } \, T(x_t) < T_{th}
\end{cases}
\end{equation}
The corresponding energy function is then
\begin{equation}
V_{\kappa}(x_v,x_b,\kappa) = \frac{1}{2} \kappa (x_v-x_b)^2
\end{equation}    
The exchanged power with respect to a change of stiffness is 
\begin{equation}
\dot{V}_{\kappa} =\frac{\partial V_{\kappa}}{\partial \kappa} \frac{d \kappa}{dt} = \frac{1}{2} (x_v-x_b)^2 \dot{\kappa} = e_k^Tf_k,
\end{equation}
which corresponds to the product of effort ($\frac{\partial V_{\kappa}}{\partial \kappa}$) and flow ($\dot{\kappa}$) and forms a power port $(f_k,e_k)$ as defined in Section \ref{S:HSdescription}. The energy function of a $6$-DoF spring is of the from
\begin{equation}
V_{\kappa}:SE(3) \times \mathcal{K} \rightarrow \mathbb{R}; (H_b^v,\kappa)\mapsto V_{\kappa}(H_b^v,\kappa),
\end{equation}
which is equal to the previous spring energy function (eq. (\ref{EQ:SpringEnergyFunction})) but depends explicitly on the stiffness parameter $\kappa$. $\mathcal{K}$ is a parametric space that equals $\mathbb{R}$ in case of an isotropic spring. For more information on variable spatial springs see \cite{Stramigioli_01c}. The port-Hamiltonian representation of a variable stiffness spring is given by
\begin{eqnarray}
\begin{aligned}
\begin{pmatrix}
\dot{H}_b^v \\ \dot{\kappa}
\end{pmatrix}
&=
\begin{pmatrix}
H_b^v & 0 \\ 0 & I
\end{pmatrix}
\begin{pmatrix}
T_b^{b,v} \\ f_k
\end{pmatrix}
\\
\begin{pmatrix}
W_b^{b,v} \\ e_k
\end{pmatrix}
&=
\begin{pmatrix}
{H_b^v}^T & 0 \\ 0 & I
\end{pmatrix}
\begin{pmatrix}
\frac{\partial V_{\kappa}}{\partial H_b^v} \\ \frac{\partial V_{\kappa}}{\partial \kappa}
\end{pmatrix},
\end{aligned}
\end{eqnarray}
where $f_k,e_k$ is the input-output pair. Towards pairing the variable stiffness spring with the energy tank we can express $\kappa$ as a function of the tank level. By using the tank power flow equation (\ref{EQ:tankpower}) we obtain
\begin{equation}
\dot{\kappa} = \begin{cases}
0 & \text{if } \, T(x_t)\geq T_{th} \\
\frac{k}{T_{th}}\dot{T}(x_t) = \frac{k_{vb}}{T_{th}} \dot{x}_t \frac{\partial \mathcal{V}_{\kappa}}{\partial x_t} & \text{if }  \, T(x_t) < T_{th}
\end{cases}
\end{equation}
The power exchanged between variable spring and tank due to stiffness changes is
\begin{equation}
\dot{\mathcal{V}_{\kappa}} = \frac{\partial \mathcal{V}_{\kappa}}{\partial \kappa}\dot{\kappa} =
\begin{cases}
0 & \text{if } \, T(x_t)\geq T_{th} \\
\frac{\partial \mathcal{V}_{\kappa}}{\partial \kappa}\frac{k_{vb}}{T_{th}} \dot{x}_t \frac{\partial \mathcal{V_{\kappa}}}{\partial x_t} & \text{if }  \, T(x_t) < T_{th}
\end{cases}
\end{equation}
The power exchanged by the energy tank is of the form $\dot{T}(x_t) = \frac{\mathcal{V}_{\kappa}}{\partial x_t}f_t$, therefore $\frac{\partial \mathcal{V}_{\kappa}}{\partial \kappa}\frac{k_{vb}}{T_{th}} \dot{x}_t$ is an input for the energy tank. Using these assignments we can write the port-Hamiltonian representation of variable stiffness spring and energy tank. For simplicity we assume that the variable stiffness spring is part of the general system of equation (\ref{EQ:generalPHS})
\begin{equation}
\begin{pmatrix}
\dot{\f{x}} \\ \dot{x}_t \\ \dot{\kappa}
\end{pmatrix} =
\left[
\begin{pmatrix}
J(\f{x}) & \frac{\alpha \f{w}}{x_t} & 0\\ -\frac{\alpha \f{w}^T}{x_t} & 0 & -\frac{k_{vb}}{T_{th}}\dot{x}_t \\ 0 & \frac{k_{vb}}{T_{th}}\dot{x}_t & 0\end{pmatrix}
- 
\begin{pmatrix}
R(\f{x}) & 0 & 0\\ -\frac{1}{x_t}\frac{\partial \mathcal{V}^T}{\partial \f{x}}R(\f{x}) & 0 & 0 \\ 0 & 0 & 0
\end{pmatrix}
\right]
\begin{pmatrix}
\frac{\partial \mathcal{V}_{\kappa}}{\partial \f{x}} \\
\frac{\partial \mathcal{V}_{\kappa}}{\partial x_t} \\
\frac{\partial \mathcal{V}_{\kappa}}{\partial \kappa} 
\end{pmatrix}
\end{equation}
The combination of such an example system with a variable stiffness spring and a tank is lossless, if we disregard the energy exchange with the robotic environment.
\begin{eqnarray}
\begin{aligned}
&\frac{d}{dt}\mathcal{V}(\f{x},x_t,\kappa) = 
\begin{pmatrix}
\frac{\partial^T \mathcal{V}}{\partial \f{x}} & \frac{\partial^T \mathcal{V}}{\partial x_t} &
\frac{\partial^T \mathcal{V}}{\partial \kappa}
\end{pmatrix}
\begin{pmatrix}
\dot{\f{x}} \\ \dot{x_t} \\ \dot{\kappa}
\end{pmatrix}
= \frac{\partial^T \mathcal{V}}{\partial \f{x}}J(\f{x})\frac{\partial \mathcal{V}}{\partial \f{x}} + \frac{\partial^T \mathcal{V}}{\partial \f{x}}\frac{\alpha \f{w}}{x_t}\frac{\partial \mathcal{V}}{\partial x_t} - \\
&
 -\frac{\partial^T \mathcal{V}}{\partial \f{x}}R(\f{x})\frac{\partial \mathcal{V}}{\partial \f{x}} -\frac{\partial^T \mathcal{V}}{\partial x_t}\frac{\alpha \f{w}^T}{x_t} \frac{\partial \mathcal{V}}{\partial \f{x}} - \frac{\partial^T \mathcal{V}}{\partial x_t}\frac{k_{vb}}{T_{th}}\dot{x}_t \frac{\partial \mathcal{V}}{\partial \kappa}   + \frac{\partial^T \mathcal{V}}{\partial x_t}\frac{1}{x_t}\frac{\partial^T \mathcal{V}}{\partial \f{x}}R(\f{x})\frac{\partial \mathcal{V}}{\partial \f{x}} + \\
 &
+ \frac{\partial^T \mathcal{V}}{\partial \kappa} \frac{k_{vb}}{T_{th}}\dot{x}_t \frac{\partial \mathcal{V}}{\partial x_t}= 0
\end{aligned}
\end{eqnarray}
The dissipative structure $R(\f{x})$ can be changed without compromising passivity as long as it is positive semi-definite. A change of a damping parameter does not change the energy stored in the system, since dampers do not store energy and do not have a state variable. A similar approach as for stiffness indicates good results in numeric simulations. With a depletion of the energy tank the damping $d_{vb} \in \mathbb{R}^+$ along the user-object spring is reduced, thus the coupling between user and virtual object is further relaxed.
\begin{equation}
\delta = \begin{cases}
d_{vb} & \text{if } \, T(x_t)\geq T_{th} \\
d_{vb} \frac{T(x_t)}{T_{th}} & \text{if } \, T(x_t) < T_{th}
\end{cases}
\end{equation} 

\subsection{Energy exchange with the robotic system and environment}\label{SS:EnergyExchangeEnvironment}
So far we made simplification of assuming no energy exchange of the controller through the robots with the environment. In contrast to the human-controller relation, the controller-robot relation is established on an energetic level. The robot measures its velocity at exactly the same point it applies the commanded force, this defines the power port between the controller and the robotic environment. The power flow through this port can affect the energy of the tank-controller permanently, i.e. an irreversible drain of  energy is possible. In the following three important cases are discussed that interfere with the concept of a constant energy level in tank and controller.\\ 
In the controller we assume the robots to be a simple inertia, in reality however they are a system of actuated joints and links with a dynamic behaviour different from a  single inertia. To achieve the desired control performance the robots can be pre-compensated by  passive feedback-linearisation \cite{Ott_04}. The internal dynamics and gravity are compensated in favour of shaping a desired inertia. This technique however is passive, but not lossless, because this would require ideal measurements and modelling. This means at this point energy is irreversibly dissipated. \\
The second issue is the friction in the robot's joints, it can degrade precision and results in a loss of energy seen from the controller-robot power port. In \cite{Tien_08} a passive observer/compensation technique is presented that estimates the torque necessary to overcome friction and applies it in addition. Although this method reduces the energy loss due to friction, it is still a cautious estimation (i.e. passive) and not lossless. Thus, over time the energy stored in robots, controller and energy tank decreases. \\
A permanent decrease of energy in the system occurs, if the robotic system is performing work on the environment. For example, let the common object (connected to the robots) move other objects in the workspace. The work performed on this objects is withdrawn permanently from the energy balance.\\
Clearly, there is always a drain of energy in a realistic system  and at some time the energy tank gets close to depletion. In this case we require a method to restore the capacity to act, by providing energy to the system. It is clear that this means the introduction of a source of energy and thus inflicts a loss of the strict definition of passivity. The safest way of re-powering the system is to allow the operator to supply energy to the tank, in a manner independent of the motion control interface. This means the operator is always in charge of the energy content and is able to estimate the possible impact on the environment. However the approach may be inconvenient, in certain operations the user has to interrupt his actual work and choose an appropriate quantum of energy to send to the energy tank. This may mislead some operators to use high quanta, what makes the concept of safety by limited energy ineffective. An automatic strategy to compensate for energy drain is discussed in the next subsection.\\
With no restrictive assumptions on the environment we must consider the case of an environment supplying energy to the robotic system. For safety we suggest to automatically discard energy supplied to the tank that exceeds a certain limit.

\subsubsection{Automatic compensation for drained energy}
The two controllers presented in section \ref{S:modelbasedcontrol} are based on the model of cooperative manipulation set-up. In an ideal case the same amount of energy stored in the energy is virtually bound in the controller. I.e. the controller reflects the energy state of the real system. Since all energy sourced by the tank flows through the controller into the robots, limiting the energy in the controller  also limits the energy stored in the robotic system.
An energetic limit for the controller only is imposed by automatically supplying the power flowing into the robots to energy tank. The power exchanged between controller and the $i$-th robot is defined by the given by the wrench-twist product ${W_i^{0,0}}^T T_i^0$, applying the automatic compensation the energy balance is
\begin{equation}
\dot{T}(x_t) + \underbrace{\sum_{i=1}^n {W_i^{0,0}}^T T_i^0}_{\text{compensation}} = \dot{\mathcal{V}} + \sum_{i=1}^n {W_i^{0,0}}^T T_i^0
\end{equation}
Clearly, the compensation term $\sum_{i=1}^n {W_i^{0,0}}^T T_i^0$ is active, it provides energy in lieu of the user, who is energetically decoupled in our approach.\\ 
In order to explain the proposal of enhancing safety by energy-bounding the controller consider the following illustrative examples.
The operator drives the system to a high velocity, due to the moving virtual inertias in the controller the tank is used up. This leads to a relaxation of the coupling of user and virtual object and prevents prevents further acceleration. Thus  the robotic system is also kept at a certain speed. This also holds if the virtual inertia parameters deviate from their real pendants (modelling errors). The combination of initial tank level and virtual inertias determine the achievable system speed. 
Another considerable case is the robots driven into an obstacle, but the user still commands motion in the blocked direction. The user-object spring is elongated and its potential energy empties the tank. The reduction of stiffness keeps the forces bounded even if the user does not change her/his commands. Conclusively the total wrench that the common object can exert on the environment is determined by the initial tank level and the spring stiffnesses. 





\chapter{Experimental evaluation}

Simulations of the proposed control schemes and existing approaches from literature are conducted to evaluate and compare their effectiveness. The controllers for cooperative manipulation are compared in terms of trajectory tracking, dynamic behaviour and internal stress on the object. To preserve comparability they are adjusted to exert equal strength of force and tuning parameters are kept within the same range.\\
In the simulation the robots we assume the robots to behave like simple inertias, i.e. their underlying dynamics is compensated. The connection between common object (another inertia) and the end-effectors is considered rigid. For the computation of the combined dynamics we apply the principle of constrained motion, explicitly given for a cooperative manipulation set-up in \cite{Erhart_16}. The same article provides the routine used for the calculation of the stress exerted on the object (internal wrench).
Simulations are conducted in \emph{MATLAB/Simulink}, using a fixed step solver with a step size of $1$ms, this facilitates application in an experimental set-up (the control units typically run at $1$kHz). Parameters used in the simulations can be found in table \ref{TAB:generalsimulationprop}. The control input is a  reference velocity, the set-point position/orientation is computed by integration. Fig. \ref{FIG:ReferenceTrajectory} shows the two test cases, linear (along the x-axis) and angular velocity (around the z-axis). 
\begin{table}[h]
	\centering
	\caption[General simulation settings]{General simulation settings}\vspace{10pt}
	\label{TAB:generalsimulationprop}
	
	\begin{tabular}{ l | l}
		\textbf{Number of manipulators} & \textbf{$4$}\\ \hline
		\textbf{Object inertia $M_b$} & $1.4$ kg $\cdot I_3$ (lin.), $0.2 \text{ kgm}^2 \cdot I_3$ (ang.)\\ \hline
		\textbf{Manipulator inertia $M_i$} & $10$ kg $\cdot I_3$ (lin.), $0.5 \text{ kgm}^2 \cdot I_3$ (ang.) \\ \hline
		\textbf{Object diameter} & $0.8$m \\ \hline
	\end{tabular}
\end{table}
\begin{figure}[h]
\centering
\input{RefTrajectory}
\caption{Test reference trajectories for translation (left) and rotation}
\label{FIG:ReferenceTrajectory}
\end{figure}


%Having explained the problem, and what others have done in similar situations, now explain your approach. Again, give a general overview of your design first, and then go into detail. The important part here is the concept of your work, not the actual implementation! Make sure that the document (particularly a thesis) is self-contained: It should be possible for a reader familiar with the general area to understand your design. Again, be forthright about the limitations of your design. Also, make sure you justify any shortcuts/limitations convincingly.

\section{State-of-the-art control schemes for cooperative manipulation}



%\begin{figure}
%\include{DePasrot}
%\caption[Internal force impedance control with feed-forward of the object dynamics: Rotation]{Internal force impedance control with feed-forward of the object dynamics: Rotation; Graphs from top: Orientation (desired/actual), Angular Velocity (desired/actual), Force exerted by one manipulator, Internal wrench}
%\end{figure}








\subsection{Internal and external impedance based reference trajectory generation}
A renowned approach by Caccavale and Villani \cite{Caccavale_01, Caccavale_08} consists of a cascaded architecture enforcing two impedance relations. One is established between the given reference trajectory and the object, we refer to an \emph{external} impedance. The other is between the manipulators and the object and is called \emph{internal}. The output of the impedance loops is a compliant reference trajectory which is used in an \emph{inner motion control} loop to generate forces to drive the robot. The parameters used in the simulation are chosen very close to the ones given in \cite{Caccavale_08}, see table \ref{TAB:CaViParameters}. 

\begin{table}[b]
	\centering
	\caption[Parameters for dual impedance controlled reference trajectory generation]{Parameters for dual impedance controlled reference trajectory generation}\vspace{10pt}
	\label{TAB:CaViParameters}
	
	\begin{tabular}{ l | l | l }
	 & linear & angular \\ \hline
	Ext. inertia & $0.7 \text{kg} \cdot I_3$ & $0.1 \text{kgm}^2 \cdot I_3$ \\ \hline
	Ext. damping	 & $1500 \text{kg/s} \cdot I_3$ & $10 \text{kgm}^2 \text{/s} \cdot I_3$ \\ \hline
	Ext. stiffness & $700 \text{N/m} \cdot I_3$ & $5 \text{Nm} \cdot  I_3$ \\ \hline
	Int. inertia & $10 \text{kg} \cdot I_3$ & $0.5 \text{kgm}^2 \cdot I_3$ \\ \hline
	Int. damping & $1000 \text{kg/s} \cdot I_3$ & $80 \text{kgm}^2 \text{/s} \cdot I_3 $ \\ \hline
	Int. stiffness & $400 \text{N/m} \cdot I_3$ & $2 \text{Nm} \cdot I_3$\\ \hline
\end{tabular}
\end{table}


%Caccavale and Villani \cite{Caccavale_01} combine both internal and external impedance control. With external we mean a compliant relation between object and (external) environment. The architecture is cascaded, consisting of a two level reference trajectory generation and a motion control loop below. On top-level an impedance relation between object and environment is used to generate a compliant trajectory subject to environmental forces:
%\begin{equation}
%\alpha M_o(\ddot{x}_o^d - \ddot{x}_o^r)  + D_o(\dot{x}_o^d - \dot{x}_o^r) + K_o(x_o^d,x_o^r)  = h_{env}
%\end{equation}
%The constant $ \alpha $ scales the object inertia proportionally to a desired value.
%The control output is the reference object acceleration $ \ddot{x}_o^r $, $ h_{env} $ is an input. This is sometimes called admittance control, admittance being the inverse of impedance. $ h_{env} $ has to be known, but is not easily measured in a practical set-up. Recalling (\ref{EQ:ObjectDynamics}) the environmental forces can be expressed as:
%\begin{equation}
%h_{env} =  M_o \ddot{x}_o^r + C_o \dot{x}_o^r + g_o - G^\dagger h
%\end{equation}
%Herein $ G^\dagger $ is a generalized inverse of the grasp matrix, selecting the motion inducing components from the measured contact wrench $ h $. $ \dot{x}_o^r, x_o^r $ are calculated from $ \ddot{x}_o^r $ by integration.
%From the compliant object trajectory ($ \ddot{x}_o^r,\dot{x}_o^r,x_o^r $) the desired trajectories of the manipulator ($ \ddot{x}_i^d,\dot{x}_i^d,x_i^d $) using the kinematic constraints. The reference manipulator trajectory, enforcing compliant behaviour between manipulators and object, is calculated from manipulator dynamics and internal forces: 
%\begin{equation}
%M_i(\ddot{x}_i^d - \ddot{x}_i^r) + D_i (\dot{x}_i^d - \dot{x}_i^r) + K_i(x_i^d,x_i^r) = VV^\dagger h
%\end{equation}
%The control output is the reference acceleration of the i-th manipulator $ \ddot{x}_i^r $, $ \dot{x}_i^r,x_i^r $ are obtained from integration. These variables are the inputs the inner motion control loop (PD-type). The strategy of compliant trajectories allows for high gains in the motion controller. Knowledge of object dynamics and measurement of the contact wrenches is required.\\

The simulation results are presented in figure \ref{FIG:CaViSim}, the left column shows the linear motion test case and the right the rotational one. The plots on top show the deviation from the desired position and orientation respectively. Below the velocity errors are displayed. The third plot row shows the wrenches applied by one of the manipulators. The bottom row indicates the internal stress a manipulator exerts on the object.\\
The approach shows good trajectory tracking, especially the velocity error is the lowest in this comparative study. The internal wrench is low and is similar to the other approaches, for linear motion not any internal stress occurs.

%\begin{figure}
%\include{CaVitrans}
%\caption[Internal and external impedance based reference trajectory generation: Translation]{Internal and external impedance based reference trajectory generation: Translation; Graphs from top: Position (desired/actual), Velocity (desired/actual), Force exerted by one manipulator, Internal wrench}
%\end{figure}


%\begin{figure}
%\include{CaVirot}
%\caption[Internal and external impedance based reference trajectory generation: Rotation]{Internal and external impedance based reference trajectory generation: Rotation; Graphs from top: Orientation (desired/actual), Angular Velocity (desired/actual), Force exerted by one manipulator, Internal wrench}
%\end{figure}


\begin{figure}[h]
\input{CaVigroup}
\label{FIG:CaViSim}
\caption[Simulation results: Internal and external impedance based reference trajectory generation]{Internal and external impedance based reference trajectory generation: Translation (left column) and rotation}
\end{figure}







\subsection{Internal impedance control with feed-forward of the object dynamics}
Erhart and Hirche \cite{Erhart_16} omit the external impedance relation and but include object dynamics feed-forward. I.e. the wrench necessary to accelerate the object's inertia is distributed by an inverse of the grasp matrix to the manipulators. This results in even better position/orientation accuracy compared to the previous. However results presented in \cite{Caccavale_08} indicate that, in absence of an external impedance relation, higher forces occur, if the object comes into contact with the environment.\\
Interestingly the magnitude of the internal forces (during rotation) depends directly on the step size of the simulation (running a fixed step solver), i.e. a ten-times smaller step size gives ten-times smaller internal forces. Internal forces are calculated based on the geometry in the last simulation step. The correlation between step size and values indicates that these forces are rather due to the discrete nature of the simulation than of the control law generating internal stress.\\
Table \ref{TAB:DePaParameters} shows the parameters used and the results can be seen from figure \ref{FIG:DePaSim}.
%\begin{equation}
%M_i \ddot{x}_i^d + D_i (\dot{x}_i^d - \dot{x}_i) + K_i(x_i^d,x_i) = h^x
%\end{equation}
%\textit{I know I have to use consistent notation and explain the variables, comes later ;)}
%This avoids the necessity of either measuring manipulator acceleration or contact force.
%Object dynamics is represented with a feed-forward term, mapped to the manipulators with a weighted pseudoinverse $ G^+ $ of the grasp matrix:
%\begin{equation}
%h^d = G^+ (M_o \ddot{x_o^d} + C_o \dot{x_o^d} + g_o)
%\end{equation}
%Note that this term is not an impedance relation and does not adjust if the environment hinders motion.
%The combined control law is $ h^\Sigma = h^x + h^d $.\\
%The set-up consists of four manipulators, distributed symmetrically around the object. In the first case translation in x-direction commanded. Results in Fig. \ref{FIG:abb1} show good tracking behaviour: no position errors in steady state and only small deviations from the desired values during transient phase. No internal stress is exerted on the object. Due to fast translation high manipulator forces occur.


%\begin{figure}
%\include{DePastrans}
%\caption[Internal force impedance control with feed-forward of the object dynamics: Translation]{Internal force impedance control with feed-forward of the object dynamics: Translation; Graphs from top: Position (desired/actual), Velocity (desired/actual), Force exerted by one manipulator, Internal wrench}
%\end{figure}
\begin{figure}[h]
\input{Depasgroup}
\label{FIG:DePaSim}
\caption[Simulation results: Internal impedance control with feed-forward of the object dynamics]{Internal impedance control with feed-forward of the object dynamics: Translation (left column) and rotation}
\end{figure}

\begin{table}
	\centering
	\caption[Parameters for the internal impedance control with object dynamics feed-forward]{Parameters for the internal impedance control with object dynamics feed-forward}\vspace{10pt}
	\label{TAB:DePaParameters}
	
	\begin{tabular}{ l | l | l }
	 & linear & angular \\ \hline
	Object inertia ff. & $1.4 \text{kg} \cdot I_3$ & $0.2 \text{kgm}^2 \cdot I_3$ \\ \hline
	Int. inertia & $10 \text{kg} \cdot I_3$ & $0.5 \text{kgm}^2 \cdot I_3$ \\ \hline
	Int. damping & $1000 \text{kg/s} \cdot I_3$ & $80 \text{kgm}^2 \text{/s} \cdot I_3 $ \\ \hline
	Int. stiffness & $400 \text{N/m} \cdot I_3$ & $2 \text{Nm} \cdot I_3$\\ \hline
\end{tabular}
\end{table}


\subsection{Intrinsically Passive Controller (IPC)}
The IPC was introduced by Stramigioli \cite{Stramigioli_01} and experimentally evaluated by Wimb\"ock et al. \cite{Wimboeck_08} on a robotic hand. In Stramigioli's version there are no dampers along the manipulator-object springs and Wimboeck uses only translational springs. The simulation results presented here are a combination of both implementations, we use dampers along 6-DoF springs. the architecture has been detailed throughout this work. The impedance parameters are chosen equal or lower for translation and significantly higher for rotation, see table \ref{TAB:IPCParameters}. The results (fig. \ref{FIG:IPCSim}) show a clearly inferior trajectory tracking compared to the previous approaches. This stems from a different mode of function of the inertias in the IPC. In classic impedance control clearly the inertia is in parallel with the spring and in the IPC the inertia is connected in series, figure \ref{FIG:ImpedanceIPC} illustrates the concepts. In the first case the inertia is used to calculate the wrench necessary to accelerate the associated body, in the latter the body spring and damper need to provide the wrench to accelerate the additional (virtual) body. Thus the inertia in the IPC is an energy storing element that reduces the controller dynamics. On the other hand the IPC does not require absolutely smooth reference velocities. The classic impedance control approaches use the time-derivative of the input velocity and often require pretreatment (e.g. low-pass filtering) of the input.\\
\begin{figure}[H]
	\centering
	\small
	\def\svgwidth{0.95\columnwidth}
	\input{ImpedanceIPC.eps_tex}
	\caption{Arrangement of spring, mass and damper in classical impedance control approaches and in the IPC }
	\label{FIG:ImpedanceIPC}
\end{figure}
The feasible stiffness and damping in this implementation is limited by numerical stability, a further increase leads to infinite values at some point of the simulation. This issue also requires the use of \emph{Simulink's ode8} solver for this approach, instead of \emph{ode1} (Euler's method) used for the other simulations. The \emph{ode8} method is of the \emph{Dormand-Prince} class with an accuracy order of $8$. The rate of rate of convergence improves at the cost of higher computational complexity \cite{SimulinkHelp:Solver}. 




\begin{table}
	\centering
	\caption[Parameters for the IPC]{Parameters for the IPC}\vspace{10pt}
	\label{TAB:IPCParameters}
	
	\begin{tabular}{ l | l | l }
	 & linear & angular \\ \hline
	Virt. inertia & $1.4 \text{kg} \cdot I_3$ & $0.2 \text{kgm}^2 \cdot I_3$ \\ \hline
	Ext. damping	 & $1500 \text{kg/s} \cdot I_3$ & $500 \text{kgm}^2 \text{/s} \cdot I_3$ \\ \hline
	Ext. stiffness & $700 \text{N/m} \cdot I_3$ & $400 \text{Nm} \cdot  I_3$ \\ \hline
	Int. damping & $625 \text{kg/s} \cdot I_3$ & $31.25 \text{kgm}^2 \text{/s} \cdot I_3 $ \\ \hline
	Int. stiffness & $125 \text{N/m} \cdot I_3$ & $6.25 \text{Nm} \cdot I_3$\\ \hline
\end{tabular}
\end{table}




%\begin{figure}[t]
%\include{StrIPCrot}
%\caption[IPC: Rotation]{Intrinsically Passive Controller: Rotation; Graphs from top: Orientation (desired/actual), Angular Velocity (desired/actual), Force exerted by one manipulator, Internal wrench}
%\end{figure}


\begin{figure}
\input{StrIPCgroup}
\label{FIG:IPCSim}
\caption[Simulation results: Intrinsically Passive Controller]{Intrinsically Passive Controller: Translation (left column) and rotation}
\end{figure}


\clearpage
\section{Simulation of the constrained dynamics IPC}
The implementation of the constrained dynamics IPC as proposed in section \ref{S:modelbasedcontrol} does not suffer from numerical issues as the classic IPC. This allows to increase the angular stiffness and damping and achieve a better dynamic performance for a angular motion. The simulation results are shown in figure \ref{FIG:DIPCcSim}. Note that including the inertias of the manipulators in the controller introduces further energy storing elements, i.e. makes the controller more inert. The better trajectory tracking (especially in angular motion) in comparison to the classic IPC results from the higher parameters, which are reported in table \ref{TAB:DIPCcParameters}. By choosing the controller manipulator inertia lower than in the robotic system the dynamic response can be improved. The angular velocity deviation is halved in comparison to the classic IPC, but still approximately $20$ times higher than in the impedance control approaches.\\
All controllers are tuned to command the same magnitude of force to the robots, the deviations in tracking behaviour result from different force gradients.
\begin{table}
	\centering
	\caption[Parameters for the constrained dynamic IPC]{Parameters for the constrained dynamic IPC}\vspace{10pt}
	\label{TAB:DIPCcParameters}
	
	\begin{tabular}{ l | l | l }
	 & linear & angular \\ \hline
	Virt. object inertia & $1.4 \text{kg} \cdot I_3$ & $0.2 \text{kgm}^2 \cdot I_3$ \\ \hline
	Virt. manipulator inertia & $0.5 \text{kg} \cdot I_3$ & $0.25 \text{kgm}^2 \cdot I_3$ \\ \hline 
	Ext. damping	 & $1500 \text{kg/s} \cdot I_3$ & $1500 \text{kgm}^2 \text{/s} \cdot I_3$ \\ \hline
	Ext. stiffness & $700 \text{N/m} \cdot I_3$ & $700 \text{Nm} \cdot  I_3$ \\ \hline
	Int. damping & $900 \text{kg/s} \cdot I_3$ & $45 \text{kgm}^2 \text{/s} \cdot I_3 $ \\ \hline
	Int. stiffness & $180 \text{N/m} \cdot I_3$ & $9 \text{Nm} \cdot I_3$\\ \hline
\end{tabular}
\end{table}
  
\begin{figure}
\input{DIPCcgroup}
\label{FIG:DIPCcSim}
\caption[Simulation results of the constrained dynamic IPC]{Constrained dynamic IPC: Translation (left column) and rotation}
\end{figure}

\section{Compliant trajectory generating IPC}
The compliant trajectory generating IPC uses an force control loop to compute the force commands for the robots. The structure can either be viewed as PI-control or as a spring and a damper in parallel. Gains or stiffness/damping can be chosen high because the superimposed control scheme already establishes compliance \cite{Caccavale_08}, the simulation settings are summarized in table \ref{TAB:DIPCrParameters}. Numerical stability problems also occur with this approach, the reported parameters   the maximum feasible with a fixed step solver (\emph{ode8}) at $1$ ms step size. With a variable step solver (e.g. \emph{ode45}) higher stiffness and damping are reachable and performance is superior. Due to non-applicability in real robotic system, these solvers are not considered further. Stiffness and Damping is similar to the classic IPC parameters, the dynamic performance is inferior because of the additional inertias, which have to be accelerated. This results in approx. double errors in position/orientation and velocity compared to the classic IPC, see figure \ref{FIG:DIPCrSim}, In contrast to the constrained dynamic IPC the virtual inertias for the object and the manipulators cannot be chosen smaller than their real pendants. Doing so leads to infinite simulation results. This entails in an even wider performance gap to the constrained dynamic IPC.

\begin{table}
	\centering
	\caption[Parameters for the compliant trajectory generating IPC]{Parameters for the compliant trajectory generating IPC}\vspace{10pt}
	\label{TAB:DIPCrParameters}
	
	\begin{tabular}{ l | l | l }
	 & linear & angular \\ \hline
	Virt. object inertia & $1.4 \text{kg} \cdot I_3$ & $0.2 \text{kgm}^2 \cdot I_3$ \\ \hline
	Virt. manipulator inertia & $10 \text{kg} \cdot I_3$ & $0.5 \text{kgm}^2 \cdot I_3$ \\ \hline 
	Ext. damping	 & $1500 \text{kg/s} \cdot I_3$ & $500 \text{kgm}^2 \text{/s} \cdot I_3$ \\ \hline
	Ext. stiffness & $700 \text{N/m} \cdot I_3$ & $400 \text{Nm} \cdot  I_3$ \\ \hline
	Int. damping & $600 \text{kg/s} \cdot I_3$ & $30 \text{kgm}^2 \text{/s} \cdot I_3 $ \\ \hline
	Int. stiffness & $120 \text{N/m} \cdot I_3$ & $6 \text{Nm} \cdot I_3$\\ \hline
	Force control damping & $5000 \text{kg/s} \cdot I_3$ & $1500 \text{kgm}^2 \text{/s} \cdot I_3 $ \\ \hline
	Force control stiffness & $500 \text{N/m} \cdot I_3$ & $200 \text{Nm} \cdot I_3$\\ \hline
\end{tabular}
\end{table}

\begin{figure}
\input{DIPCrgroup}
\label{FIG:DIPCrSim}
\caption[Simulation results of the compliant reference trajectory generating IPC]{Compliant reference trajectory generating IPC: Translation (left column) and rotation}
\end{figure}

\clearpage
\section{Energy-bounded trajectory tracking}
In the presented case trajectory tracking demands more energy than is available from the energy tank \ref{S:EnergyTanks}. The budget for performing operations is limited to $30$ J, trajectories exceeding this limit are adapted with a the variable stiffness and damping technique presented in subsection \ref{SS:EnergyAdaptedStiffness}. The underlying control scheme is the dynamic constrained IPC from section \ref{S:modelbasedcontrol}. In the simulation we assume that no energy is lost in the robotic system (due to friction or work on the environment). If the user commands acceleration, energy is transferred from the tank through the controller into the robotic system and is thereby stored in form of potential and energy. When the system slows down, the kinetic and potential energy is is re-transformed into free energy and stored in the tank. This happens in an ideal, loss way, thus the energy tank reaches the former level after an operation, see the third plot in figure \ref{FIG:VarStiff}. Upon depletion of the tank (approx. at $t=2$ s), the kinetic energy cannot be further increased  and the velocity stays constant (observable from the second plot). The reduction of stiffness and damping starts as soon as the level falls under a certain threshold, here $T_{th}=10$ J. As a consequence from $t=1.7$ s on the velocity increases slower. The actual position falls behind the desired (first plot in figure \ref{FIG:VarStiff}), with the reduced velocity it takes until $t=2.6$ s to catch up to the desired position. During this time the velocity is kept at the energetically feasible maximum. As soon as the velocity reduces the energy level recovers quickly. The approach attempts optimal position tracking under the given energy constraint and no permanent deviations occur after the energetic level has recovered.
\begin{figure}
\input{VarStifftrans}
\label{FIG:VarStiff}
\caption[Simulation results of the energy bounding by a variable stiffness spring]{Energy bounding by a variable stiffness spring and a variable damper}
\end{figure}

%\section{Implementation}
%
%
%In many (not all cases) there is a clear difference between the general approach (design) and its implementation in your particular circumstances. The design may be more general than what you can do given time and resources. Or you have developed a general design, and are now implementing a prototype on particular hardware. Give all required details. It should be possible to understand all this without referring to the source code. 
%
%This will, in general, include extracts of actual algorithms and hardware components used. Don't list pages of C code, an electronic copy of the source will accompany the submission and should be available to the marker, so there's no point in killing extra trees to put it into the report. Source code, if included at all, goes into the appendix and not the main document.
%
%Make sure you describe your implementation in enough detail. Someone who has nothing else but your thesis report to go by should be able to repeat your work, and arrive at essentially the same implementation. Reproducibility is an important component of scientific work. Also, clearly state the limitations of your implementation, and justify them.
%
%\section{Experimental Results}
%
%A thesis almost always has an experimental part, typically some comparison to other approaches. Benchmarking takes time, for running the experiments, but also for thinking them up in the first place, and for analysing the results. Plan accordingly to spend enough time here!
%
%Think about what makes sense to measure, what you want to learn from your measurements. Think about what is really the relevant contribution of your thesis, and how you can prove that you have achieved your goals. Think about what you can measure in order to get a good insight into the performance of various aspects of your design, how you can distinguish between systematic and accidental effects, how you can convince yourself that your results are right. If you get surprising results, don't just say "surprise, surprise, performance isn't as good as hoped". Find out why. Surprises without explanation indicate either that you are clueless about what's going on, or that you have made a mistake. Unconvincing results, therefore, tend to imply unconvincing marks. 
%
%\paragraph{Statistics:} Measurements always have statistical (sampling) errors. Owing to the deterministic nature of simulations these are sometimes very small, as disturbing factors can be designed. However, the reader should be given an indication of how statistically significant the results are. This is done by providing at least a standard deviation in addition to averages. Whenever the results of several runs are averaged, a standard deviation can (and must) be supplied. After all, you average to reduce statistical errors.
%
%The reproducibility argument applies here just as much as for the implementation. Give enough detail on what you measure, and how you measure it, so that someone who has your implementation (but not your test code) or has re-done your implementation independently, should be able to repeat your measurements and arrive at essentially the same results. In some cases, results seem outright wrong in a thesis. In those cases, not enough detail is provided to allow the supervisor/reader to pinpoint the likely source of the error. Often the cause is systematic errors resulting from an incorrect measurement technique. If it seems wrong, and the text doesn't convince the reader that it is not wrong, the reader will assume that it is wrong.
%
%\section{Discussion}
%
%Discuss and explain your results. Show how they support your thesis (or, if they don't, give a convincing explanation). It is important to separate objective facts clearly from their discussion (which is bound to contain subjective opinion). If the reader doesn't understand your results, reconsider if you have managed to extract the core information and explain it in a straightforward way.

%_______________________________________________



%_____Zusammenfassung, Ausblick_________________________________
\chapter{Conclusion}
  

%Don't leave it at the discussion: discuss what you/the reader can learn from the results. Draw some real conclusions. Separate discussion/interpretation of the results clearly from the conclusions you draw from them. (So-called "conclusion creep" tends to upset reviewers. It means surrendering your scientific objectivity.) Identify all shortcomings/limitations of your work, and discuss how they could be fixed ("future work"). It is not a sign of weakness of your work, if you clearly analyse and state the limitations. Informed readers will notice them anyway and draw their own conclusions, if not addressed properly.
%
%\vspace{\baselineskip}
%Recap: don't stick to this structure at all cost. Also, remember that the thesis must be:
%
%\begin{itemize}
%	\item honest, stating clearly all limitations;
%	\item self--contained, don't write just for the locals, don't assume that the reader has read the same literature as you, don't let the reader work out the details for themselves.
%\end{itemize}
%
%
%
%This chapter is followed by the list of figures and the bibliography. If you are using acronyms, listing them (with the expanded full name) before the bibliography is also a good idea. The acronyms package helps with consistency and an automatic listing.


%_______________________________________________________________


%_____Abbildungsverzeichnis_________________________________
\cleardoublepage
\addcontentsline{toc}{chapter}{List of Figures} 
\listoffigures 	 %Abbildungsverzeichnis

%___________________________________________________________

%_____Literaturverzeichnis_________________________________
\cleardoublepage
\addcontentsline{toc}{chapter}{Bibliography}
\bibliography{mybib}{}
\bibliographystyle{alphaurl}
%__________________________________________________________


%_____License_________________________________
\cleardoublepage
\chapter*{License}
\markright{LICENSE}
This work is licensed under the Creative Commons Attribution 3.0 Germany
License. To view a copy of this license,
visit \href{http://creativecommons.org/licenses/by/3.0/de/}{http://creativecommons.org} or send a letter
to Creative Commons, 171 Second Street, Suite 300, San
Francisco, California 94105, USA.
%__________________________________________________________

\end{document}
